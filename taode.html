<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tạo Đề Thi Văn Học - VANW</title>
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css">
    <style>
        @import url('https://unpkg.com/normalize.css') layer(normalize);

        @layer normalize, base, demo;

        @layer base {
            :root {
                --font-size-min: 16;
                --font-size-max: 20;
                --font-ratio-min: 1.2;
                --font-ratio-max: 1.33;
                --font-width-min: 375;
                --font-width-max: 1500;
                
                --bg-color: #f5f5f5;
                --card-bg: #ffffff;
                --card-outline: #b0b0b0;
                --text-primary: #000000;
                --text-secondary: #666666;
                --border-color: #c0c0c0;
                --button-bg: rgba(0, 0, 0, 0.08);
                --grid-color: #a0a0a0;
                --gradient: linear-gradient(135deg, #e37c2d, #f5a742, #f8c34d, #fad859);
                --primary-color: #e37c2d;
                --accent-color: #fad859;
                --shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
                --scrollbar-track: #f0f0f0;
                --scrollbar-thumb: #c0c0c0;
                --scrollbar-thumb-hover: #a0a0a0;
                --verification-color: #4CAF50;
                --verification-bg: rgba(76, 175, 80, 0.1);
            }

            html {
                color-scheme: light;
            }

            *,
            *:after,
            *:before {
                box-sizing: border-box;
            }

            ::-webkit-scrollbar {
                width: 10px;
                height: 10px;
            }

            ::-webkit-scrollbar-track {
                background: var(--scrollbar-track);
                border-radius: 5px;
                border: 1px solid var(--card-outline);
            }

            ::-webkit-scrollbar-thumb {
                background: var(--scrollbar-thumb);
                border-radius: 5px;
                border: 1px solid var(--card-outline);
            }

            ::-webkit-scrollbar-thumb:hover {
                background: var(--scrollbar-thumb-hover);
            }

            * {
                scrollbar-width: thin;
                scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
            }

            body {
                background: var(--bg-color);
                display: grid;
                place-items: center;
                min-height: 100vh;
                font-family: 'SF Pro Text', 'SF Pro Icons', 'AOS Icons', 'Helvetica Neue',
                    Helvetica, Arial, sans-serif, system-ui;
                line-height: 1.5;
                color: var(--text-primary);
                padding: 2rem;
                margin: 0;
            }

            body::before {
                --size: 45px;
                --line: var(--grid-color);
                content: '';
                height: 100vh;
                width: 100vw;
                position: fixed;
                background: linear-gradient(
                        90deg,
                        var(--line) 1px,
                        transparent 1px var(--size)
                    )
                    calc(var(--size) * 0.36) 50% / var(--size) var(--size),
                    linear-gradient(var(--line) 1px, transparent 1px var(--size)) 0%
                        calc(var(--size) * 0.32) / var(--size) var(--size);
                mask: linear-gradient(-20deg, transparent 50%, white);
                top: 0;
                transform-style: flat;
                pointer-events: none;
                z-index: -1;
                opacity: 0.8;
            }

            .web-icon {
                position: fixed;
                top: 1rem;
                left: 1rem;
                width: 48px;
                aspect-ratio: 1;
                display: grid;
                place-items: center;
                opacity: 0.8;
                transition: opacity 0.2s;
            }

            .web-icon:hover {
                opacity: 1;
                transform: scale(1.05);
            }

            .web-icon img {
                width: 100%;
                height: 100%;
                object-fit: contain;
            }

            .sr-only {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                white-space: nowrap;
                border-width: 0;
            }
            
            .mr-2 {
                margin-right: 0.5rem;
            }
            
            .text-red-500 {
                color: #ef4444;
            }
            
            .w-full {
                width: 100%;
            }
            
            .border {
                border: 1px solid var(--card-outline);
            }
            
            .rounded-lg {
                border-radius: 8px;
            }
            
            .p-2 {
                padding: 0.5rem;
            }
            
            .mt-1 {
                margin-top: 0.25rem;
            }
            
            .mt-3 {
                margin-top: 0.75rem;
            }
            
            .mb-2 {
                margin-bottom: 0.5rem;
            }
            
            .mb-3 {
                margin-bottom: 0.75rem;
            }
            
            .text-green-600 {
                color: var(--verification-color);
            }
            
            .font-semibold {
                font-weight: 600;
            }
            
            .text-center {
                text-align: center;
            }
        }

        @layer demo {
            body {
                align-content: center;
                gap: 2rem;
                margin: 0;
                padding: 2rem;
                min-height: 100vh;
                display: grid;
                place-items: center;
            }

            .app-container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 2rem;
                width: 100%;
                padding-top: 40px;
            }
            
            main {
                touch-action: none;
                padding-block: 2rem;
                width: 100%;
                display: flex;
                flex-direction: column;
                gap: 2rem;
                align-items: center;
            }
            
            .exam-tool {
                padding: 0 0;
                background-color: transparent;
                width: 100%;
            }
            
            .exam-card {
                background: var(--card-bg);
                border-radius: 20px;
                padding: 2.5rem;
                box-shadow: var(--shadow);
                transition: all 0.4s ease;
                margin-bottom: 2rem;
                width: 100%;
                max-width: 900px;
                margin: 0 auto;
                border: 2px solid var(--card-outline);
            }
            
            .header-image {
                text-align: center;
                margin-bottom: 1.5rem;
            }
            
            .header-image img {
                max-width: 65%;
                height: auto;
            }
            
            .input-area {
                margin-bottom: 2rem;
                position: relative;
            }
            
            textarea {
                width: 100%;
                min-height: 200px;
                padding: 1.5rem;
                border-radius: 12px;
                border: 2px solid var(--card-outline);
                background-color: var(--card-bg);
                color: var(--text-primary);
                font-size: 1rem;
                resize: vertical;
                transition: all 0.3s ease;
                font-family: inherit;
                line-height: 1.6;
                white-space: pre-wrap;
            }
            
            textarea:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(227, 124, 45, 0.2);
            }
            
            .word-count {
                position: absolute;
                bottom: 10px;
                right: 15px;
                font-size: 0.85rem;
                color: var(--text-secondary);
                background: rgba(255, 255, 255, 0.9);
                padding: 2px 8px;
                border-radius: 10px;
                border: 1px solid var(--card-outline);
            }
            
            .action-buttons {
                display: flex;
                gap: 1rem;
                margin-bottom: 2rem;
            }
            
            .generate-btn {
                flex: 2;
                background: var(--gradient);
                color: white;
                padding: 1rem 2rem;
                border: none;
                border-radius: 30px;
                font-size: 1.1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                position: relative;
                overflow: hidden;
                z-index: 1;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .generate-btn::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 0%;
                height: 100%;
                background: rgba(255, 255, 255, 0.2);
                transition: all 0.5s;
                z-index: -1;
            }
            
            .generate-btn:hover::before {
                width: 100%;
            }
            
            .generate-btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
                border-color: var(--accent-color);
            }
            
            .generate-btn:disabled {
                background: #ccc;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
                border-color: #999;
                opacity: 0.7;
            }
            
            .generate-btn:disabled:hover::before {
                width: 0%;
            }
            
            .random-btn {
                flex: 1;
                background: linear-gradient(135deg, #9C27B0, #7B1FA2);
                color: white;
                padding: 1rem 1.5rem;
                border: none;
                border-radius: 30px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                position: relative;
                overflow: hidden;
                z-index: 1;
            }
            
            .random-btn::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 0%;
                height: 100%;
                background: rgba(255, 255, 255, 0.2);
                transition: all 0.5s;
                z-index: -1;
            }
            
            .random-btn:hover::before {
                width: 100%;
            }
            
            .random-btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
                opacity: 0.95;
            }
            
            .random-btn:disabled {
                background: #ccc;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
                opacity: 0.7;
            }
            
            .settings-btn {
                flex: 0.5;
                background: var(--card-bg);
                color: var(--text-primary);
                padding: 1rem;
                border: 2px solid var(--card-outline);
                border-radius: 30px;
                font-size: 1.1rem;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .settings-btn:hover {
                background: rgba(227, 124, 45, 0.1);
                border-color: var(--primary-color);
            }
            
            .settings-panel {
                background: var(--card-bg);
                border-radius: 15px;
                padding: 1.5rem;
                margin-bottom: 2rem;
                display: none;
            }
            
            .settings-panel.active {
                display: block;
                animation: fadeIn 0.3s ease;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            .options-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 1.5rem;
            }
            
            .option-card {
                background: var(--card-bg);
                border-radius: 12px;
                padding: 1.5rem;
                box-shadow: var(--shadow);
                transition: all 0.3s ease;
                border-left: 5px solid var(--primary-color);
                border: 2px solid var(--card-outline);
            }
            
            .option-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
                border-color: var(--primary-color);
            }
            
            .option-card h3 {
                color: var(--primary-color);
                margin-bottom: 1rem;
                font-size: 1.2rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            
            .option-card h3 i {
                font-size: 1.1rem;
            }
            
            .duration-control {
                margin-top: 15px;
            }
            
            .duration-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .duration-control label {
                font-weight: 600;
                color: var(--text-primary);
                font-size: 1rem;
            }
            
            #examTimeValue {
                font-weight: bold;
                color: var(--primary-color);
                font-size: 1.1rem;
                margin-left: 5px;
            }
            
            .duration-buttons {
                display: flex;
                gap: 8px;
            }
            
            .duration-btn {
                padding: 6px 12px;
                background: var(--card-bg);
                border: 2px solid var(--card-outline);
                border-radius: 20px;
                color: var(--text-primary);
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.3s ease;
                font-weight: 500;
            }
            
            .duration-btn:hover {
                background: rgba(227, 124, 45, 0.1);
                border-color: var(--primary-color);
            }
            
            .duration-btn.active {
                background: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }
            
            #examTimeSlider {
                width: 100%;
                height: 10px;
                -webkit-appearance: none;
                appearance: none;
                background: linear-gradient(to right, var(--primary-color) 0%, var(--primary-color) 50%, var(--border-color) 50%, var(--border-color) 100%);
                border-radius: 5px;
                outline: none;
                margin-top: 10px;
            }
            
            #examTimeSlider::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 26px;
                height: 26px;
                border-radius: 50%;
                background: var(--primary-color);
                cursor: pointer;
                border: 3px solid white;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                transition: all 0.2s ease;
            }
            
            #examTimeSlider::-webkit-slider-thumb:hover {
                transform: scale(1.1);
                background: var(--accent-color);
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            }
            
            .toggle-container {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 1rem;
                padding: 8px 0;
                border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            }
            
            .toggle-container:last-child {
                border-bottom: none;
                margin-bottom: 0;
            }
            
            .toggle-label {
                font-weight: 500;
                color: var(--text-primary);
                font-size: 0.95rem;
                flex: 1;
            }
            
            .toggle-switch {
                position: relative;
                display: inline-block;
                width: 50px;
                height: 26px;
                flex-shrink: 0;
            }
            
            .toggle-switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }
            
            .toggle-slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #ccc;
                transition: .4s;
                border-radius: 34px;
                border: 2px solid #aaa;
            }
            
            .toggle-slider:before {
                position: absolute;
                content: "";
                height: 18px;
                width: 18px;
                left: 2px;
                bottom: 2px;
                background-color: white;
                transition: .4s;
                border-radius: 50%;
                border: 1px solid #ddd;
            }
            
            input:checked + .toggle-slider {
                background-color: var(--primary-color);
                border-color: var(--primary-color);
            }
            
            input:checked + .toggle-slider:before {
                transform: translateX(24px);
            }
            
            .select-container {
                margin-bottom: 1rem;
            }
            
            .block-label {
                display: block;
                font-size: 0.9rem;
                color: var(--text-secondary);
                margin-bottom: 0.5rem;
                font-weight: 500;
            }
            
            select {
                width: 100%;
                padding: 0.85rem;
                border-radius: 10px;
                border: 2px solid var(--card-outline);
                background-color: var(--card-bg);
                color: var(--text-primary);
                font-size: 1rem;
                transition: all 0.3s ease;
                font-family: inherit;
                cursor: pointer;
            }
            
            select:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(227, 124, 45, 0.2);
            }
            
            .progress-container {
                margin-top: 2rem;
                background-color: var(--card-bg);
                border-radius: 15px;
                padding: 1.8rem;
                box-shadow: var(--shadow);
                border: 2px solid var(--card-outline);
            }
            
            .progress-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1.2rem;
            }
            
            .progress-title {
                font-weight: 700;
                color: var(--primary-color);
                font-size: 1.3rem;
            }
            
            .progress-status {
                font-size: 1rem;
                color: var(--text-primary);
                font-weight: 500;
            }
            
            .progress-bar {
                height: 12px;
                background-color: #e0e0e0;
                border-radius: 6px;
                overflow: hidden;
                margin-bottom: 1.2rem;
                border: 2px solid #ccc;
            }
            
            .progress-fill {
                height: 100%;
                background: var(--gradient);
                border-radius: 6px;
                transition: width 0.4s ease;
            }
            
            .progress-items {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
                gap: 0.8rem;
                max-height: 220px;
                overflow-y: auto;
                padding-right: 10px;
            }
            
            .progress-item {
                display: flex;
                align-items: center;
                font-size: 1rem;
                color: var(--text-primary);
                padding: 8px 12px;
                border-radius: 8px;
                border: 2px solid transparent;
                background: rgba(0, 0, 0, 0.02);
                transition: all 0.3s ease;
            }
            
            .progress-item:hover {
                border-color: var(--card-outline);
                background: rgba(227, 124, 45, 0.05);
            }
            
            .progress-item i {
                margin-right: 10px;
                font-size: 1rem;
            }
            
            .progress-item.completed {
                color: var(--primary-color);
                border-color: rgba(227, 124, 45, 0.4);
                background-color: rgba(227, 124, 45, 0.08);
            }
            
            .progress-item.pending {
                color: #9ca3af;
                border-color: rgba(156, 163, 175, 0.3);
            }
            
            .progress-item.error {
                color: #ef4444;
                border-color: rgba(239, 68, 68, 0.4);
                background-color: rgba(239, 68, 68, 0.08);
            }
            
            .progress-item.verification {
                color: var(--verification-color);
                border-color: rgba(76, 175, 80, 0.4);
                background-color: var(--verification-bg);
                font-weight: 600;
                animation: pulse 2s infinite;
            }
            
            @keyframes pulse {
                0% {
                    box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4);
                }
                70% {
                    box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
                }
                100% {
                    box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
                }
            }
            
            .exam-result-container {
                margin-top: 2rem;
                background: var(--card-bg);
                border-radius: 15px;
                padding: 2rem;
                box-shadow: var(--shadow);
                border: 2px solid var(--card-outline);
            }
            
            .exam-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1.5rem;
                padding-bottom: 1rem;
                border-bottom: 2px solid var(--card-outline);
            }
            
            .exam-header h3 {
                color: var(--primary-color);
                font-size: 1.3rem;
                margin: 0;
            }
            
            .exam-code {
                background: rgba(227, 124, 45, 0.1);
                padding: 0.5rem 1rem;
                border-radius: 20px;
                font-weight: 600;
                color: var(--primary-color);
                border: 2px solid var(--primary-color);
            }
            
            .exam-info {
                background: rgba(227, 124, 45, 0.05);
                padding: 1rem;
                border-radius: 8px;
                margin-bottom: 1.5rem;
                border: 1px solid var(--card-outline);
            }
            
            .preview-exam {
                font-family: inherit;
            }
            
            .preview-exam .exam-title {
                text-align: center;
                color: var(--primary-color);
                font-size: 1.8rem;
                margin-bottom: 1rem;
                padding-bottom: 1rem;
                border-bottom: 3px solid var(--primary-color);
            }
            
            .preview-exam .exam-info {
                text-align: center;
                color: var(--text-secondary);
                margin-bottom: 2rem;
                font-size: 0.95rem;
            }
            
            .preview-exam .exam-section {
                margin-bottom: 2rem;
            }
            
            .preview-exam .section-title {
                color: var(--primary-color);
                font-size: 1.3rem;
                margin-bottom: 1rem;
                padding-bottom: 0.5rem;
                border-bottom: 2px solid rgba(227, 124, 45, 0.3);
            }
            
            .preview-exam .text-content {
                background: rgba(0, 0, 0, 0.02);
                padding: 1rem;
                border-radius: 8px;
                margin-bottom: 1.5rem;
                border-left: 4px solid var(--primary-color);
                line-height: 1.7;
                white-space: pre-line;
                font-family: 'Times New Roman', Times, serif;
            }
            
            .preview-exam .question-item {
                background: var(--card-bg);
                border: 2px solid var(--card-outline);
                border-radius: 8px;
                padding: 1.5rem;
                margin-bottom: 1rem;
            }
            
            .preview-exam .question-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 1rem;
            }
            
            .preview-exam .question-text {
                flex: 1;
                font-weight: 500;
                color: var(--text-primary);
                font-size: 1.05rem;
            }
            
            .preview-exam .question-points {
                background: var(--primary-color);
                color: white;
                padding: 0.25rem 0.75rem;
                border-radius: 20px;
                font-size: 0.9rem;
                font-weight: 600;
                margin-left: 1rem;
                flex-shrink: 0;
            }
            
            .preview-exam .answer-area {
                margin-top: 1rem;
            }
            
            .preview-exam .answer-textarea {
                width: 100%;
                min-height: 80px;
                padding: 0.75rem;
                border: 1px dashed var(--card-outline);
                border-radius: 6px;
                background: rgba(0, 0, 0, 0.02);
                color: var(--text-primary);
                font-family: inherit;
                font-size: 0.95rem;
                white-space: pre-wrap;
            }
            
            .exam-actions {
                display: flex;
                gap: 1rem;
                justify-content: center;
                margin-top: 2rem;
                flex-wrap: wrap;
            }
            
            .exam-action-btn {
                padding: 12px 24px;
                border-radius: 8px;
                border: none;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                min-width: 150px;
                justify-content: center;
            }
            
            .preview-btn {
                background: linear-gradient(135deg, #9C27B0, #7B1FA2);
                color: white;
            }
            
            .edit-btn {
                background: linear-gradient(135deg, #FF9800, #F57C00);
                color: white;
            }
            
            .save-btn {
                background: linear-gradient(135deg, #4CAF50, #45a049);
                color: white;
            }
            
            .reset-btn {
                background: linear-gradient(135deg, #FF5722, #E64A19);
                color: white;
            }
            
            .add-btn {
                background: linear-gradient(135deg, #2196F3, #1976D2);
                color: white;
            }
            
            .exam-action-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                opacity: 0.95;
            }
            
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                align-items: center;
                justify-content: center;
            }
            
            .modal.active {
                display: flex;
                animation: fadeIn 0.3s ease;
            }
            
            .modal-content {
                background: var(--card-bg);
                border-radius: 12px;
                width: 90%;
                max-width: 800px;
                max-height: 90vh;
                display: flex;
                flex-direction: column;
                border: 3px solid var(--primary-color);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            }
            
            .modal-content.large-modal {
                max-width: 1000px;
                max-height: 95vh;
            }
            
            .modal-header {
                padding: 1.5rem;
                border-bottom: 2px solid var(--card-outline);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .modal-header h3 {
                color: var(--primary-color);
                margin: 0;
                font-size: 1.3rem;
            }
            
            .close-modal {
                background: none;
                border: none;
                font-size: 1.5rem;
                color: var(--text-secondary);
                cursor: pointer;
                transition: color 0.2s;
            }
            
            .close-modal:hover {
                color: var(--primary-color);
            }
            
            .modal-body {
                padding: 1.5rem;
                overflow-y: auto;
                flex: 1;
            }
            
            .modal-footer {
                padding: 1.5rem;
                border-top: 2px solid var(--card-outline);
                display: flex;
                justify-content: flex-end;
                gap: 1rem;
            }
            
            .modal-btn {
                padding: 10px 20px;
                border-radius: 8px;
                border: none;
                font-size: 1rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
            }
            
            .modal-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }
            
            .secondary-btn {
                background: var(--card-bg);
                border: 2px solid var(--card-outline);
                color: var(--text-primary);
            }
            
            .secondary-btn:hover {
                border-color: var(--primary-color);
                background: rgba(227, 124, 45, 0.1);
            }
            
            .exam-editor-container {
                max-width: 100%;
            }
            
            .editor-actions {
                display: flex;
                gap: 1rem;
                margin-bottom: 1.5rem;
                flex-wrap: wrap;
            }
            
            .editor-action-btn {
                padding: 10px 20px;
                background: var(--card-bg);
                border: 2px solid var(--card-outline);
                border-radius: 8px;
                color: var(--text-primary);
                font-size: 0.95rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .editor-action-btn:hover {
                background: rgba(227, 124, 45, 0.1);
                border-color: var(--primary-color);
            }
            
            .rich-text-editor {
                border: 2px solid var(--card-outline);
                border-radius: 8px;
                overflow: hidden;
                margin-bottom: 1rem;
            }
            
            .rich-text-editor .ql-toolbar {
                border-bottom: 2px solid var(--card-outline);
                background: rgba(227, 124, 45, 0.05);
            }
            
            .rich-text-editor .ql-container {
                font-family: inherit;
                font-size: 1rem;
                min-height: 200px;
                max-height: 300px;
                overflow-y: auto;
            }
            
            .rich-text-editor .ql-editor {
                min-height: 200px;
                white-space: pre-wrap;
            }
            
            .text-preview {
                font-family: inherit;
                line-height: 1.8;
                color: var(--text-primary);
            }
            
            .text-preview h3 {
                color: var(--primary-color);
                margin-bottom: 1rem;
                padding-bottom: 0.5rem;
                border-bottom: 2px solid var(--primary-color);
            }
            
            .text-preview .text-content {
                background: rgba(0, 0, 0, 0.02);
                padding: 1.5rem;
                border-radius: 8px;
                border-left: 4px solid var(--primary-color);
                max-height: 400px;
                overflow-y: auto;
                margin-bottom: 1rem;
                white-space: pre-line;
                line-height: 1.7;
                font-family: 'Times New Roman', Times, serif;
            }
            
            .text-preview .text-meta {
                display: flex;
                flex-wrap: wrap;
                gap: 1rem;
                margin-top: 1rem;
                padding: 1rem;
                background: rgba(227, 124, 45, 0.05);
                border-radius: 8px;
                font-size: 0.9rem;
                color: var(--text-secondary);
            }
            
            .text-preview .meta-item {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            
            .app-footer {
                text-align: center;
                margin-top: 3rem;
                padding-top: 2rem;
                border-top: 2px solid var(--border-color);
                color: var(--text-secondary);
            }
            
            .app-footer a {
                color: var(--primary-color);
                text-decoration: none;
                font-weight: 600;
                transition: all 0.3s ease;
            }
            
            .app-footer a:hover {
                text-decoration: underline;
                color: var(--accent-color);
            }
            
            .markdown-content {
                font-family: inherit;
                line-height: 1.6;
            }
            
            .markdown-content h1 {
                color: var(--primary-color);
                font-size: 1.8rem;
                margin: 1.5rem 0 1rem;
                padding-bottom: 0.5rem;
                border-bottom: 3px solid var(--primary-color);
            }
            
            .markdown-content h2 {
                color: var(--primary-color);
                font-size: 1.5rem;
                margin: 1.2rem 0 0.8rem;
                padding-left: 0.5rem;
                border-left: 3px solid var(--primary-color);
            }
            
            .markdown-content h3 {
                color: var(--accent-color);
                font-size: 1.3rem;
                margin: 1rem 0 0.6rem;
            }
            
            .markdown-content p {
                margin-bottom: 1rem;
            }
            
            .markdown-content strong {
                color: var(--primary-color);
                font-weight: 700;
            }
            
            .markdown-content em {
                color: var(--text-secondary);
                font-style: italic;
            }
            
            .markdown-content ul, .markdown-content ol {
                margin-left: 1.5rem;
                margin-bottom: 1rem;
            }
            
            .markdown-content li {
                margin-bottom: 0.5rem;
            }
            
            .markdown-content blockquote {
                border-left: 4px solid var(--accent-color);
                margin: 1rem 0;
                padding: 0.5rem 1rem;
                background: rgba(250, 216, 89, 0.1);
                font-style: italic;
            }
            
            @media (max-width: 992px) {
                .options-grid {
                    grid-template-columns: 1fr;
                }
            }
            
            @media (max-width: 768px) {
                body {
                    padding: 1rem;
                }
                
                .exam-card {
                    padding: 1.8rem;
                }
                
                .action-buttons {
                    flex-direction: column;
                }
                
                .generate-btn, .random-btn, .settings-btn {
                    width: 100%;
                }
                
                .app-container {
                    padding: 1rem;
                    padding-top: 20px;
                }
                
                main {
                    gap: 1.5rem;
                    padding-block: 1rem;
                }
                
                .duration-header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 15px;
                }
                
                .duration-buttons {
                    width: 100%;
                    justify-content: space-between;
                }
                
                .duration-btn {
                    flex: 1;
                    text-align: center;
                }
                
                .exam-header {
                    flex-direction: column;
                    gap: 1rem;
                    text-align: center;
                }
                
                .exam-actions {
                    flex-direction: column;
                    align-items: stretch;
                }
                
                .exam-action-btn {
                    min-width: 100%;
                }
                
                .modal-content {
                    width: 95%;
                    margin: 0.5rem;
                }
                
                .modal-content.large-modal {
                    width: 98%;
                    max-height: 90vh;
                }
                
                .editor-actions {
                    flex-direction: column;
                }
                
                .editor-action-btn {
                    width: 100%;
                    justify-content: center;
                }
                
                .app-footer {
                    margin-top: 2rem;
                    padding-top: 1.5rem;
                }
                
                .app-footer p {
                    font-size: 0.9rem;
                }
            }
            
            @media (max-width: 480px) {
                body {
                    padding: 0.5rem;
                }
                
                .app-container {
                    padding: 0.5rem;
                    padding-top: 15px;
                }
                
                .progress-items {
                    grid-template-columns: 1fr;
                }
                
                .header-image img {
                    max-width: 100%;
                }
                
                .modal-content {
                    width: 95%;
                    margin: 0.5rem;
                }
            }
            
            @media (min-width: 1200px) {
                .exam-card {
                    max-width: 1000px;
                }
            }
        }
    </style>
</head>
<body>
    <a aria-label="Website Icon" class="web-icon" href="index.html" rel="noreferrer noopener">
        <img src="logo.png" alt="Website Icon" />
    </a>
    
    <div class="app-container">
        <main>
            <div class="exam-tool">
                <div class="exam-card">
                    <div class="header-image">
                        <img src="htext1.png" alt="HỆ THỐNG TẠO BÀI THI VĂN HỌC">
                    </div>
                    
                    <div class="input-area" id="existingTextArea">
                        <textarea id="inputText" placeholder="Nhập hoặc dán nội dung văn bản văn học cần tạo đề thi... (Tối thiểu 20 từ)"></textarea>
                        <div class="word-count" id="wordCount">0 từ</div>
                    </div>
                    
                    <div class="action-buttons">
                        <button id="generateExamBtn" class="generate-btn">
                            <i class="fas fa-file-alt mr-2"></i> Tạo Đề Thi Từ Văn Bản
                        </button>
                        <button id="generateRandomExamBtn" class="random-btn">
                            <i class="fas fa-dice mr-2"></i> Tạo Đề Thi Ngẫu Nhiên
                        </button>
                        <button id="settingsBtn" class="settings-btn">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                    
                    <div class="settings-panel" id="settingsPanel">
                        <div class="options-grid">
                            <div class="option-card">
                                <h3><i class="fas fa-clock"></i> Thời gian làm bài</h3>
                                <div class="duration-control">
                                    <div class="duration-header">
                                        <label for="examTimeSlider">Thời gian: <span id="examTimeValue">90 phút</span></label>
                                        <div class="duration-buttons">
                                            <button type="button" class="duration-btn" data-value="45">45p</button>
                                            <button type="button" class="duration-btn" data-value="90">90p</button>
                                            <button type="button" class="duration-btn" data-value="120">120p</button>
                                        </div>
                                    </div>
                                    <input type="range" id="examTimeSlider" min="30" max="180" step="15" value="90">
                                </div>
                            </div>
                            
                            <div class="option-card">
                                <h3><i class="fas fa-sliders-h"></i> Cài đặt đề thi</h3>
                                <div class="select-container">
                                    <label class="block-label">Độ khó</label>
                                    <select id="difficulty">
                                        <option value="easy">Dễ</option>
                                        <option value="medium" selected>Trung bình</option>
                                        <option value="hard">Khó</option>
                                    </select>
                                </div>
                                <div class="select-container mt-3">
                                    <label class="block-label">Khối lớp</label>
                                    <select id="grade">
                                        <option value="10">Lớp 10</option>
                                        <option value="11">Lớp 11</option>
                                        <option value="12" selected>Lớp 12</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="option-card">
                                <h3><i class="fas fa-plus-circle"></i> Cấu trúc đề thi</h3>
                                <div class="toggle-container">
                                    <span class="toggle-label">Phần đọc hiểu</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="readingToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-container">
                                    <span class="toggle-label">Phần nghị luận văn học</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="essayToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-container">
                                    <span class="toggle-label">Phần liên hệ thực tế</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="practiceToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="mt-3">
                                    <label class="block-label">Số câu hỏi</label>
                                    <input type="number" id="questionCount" min="3" max="10" value="5" class="w-full border border-gray-300 rounded-lg p-2 mt-1">
                                </div>
                            </div>
                            
                            <div class="option-card">
                                <h3><i class="fas fa-random"></i> Tạo đề thi ngẫu nhiên</h3>
                                <div class="select-container">
                                    <label class="block-label">Chọn tác giả</label>
                                    <select id="randomAuthor">
                                        <option value="random" selected>Tác giả ngẫu nhiên</option>
                                        <option value="xuan_dieu">Xuân Diệu</option>
                                        <option value="nam_cao">Nam Cao</option>
                                        <option value="thach_lam">Thạch Lam</option>
                                        <option value="to_hoai">Tô Hoài</option>
                                        <option value="nguyen_tuan">Nguyễn Tuân</option>
                                        <option value="nguyen_khuyen">Nguyễn Khuyến</option>
                                        <option value="ho_xuan_huong">Hồ Xuân Hương</option>
                                        <option value="nguyen_du">Nguyễn Du</option>
                                        <option value="han_mac_tu">Hàn Mặc Tử</option>
                                        <option value="xuan_quynh">Xuân Quỳnh</option>
                                    </select>
                                </div>
                                <div class="select-container mt-3">
                                    <label class="block-label">Thể loại ưu tiên</label>
                                    <select id="randomGenre">
                                        <option value="any" selected>Bất kỳ thể loại</option>
                                        <option value="tho">Thơ</option>
                                        <option value="truyen">Truyện ngắn</option>
                                        <option value="tieu_thuyet">Tiểu thuyết</option>
                                        <option value="ky">Ký</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="option-card">
                                <h3><i class="fas fa-sticky-note"></i> Ghi chú cho đề thi</h3>
                                <textarea id="examNotes" placeholder="Nhập ghi chú cho đề thi... (Ví dụ: Phân bổ thời gian, trọng tâm kiến thức, tiêu chí chấm điểm...)" rows="5"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="progress-container" id="progressContainer" style="display: none;">
                        <div class="progress-header">
                            <div class="progress-title">Đang tạo đề thi</div>
                            <div class="progress-status" id="progressStatus">Đang xử lý...</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                        <div class="progress-items" id="progressItems">
                        </div>
                    </div>
                    
                    <div class="exam-result-container" id="examResult" style="display: none;">
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="app-footer">
            <p>Được tạo bởi <a href="https://www.facebook.com/hoangminhtuan.hmtuan" target="_blank">Hoàng Minh Tuấn</a> và <a href="https://www.facebook.com/chuong.truong.130409" target="_blank">Trương Viết Duy Chương</a></p>
        </footer>
    </div>

    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-alt mr-2"></i> XEM TRƯỚC ĐỀ THI</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="previewContent">
            </div>
            <div class="modal-footer">
                <button class="modal-btn" id="printPreviewBtn">
                    <i class="fas fa-print mr-2"></i> In đề thi
                </button>
                <button class="modal-btn secondary-btn" id="closePreviewBtn">
                    <i class="fas fa-times mr-2"></i> Đóng
                </button>
            </div>
        </div>
    </div>

    <div id="editExamModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h3><i class="fas fa-edit mr-2"></i> CHỈNH SỬA ĐỀ THI</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="exam-editor-container" id="examEditorContainer">
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" id="saveEditedExamBtn">
                    <i class="fas fa-save mr-2"></i> Lưu thay đổi
                </button>
                <button class="modal-btn secondary-btn" id="cancelEditBtn">
                    <i class="fas fa-times mr-2"></i> Hủy
                </button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
    <script>
       const REVERSED_API_KEY = "AIzaSyDM-Z4WqZ1lQVy-r_uj7q04Zfr9kJlvHDA";
const GEMINI_API_KEY = CHATBOT_REVERSED_API_KEY.split('').reverse().join('');


        const firebaseConfigPrimary = {
            apiKey: "AIzaSyBLZpLQKl0x-kMez2v5NURU5qSthT_6qYI",
            authDomain: "loginnn-b1dc0.firebaseapp.com",
            projectId: "loginnn-b1dc0",
            storageBucket: "loginnn-b1dc0.firebasestorage.app",
            messagingSenderId: "481800915428",
            appId: "1:481800915428:web:b524925c25efb53e7b9ff1",
            measurementId: "G-XF2ZBFBCR7"
        };

        const firebaseConfigSecondary = {
            apiKey: "AIzaSyCVD_Um0fWAK3ogQQUwCDINV_dN1hJZxL4",
            authDomain: "tkc-vanw.firebaseapp.com",
            projectId: "tkc-vanw",
            storageBucket: "tkc-vanw.firebasestorage.app",
            messagingSenderId: "862465503494",
            appId: "1:862465503494:web:8aec558b363988deec6e87",
            measurementId: "G-F23NN1KLW0"
        };

        let firestoreDbPrimary = null;
        let firestoreDbSecondary = null;
        
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfigPrimary, "primary");
                console.log("Firebase Primary initialized successfully");
            }
            
            try {
                firebase.initializeApp(firebaseConfigSecondary, "secondary");
                console.log("Firebase Secondary initialized successfully");
            } catch (e) {
                console.log("Secondary app already exists or error:", e.message);
            }
            
            firestoreDbPrimary = firebase.app("primary").firestore();
            firestoreDbSecondary = firebase.app("secondary").firestore();
            
            [firestoreDbPrimary, firestoreDbSecondary].forEach(db => {
                db.settings({
                    ignoreUndefinedProperties: true
                });
            });
            
            console.log("Both Firestore databases initialized successfully");
            
        } catch (error) {
            console.warn("Firebase initialization warning:", error.message);
            const fakeDb = {
                collection: () => ({
                    doc: () => ({
                        set: () => Promise.resolve(),
                        get: () => Promise.resolve({ 
                            exists: false, 
                            data: () => null 
                        }),
                        delete: () => Promise.resolve()
                    })
                }),
                enableNetwork: () => Promise.resolve()
            };
            
            firestoreDbPrimary = fakeDb;
            firestoreDbSecondary = fakeDb;
        }

        let generationProgress = {
            total: 0,
            completed: 0,
            items: []
        };

        let currentExamBlocks = [];
        let currentExamCode = '';
        let examSettings = {
            time: 90,
            difficulty: 'medium',
            grade: '12',
            hasReading: true,
            hasEssay: true,
            hasPractice: false,
            questionCount: 5
        };

        let richTextEditors = [];
        let currentRealWorkInfo = null;

        window.addEventListener('error', function(e) {
            if (e.error && e.error.message && e.error.message.includes('asynchronous response')) {
                console.warn('Browser extension conflict detected. You may disable extensions if issues persist.');
            }
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.warn('Unhandled promise rejection:', e.reason);
        });

        function countWords(text) {
            return text.trim().split(/\s+/).filter(word => word.length > 0).length;
        }

        function updateProgress() {
            const progressFill = document.getElementById('progressFill');
            const progressStatus = document.getElementById('progressStatus');
            const progressItems = document.getElementById('progressItems');
            
            const percent = generationProgress.total > 0 ? 
                Math.round((generationProgress.completed / generationProgress.total) * 100) : 0;
            
            progressFill.style.width = `${percent}%`;
            
            if (percent === 100) {
                progressStatus.textContent = 'Hoàn thành!';
            } else {
                progressStatus.textContent = `Đang xử lý... ${percent}%`;
            }
            
            progressItems.innerHTML = generationProgress.items.map(item => {
                let iconClass = 'fas fa-clock';
                let statusClass = 'pending';
                
                if (item.status === 'completed') {
                    iconClass = 'fas fa-check-circle';
                    statusClass = 'completed';
                } else if (item.status === 'error') {
                    iconClass = 'fas fa-exclamation-circle';
                    statusClass = 'error';
                } else if (item.status === 'verification') {
                    iconClass = 'fas fa-check-double';
                    statusClass = 'verification';
                }
                
                return `
                    <div class="progress-item ${statusClass}">
                        <i class="${iconClass}"></i>
                        ${item.name}
                    </div>
                `;
            }).join('');
        }

        function addProgressItem(name, type = 'normal') {
            generationProgress.items.push({
                name: name,
                status: 'pending',
                type: type
            });
            generationProgress.total++;
            updateProgress();
        }

        function completeProgressItem(index) {
            generationProgress.items[index].status = 'completed';
            generationProgress.completed++;
            updateProgress();
        }

        function markAsVerification(index) {
            generationProgress.items[index].status = 'verification';
            updateProgress();
        }

        function errorProgressItem(index) {
            generationProgress.items[index].status = 'error';
            generationProgress.completed++;
            updateProgress();
        }

        function formatDuration(minutes) {
            if (minutes < 60) {
                return `${minutes} phút`;
            } else {
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                return remainingMinutes > 0 ? 
                    `${hours} giờ ${remainingMinutes} phút` : 
                    `${hours} giờ`;
            }
        }

        async function fetchGemini(prompt, maxRetries = 3) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('Request timeout after 90 seconds')), 90000);
                    });
                    
                    const fetchPromise = fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [{ 
                                parts: [{ text: prompt }] 
                            }],
                            generationConfig: {
                                maxOutputTokens: 8000,
                                temperature: 0.7,
                                topP: 0.95,
                                topK: 40,
                            }
                        })
                    });
                    
                    const response = await Promise.race([fetchPromise, timeoutPromise]);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (!data.candidates || !data.candidates[0] || !data.candidates[0].content || !data.candidates[0].content.parts || !data.candidates[0].content.parts[0]) {
                        throw new Error('Invalid response format from API');
                    }
                    
                    const result = data.candidates[0].content.parts[0].text.trim();
                    
                    if (result.includes('\\n')) {
                        result = result.replace(/\\n/g, '\n');
                    }
                    
                    return result;
                    
                } catch (error) {
                    console.error(`Attempt ${attempt} failed:`, error);
                    
                    if (attempt === maxRetries) {
                        throw new Error(`Failed after ${maxRetries} attempts: ${error.message}`);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 2000 * attempt));
                }
            }
        }

        function markdownToHtml(text) {
            if (!text) return '';
            
            let html = text;
            
            const lines = html.split('\n');
            html = '';
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (line.trim() === '') {
                    html += '<br>';
                } else if (line.startsWith('<') && line.endsWith('>')) {
                    html += line;
                } else {
                    let processedLine = line;
                    
                    processedLine = processedLine.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    
                    processedLine = processedLine.replace(/\*(.*?)\*/g, '<em>$1</em>');
                    
                    processedLine = processedLine.replace(/__(.*?)__/g, '<u>$1</u>');
                    
                    html += processedLine;
                }
                
                if (i < lines.length - 1) {
                    html += '<br>';
                }
            }
            
            return html;
        }

        async function generateExamWithGemini(text, workInfo = null) {
            let workContext = '';
            if (workInfo) {
                workContext = `
                THÔNG TIN TÁC PHẨM:
                - Tác phẩm: ${workInfo.title || 'Không xác định'}
                - Tác giả: ${workInfo.author || 'Không xác định'}
                - Thể loại: ${workInfo.genre || 'Không xác định'}
                `;
            }
            
            const prompt = `
                Tạo một đề thi Ngữ Văn CHỈ DỰA TRÊN TÁC PHẨM VĂN HỌC CÓ THẬT.
                
                ${workContext}
                
                VĂN BẢN TÁC PHẨM (giữ nguyên định dạng xuống dòng, đặc biệt với thơ):
                ${text}
                
                THÔNG TIN ĐỀ THI:
                - Thời gian: ${examSettings.time} phút
                - Độ khó: ${examSettings.difficulty}
                - Khối lớp: ${examSettings.grade}
                - Số câu hỏi: ${examSettings.questionCount}
                - Phần đọc hiểu: ${examSettings.hasReading ? 'CÓ' : 'KHÔNG'}
                - Phần nghị luận: ${examSettings.hasEssay ? 'CÓ' : 'KHÔNG'}
                - Phần liên hệ thực tế: ${examSettings.hasPractice ? 'CÓ' : 'KHÔNG'}
                
                YÊU CẦU QUAN TRỌNG:
                1. CHỈ sử dụng tác phẩm văn học có thật trong chương trình học
                2. Giữ nguyên định dạng xuống dòng của văn bản, đặc biệt với THƠ
                3. Tạo đề thi phù hợp với chương trình giáo dục Việt Nam
                4. Đảm bảo tính chính xác của thông tin tác phẩm
                
                Định dạng trả về JSON:
                {
                    "title": "Tiêu đề đề thi",
                    "description": "Mô tả ngắn về đề thi",
                    "workInfo": {
                        "title": "Tên tác phẩm",
                        "author": "Tác giả",
                        "genre": "Thể loại"
                    },
                    "blocks": [
                        {
                            "type": "text",
                            "title": "Phần I: ĐỌC HIỂU",
                            "content": "Đoạn văn bản cho phần đọc hiểu...",
                            "points": 0
                        },
                        {
                            "type": "question",
                            "title": "Câu hỏi 1",
                            "content": "Nêu nội dung chính của đoạn văn trên?",
                            "points": 1.0
                        }
                    ]
                }
                
                LƯU Ý: Giữ nguyên \n cho xuống dòng trong nội dung văn bản!
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            maxOutputTokens: 8000,
                            temperature: 0.7,
                            topP: 0.95,
                            topK: 40,
                        }
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error?.message || 'Lỗi từ API');
                }

                const resultText = data.candidates[0].content.parts[0].text;
                
                const jsonMatch = resultText.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const examData = JSON.parse(jsonMatch[0]);
                    
                    if (!examData.workInfo && workInfo) {
                        examData.workInfo = workInfo;
                    }
                    
                    return examData;
                } else {
                    return {
                        title: "ĐỀ THI NGỮ VĂN",
                        description: "Đề thi được tạo từ tác phẩm văn học có thật",
                        workInfo: workInfo || {
                            title: "Tác phẩm văn học",
                            author: "Tác giả",
                            genre: "Văn học"
                        },
                        blocks: [
                            {
                                type: "text",
                                title: "Phần I: ĐỌC HIỂU",
                                content: text.substring(0, 500),
                                points: 0
                            },
                            {
                                type: "question",
                                title: "Câu hỏi 1",
                                content: "**Nêu nội dung chính** của đoạn văn trên?",
                                points: 1.0
                            }
                        ]
                    };
                }
            } catch (error) {
                throw new Error('Lỗi kết nối với Gemini API: ' + error.message);
            }
        }

        async function generateRandomTextSample() {
            const author = document.getElementById('randomAuthor').value;
            const genre = document.getElementById('randomGenre').value;
            
            let prompt = '';
            
            if (author !== 'random') {
                const authorMap = {
                    'xuan_dieu': 'Xuân Diệu',
                    'nam_cao': 'Nam Cao',
                    'thach_lam': 'Thạch Lam',
                    'to_hoai': 'Tô Hoài',
                    'nguyen_tuan': 'Nguyễn Tuân',
                    'nguyen_khuyen': 'Nguyễn Khuyến',
                    'ho_xuan_huong': 'Hồ Xuân Hương',
                    'nguyen_du': 'Nguyễn Du',
                    'han_mac_tu': 'Hàn Mặc Tử',
                    'xuan_quynh': 'Xuân Quỳnh'
                };
                
                const authorName = authorMap[author] || 'Tác giả';
                const genreName = genre === 'any' ? '' : `thuộc thể loại ${genre}`;
                
                prompt = `
                    Hãy cung cấp một đoạn trích từ TÁC PHẨM VĂN HỌC CÓ THẬT trong chương trình Ngữ Văn Việt Nam của tác giả ${authorName} ${genreName}.
                    
                    YÊU CẦU QUAN TRỌNG:
                    1. PHẢI là tác phẩm có thật, không tự sáng tác
                    2. Ghi rõ: Tên tác phẩm, tác giả, thể loại
                    3. Chọn đoạn trích tiêu biểu, có giá trị văn học
                    4. Giữ nguyên định dạng gốc (xuống dòng cho thơ, đoạn văn cho văn xuôi)
                    5. Độ dài khoảng 300-500 từ
                    6. Phù hợp làm đề thi học sinh
                    
                    Định dạng trả về:
                    TÁC PHẨM: [Tên tác phẩm]
                    TÁC GIẢ: ${authorName}
                    THỂ LOẠI: [Thể loại]
                    
                    [Nội dung đoạn trích]
                    
                    Lưu ý: KHÔNG thêm bình luận hay giải thích gì thêm
                `;
            } else {
                const genreMap = {
                    'any': 'văn học',
                    'tho': 'thơ',
                    'truyen': 'truyện ngắn',
                    'tieu_thuyet': 'tiểu thuyết',
                    'ky': 'ký'
                };
                
                const genreName = genreMap[genre] || 'văn học';
                
                prompt = `
                    Hãy cung cấp một đoạn trích từ TÁC PHẨM VĂN HỌC CÓ THẬT trong chương trình Ngữ Văn Việt Nam thuộc thể loại ${genreName}.
                    
                    YÊU CẦU QUAN TRỌNG:
                    1. PHẢI là tác phẩm có thật, không tự sáng tác
                    2. Ghi rõ: Tên tác phẩm, tác giả, thể loại
                    3. Chọn đoạn trích tiêu biểu, có giá trị văn học
                    4. Giữ nguyên định dạng gốc (xuống dòng cho thơ, đoạn văn cho văn xuôi)
                    5. Độ dài khoảng 300-500 từ
                    6. Phù hợp làm đề thi học sinh
                    
                    Định dạng trả về:
                    TÁC PHẨM: [Tên tác phẩm]
                    TÁC GIẢ: [Tên tác giả]
                    THỂ LOẠI: [Thể loại]
                    
                    [Nội dung đoạn trích]
                    
                    Lưu ý: KHÔNG thêm bình luận hay giải thích gì thêm
                `;
            }
            
            try {
                addProgressItem('Đang tải tác phẩm ngẫu nhiên...');
                
                const result = await fetchGemini(prompt);
                completeProgressItem(0);
                
                const lines = result.split('\n');
                const workInfo = {
                    title: '',
                    author: '',
                    genre: '',
                    content: ''
                };
                
                let contentStarted = false;
                let contentLines = [];
                
                for (const line of lines) {
                    if (line.startsWith('TÁC PHẨM:')) {
                        workInfo.title = line.replace('TÁC PHẨM:', '').trim();
                    } else if (line.startsWith('TÁC GIẢ:')) {
                        workInfo.author = line.replace('TÁC GIẢ:', '').trim();
                    } else if (line.startsWith('THỂ LOẠI:')) {
                        workInfo.genre = line.replace('THỂ LOẠI:', '').trim();
                    } else if (line.trim() === '' && workInfo.title && !contentStarted) {
                        contentStarted = true;
                    } else if (contentStarted) {
                        contentLines.push(line);
                    }
                }
                
                workInfo.content = contentLines.join('\n').trim();
                
                if (!workInfo.title) workInfo.title = "Tác phẩm văn học";
                if (!workInfo.author) workInfo.author = "Tác giả";
                if (!workInfo.genre) workInfo.genre = "Văn học";
                
                currentRealWorkInfo = workInfo;
                
                return workInfo.content;
            } catch (error) {
                console.error('Lỗi khi tạo văn bản ngẫu nhiên:', error);
                errorProgressItem(0);
                
                currentRealWorkInfo = {
                    title: "Chí Phèo",
                    author: "Nam Cao",
                    genre: "Truyện ngắn",
                    content: "Hắn vừa đi vừa chửi. Bao giờ cũng thế, cứ rượu xong là hắn chửi. Bắt đầu hắn chửi trời. Có hề gì? Trời có của riêng nhà nào? Rồi hắn chửi đời. Thế cũng chẳng sao: đời là tất cả nhưng chẳng là ai..."
                };
                
                return currentRealWorkInfo.content;
            }
        }

        async function generateRandomExam() {
            const generateRandomBtn = document.getElementById('generateRandomExamBtn');
            const progressContainer = document.getElementById('progressContainer');
            const examResult = document.getElementById('examResult');

            generateRandomBtn.disabled = true;
            generateRandomBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang tạo đề thi ngẫu nhiên...';
            progressContainer.style.display = 'block';
            examResult.style.display = 'none';
            
            generationProgress = {
                total: 0,
                completed: 0,
                items: []
            };
            
            examResult.innerHTML = '';

            try {
                examSettings = {
                    time: parseInt(document.getElementById('examTimeSlider').value),
                    difficulty: document.getElementById('difficulty').value,
                    grade: document.getElementById('grade').value,
                    hasReading: document.getElementById('readingToggle').checked,
                    hasEssay: document.getElementById('essayToggle').checked,
                    hasPractice: document.getElementById('practiceToggle').checked,
                    questionCount: parseInt(document.getElementById('questionCount').value)
                };
                
                const examNotes = document.getElementById('examNotes').value;

                addProgressItem('Đang chọn tác phẩm ngẫu nhiên');
                addProgressItem('Thực hiện tự kiểm chứng tác phẩm', 'verification');
                addProgressItem('Tạo câu hỏi đề thi');
                addProgressItem('Hoàn thiện cấu trúc đề');

                const randomText = await generateRandomTextSample();
                completeProgressItem(0);

                markAsVerification(1);
                await new Promise(resolve => setTimeout(resolve, 1000));
                completeProgressItem(1);

                const examData = await generateExamWithGemini(randomText, currentRealWorkInfo);
                completeProgressItem(2);

                showExamResult(examData, examNotes);
                completeProgressItem(3);

                examResult.style.display = 'block';
                showNotification('Tạo đề thi ngẫu nhiên thành công từ tác phẩm thật!', 'success');

            } catch (error) {
                console.error('Lỗi khi tạo đề thi ngẫu nhiên:', error);
                
                let errorMessage = 'Đã xảy ra lỗi khi tạo đề thi ngẫu nhiên. ';
                if (error.message.includes('timeout')) {
                    errorMessage += 'Yêu cầu mất quá nhiều thời gian. Vui lòng thử lại.';
                } else if (error.message.includes('Failed after')) {
                    errorMessage += 'Không thể kết nối đến AI. Vui lòng kiểm tra kết nối internet và thử lại.';
                } else {
                    errorMessage += error.message;
                }
                
                examResult.innerHTML = `
                    <div class="exam-info" style="background: rgba(239, 68, 68, 0.1); border-color: #ef4444;">
                        <h3 style="color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> Lỗi khi tạo đề thi ngẫu nhiên</h3>
                        <p>${errorMessage}</p>
                        <p><strong>Gợi ý:</strong></p>
                        <ul>
                            <li>Kiểm tra kết nối internet</li>
                            <li>Thử lại với tác giả khác</li>
                            <li>Thử lại sau vài phút</li>
                        </ul>
                    </div>
                `;
                
                examResult.style.display = 'block';
                showNotification(errorMessage, 'error');
                
                if (generationProgress.items.length > 0) {
                    const lastIndex = generationProgress.items.length - 1;
                    errorProgressItem(lastIndex);
                }
            } finally {
                generateRandomBtn.disabled = false;
                generateRandomBtn.innerHTML = '<i class="fas fa-dice mr-2"></i> Tạo Đề Thi Ngẫu Nhiên';
            }
        }

        async function generateExam() {
            const text = document.getElementById('inputText').value.trim();
            
            if (!text) {
                showNotification('Vui lòng nhập nội dung văn bản!', 'error');
                return;
            }
            
            const wordCount = countWords(text);
            if (wordCount < 20) {
                showNotification(`Văn bản quá ngắn (${wordCount} từ)! Vui lòng nhập ít nhất 20 từ.`, 'error');
                return;
            }
            
            const generateBtn = document.getElementById('generateExamBtn');
            const progressContainer = document.getElementById('progressContainer');
            const examResult = document.getElementById('examResult');

            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang tạo đề thi...';
            progressContainer.style.display = 'block';
            examResult.style.display = 'none';
            
            generationProgress = {
                total: 0,
                completed: 0,
                items: []
            };
            
            examResult.innerHTML = '';

            try {
                examSettings = {
                    time: parseInt(document.getElementById('examTimeSlider').value),
                    difficulty: document.getElementById('difficulty').value,
                    grade: document.getElementById('grade').value,
                    hasReading: document.getElementById('readingToggle').checked,
                    hasEssay: document.getElementById('essayToggle').checked,
                    hasPractice: document.getElementById('practiceToggle').checked,
                    questionCount: parseInt(document.getElementById('questionCount').value)
                };
                
                const examNotes = document.getElementById('examNotes').value;

                addProgressItem('Phân tích văn bản');
                addProgressItem('Thực hiện tự kiểm chứng tác phẩm', 'verification');
                addProgressItem('Tạo câu hỏi đề thi');
                addProgressItem('Hoàn thiện cấu trúc đề');

                const textTypeResponse = await fetchGemini(
                    `Xác định thể loại chính xác của văn bản sau (chỉ trả về 1-3 từ): "${text.substring(0, 800)}"`
                );
                completeProgressItem(0);

                markAsVerification(1);
                
                let workInfo = currentRealWorkInfo;
                
                if (!workInfo) {
                    const verificationPrompt = `
                        Văn bản sau có phải là tác phẩm văn học có thật trong chương trình Ngữ Văn Việt Nam không?
                        Trả lời ngắn gọn: CÓ hoặc KHÔNG
                        
                        Văn bản: "${text.substring(0, 500)}"
                    `;
                    
                    try {
                        const verificationResult = await fetchGemini(verificationPrompt);
                        if (verificationResult.includes('CÓ') || verificationResult.includes('có')) {
                            workInfo = {
                                title: "Tác phẩm văn học",
                                author: "Tác giả",
                                genre: textTypeResponse.trim()
                            };
                        }
                    } catch (e) {
                        console.warn("Không thể kiểm chứng tác phẩm:", e);
                    }
                }
                
                completeProgressItem(1);

                const examData = await generateExamWithGemini(text, workInfo);
                completeProgressItem(2);

                showExamResult(examData, examNotes);
                completeProgressItem(3);

                examResult.style.display = 'block';
                showNotification('Tạo đề thi thành công từ tác phẩm thật!', 'success');

            } catch (error) {
                console.error('Lỗi khi tạo đề thi:', error);
                
                let errorMessage = 'Đã xảy ra lỗi khi tạo đề thi. ';
                if (error.message.includes('timeout')) {
                    errorMessage += 'Yêu cầu mất quá nhiều thời gian. Vui lòng thử lại với văn bản ngắn hơn.';
                } else if (error.message.includes('Failed after')) {
                    errorMessage += 'Không thể kết nối đến AI. Vui lòng kiểm tra kết nối internet và thử lại.';
                } else {
                    errorMessage += error.message;
                }
                
                examResult.innerHTML = `
                    <div class="exam-info" style="background: rgba(239, 68, 68, 0.1); border-color: #ef4444;">
                        <h3 style="color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> Lỗi khi tạo đề thi</h3>
                        <p>${errorMessage}</p>
                        <p><strong>Gợi ý:</strong></p>
                        <ul>
                            <li>Kiểm tra kết nối internet</li>
                            <li>Thử lại với văn bản ngắn hơn</li>
                            <li>Đảm bảo văn bản có ít nhất 20 từ</li>
                            <li>Thử lại sau vài phút</li>
                        </ul>
                    </div>
                `;
                
                examResult.style.display = 'block';
                showNotification(errorMessage, 'error');
                
                if (generationProgress.items.length > 0) {
                    const lastIndex = generationProgress.items.length - 1;
                    errorProgressItem(lastIndex);
                }
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-file-alt mr-2"></i> Tạo Đề Thi Từ Văn Bản';
            }
        }

        function showExamResult(examData, examNotes) {
            currentExamBlocks = examData.blocks || [];
            currentExamCode = generateExamCode();
            
            currentExamBlocks.forEach(block => {
                if (block.content && typeof block.content === 'string') {
                    block.content = block.content.replace(/\\n/g, '\n');
                }
            });
            
            let examNotesHTML = '';
            if (examNotes.trim()) {
                examNotesHTML = `
                    <div style="background: rgba(227, 124, 45, 0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--primary-color);">
                        <h4 style="margin: 0 0 0.5rem 0; color: var(--primary-color);">
                            <i class="fas fa-sticky-note"></i> Ghi chú đề thi
                        </h4>
                        <p style="margin: 0; line-height: 1.6; white-space: pre-wrap;">${examNotes}</p>
                    </div>
                `;
            }
            
            let workInfoHTML = '';
            if (examData.workInfo) {
                workInfoHTML = `
                    <div style="background: rgba(76, 175, 80, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #4CAF50;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #2E7D32;">
                            <i class="fas fa-book"></i> THÔNG TIN TÁC PHẨM
                        </h4>
                        <p style="margin: 0; line-height: 1.6;">
                            <strong>Tác phẩm:</strong> ${examData.workInfo.title || 'Không xác định'}<br>
                            <strong>Tác giả:</strong> ${examData.workInfo.author || 'Không xác định'}<br>
                            <strong>Thể loại:</strong> ${examData.workInfo.genre || 'Văn học'}
                        </p>
                    </div>
                `;
            }
            
            let previewHTML = `
                <div class="exam-header">
                    <h3><i class="fas fa-file-alt mr-2"></i> ${examData.title || 'ĐỀ THI NGỮ VĂN'}</h3>
                    <div class="exam-code">
                        Mã đề: <span id="examCodeSpan">${currentExamCode}</span>
                    </div>
                </div>
                
                <div class="exam-info">
                    <p><strong>Thời gian:</strong> ${examSettings.time} phút | <strong>Độ khó:</strong> ${examSettings.difficulty === 'easy' ? 'Dễ' : examSettings.difficulty === 'medium' ? 'Trung bình' : 'Khó'} | <strong>Khối lớp:</strong> ${examSettings.grade}</p>
                    <p>${examData.description || 'Đề thi được tạo từ tác phẩm văn học có thật'}</p>
                </div>
                
                ${workInfoHTML}
                ${examNotesHTML}
                
                <div class="preview-exam">
            `;
            
            let questionCounter = 1;
            let totalPoints = 0;
            
            currentExamBlocks.forEach((block, index) => {
                if (block.type === 'text') {
                    previewHTML += `
                        <div class="exam-section">
                            <h3 class="section-title">${block.title || 'Phần văn bản'}</h3>
                            <div class="text-content markdown-content" style="white-space: pre-wrap; font-family: 'Times New Roman', Times, serif;">${markdownToHtml(block.content)}</div>
                        </div>
                    `;
                } else if (block.type === 'question') {
                    totalPoints += block.points || 0;
                    previewHTML += `
                        <div class="question-item">
                            <div class="question-header">
                                <div class="question-text markdown-content"><strong>Câu ${questionCounter}:</strong> ${markdownToHtml(block.content)}</div>
                                <div class="question-points">${block.points || 1.0} điểm</div>
                            </div>
                            <div class="answer-area">
                                <textarea class="answer-textarea" placeholder="Thí sinh viết câu trả lời vào đây..." rows="4" style="white-space: pre-wrap;"></textarea>
                            </div>
                        </div>
                    `;
                    questionCounter++;
                }
            });
            
            previewHTML += `
                <div class="exam-info" style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid var(--card-outline);">
                    <p><strong>Tổng điểm: ${totalPoints.toFixed(1)} điểm</strong></p>
                    <p><em>--- Hết đề thi ---</em></p>
                </div>
            `;
            
            previewHTML += `</div>`;
            
            const examActions = `
                <div class="exam-actions">
                    <button id="previewExamBtn" class="exam-action-btn preview-btn">
                        <i class="fas fa-eye mr-2"></i> Xem trước
                    </button>
                    <button id="editExamBtn" class="exam-action-btn edit-btn">
                        <i class="fas fa-edit mr-2"></i> Chỉnh sửa
                    </button>
                    <button id="saveExamBtn" class="exam-action-btn save-btn">
                        <i class="fas fa-save mr-2"></i> Lưu đề thi
                    </button>
                    <button id="printExamBtn" class="exam-action-btn print-btn">
                        <i class="fas fa-print mr-2"></i> In đề thi
                    </button>
                    <button id="saveExamToDatabase" class="exam-action-btn" style="background: linear-gradient(135deg, #FF9800, #F57C00);">
                        <i class="fas fa-database mr-2"></i> Lưu vào Database
                    </button>
                    <button id="testDbBtn" class="exam-action-btn" style="background: linear-gradient(135deg, #9E9E9E, #757575);">
                        <i class="fas fa-plug mr-2"></i> Kiểm tra DB
                    </button>
                </div>
            `;
            
            document.getElementById('examResult').innerHTML = previewHTML + examActions;
            
            document.getElementById('previewExamBtn')?.addEventListener('click', updateExamPreview);
            document.getElementById('editExamBtn')?.addEventListener('click', openExamEditor);
            document.getElementById('saveExamBtn')?.addEventListener('click', saveExam);
            document.getElementById('printExamBtn')?.addEventListener('click', printExam);
            document.getElementById('saveExamToDatabase')?.addEventListener('click', saveExamToDatabase);
            document.getElementById('testDbBtn')?.addEventListener('click', testDatabaseConnection);
        }

        function generateExamCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        async function testDatabaseConnection() {
            showNotification('Đang kiểm tra kết nối cả 2 database...', 'info');
            
            try {
                if (firestoreDbPrimary) {
                    const testRef1 = firestoreDbPrimary.collection('_connection_tests').doc('test_' + Date.now());
                    await testRef1.set({
                        test: true,
                        timestamp: new Date().toISOString(),
                        db: 'primary'
                    });
                    showNotification('✅ Database chính kết nối OK', 'success');
                    
                    setTimeout(() => {
                        testRef1.delete().catch(() => {});
                    }, 5000);
                }
                
                if (firestoreDbSecondary) {
                    const testRef2 = firestoreDbSecondary.collection('_connection_tests').doc('test_' + Date.now());
                    await testRef2.set({
                        test: true,
                        timestamp: new Date().toISOString(),
                        db: 'secondary'
                    });
                    showNotification('✅ Database phụ kết nối OK', 'success');
                    
                    setTimeout(() => {
                        testRef2.delete().catch(() => {});
                    }, 5000);
                }
                
            } catch (error) {
                console.error('Database test error:', error);
                showNotification(`❌ Lỗi kết nối: ${error.message}`, 'error');
            }
        }

        async function saveExamToDatabase() {
            try {
                updateExamFromEditor();
                
                const examNotes = document.getElementById('examNotes').value;
                
                const totalPoints = currentExamBlocks.reduce((sum, block) => sum + (block.points || 0), 0);
                
                const examData = {
                    examId: currentExamCode,
                    title: "Đề thi Ngữ Văn",
                    literaryText: document.getElementById('inputText').value.substring(0, 500),
                    examTime: examSettings.time,
                    difficulty: examSettings.difficulty,
                    grade: examSettings.grade,
                    notes: examNotes,
                    blocks: JSON.parse(JSON.stringify(currentExamBlocks)),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    totalPoints: totalPoints,
                    source: "VANW Exam Tool",
                    status: "active",
                    isRealWork: !!currentRealWorkInfo,
                    workInfo: currentRealWorkInfo || null
                };
                
                showNotification('Đang lưu đề thi vào cả 2 database...', 'info');
                
                const savePromises = [];
                
                if (firestoreDbPrimary) {
                    savePromises.push(
                        firestoreDbPrimary.collection('exams').doc(currentExamCode)
                            .set(examData, { merge: true })
                    );
                }
                
                if (firestoreDbSecondary) {
                    savePromises.push(
                        firestoreDbSecondary.collection('vanw_exams').doc(currentExamCode)
                            .set(examData, { merge: true })
                    );
                }
                
                await Promise.all(savePromises);
                
                const savedDoc1 = firestoreDbPrimary ? 
                    await firestoreDbPrimary.collection('exams').doc(currentExamCode).get() : 
                    { exists: false };
                
                const savedDoc2 = firestoreDbSecondary ? 
                    await firestoreDbSecondary.collection('vanw_exams').doc(currentExamCode).get() : 
                    { exists: false };
                
                if (savedDoc1.exists || savedDoc2.exists) {
                    showNotification(`✅ Đã lưu đề thi thành công vào ${savedDoc1.exists && savedDoc2.exists ? 'cả 2 database' : savedDoc1.exists ? 'database chính' : 'database phụ'}! Mã đề: ${currentExamCode}`, 'success');
                    
                    const link = `${window.location.origin}/take_exam.html?code=${currentExamCode}`;
                    
                    setTimeout(() => {
                        navigator.clipboard.writeText(link).then(() => {
                            showNotification(`📋 Link đề thi đã được sao chép vào clipboard!`, 'info');
                        }).catch(() => {
                            showNotification(`📝 Link đề thi: ${link}`, 'info');
                        });
                    }, 1000);
                    
                    const backupExams = JSON.parse(localStorage.getItem('vanw_exams_backup') || '{}');
                    backupExams[currentExamCode] = {
                        ...examData,
                        localBackup: true,
                        backupDate: new Date().toISOString()
                    };
                    localStorage.setItem('vanw_exams_backup', JSON.stringify(backupExams));
                    
                } else {
                    throw new Error('Không thể xác nhận dữ liệu đã được lưu');
                }
                
            } catch (error) {
                console.error('Lỗi khi lưu đề thi vào database:', error);
                
                try {
                    const localExams = JSON.parse(localStorage.getItem('vanw_exams_local') || '{}');
                    localExams[currentExamCode] = {
                        examId: currentExamCode,
                        title: "Đề thi Ngữ Văn",
                        blocks: currentExamBlocks,
                        examTime: examSettings.time,
                        difficulty: examSettings.difficulty,
                        grade: examSettings.grade,
                        isRealWork: !!currentRealWorkInfo,
                        workInfo: currentRealWorkInfo,
                        savedAt: new Date().toISOString(),
                        reason: "Firestore failed, saved locally"
                    };
                    localStorage.setItem('vanw_exams_local', JSON.stringify(localExams));
                    
                    showNotification(`⚠️ Lưu vào database thất bại. Đã lưu vào localStorage (Mã: ${currentExamCode})`, 'warning');
                } catch (localError) {
                    showNotification(`❌ Lỗi: ${error.message} - Không thể lưu cả vào localStorage`, 'error');
                }
            }
        }

        function openExamEditor() {
            const modal = document.getElementById('editExamModal');
            const editorContainer = document.getElementById('examEditorContainer');
            
            editorContainer.innerHTML = createExamEditorHTML();
            
            setTimeout(() => {
                initRichTextEditors();
            }, 100);
            
            modal.classList.add('active');
        }

        function createExamEditorHTML() {
            let editorHTML = `
                <div class="exam-editor-container">
                    <div class="editor-actions">
                        <button id="addTextBlockBtn" class="editor-action-btn">
                            <i class="fas fa-paragraph mr-2"></i> Thêm phần văn bản
                        </button>
                        <button id="addQuestionBlockBtn" class="editor-action-btn">
                            <i class="fas fa-question-circle mr-2"></i> Thêm câu hỏi
                        </button>
                        <button id="reorderBlocksBtn" class="editor-action-btn">
                            <i class="fas fa-sort mr-2"></i> Sắp xếp lại
                        </button>
                    </div>
                    
                    <div class="exam-blocks-container" id="examBlocksContainer">
            `;
            
            currentExamBlocks.forEach((block, index) => {
                editorHTML += createBlockEditorHTML(block, index);
            });
            
            editorHTML += `
                    </div>
                    
                    <div class="exam-actions">
                        <button id="previewEditedExamBtn" class="exam-action-btn preview-btn">
                            <i class="fas fa-eye mr-2"></i> Xem trước
                        </button>
                        <button id="saveEditedExamBtn" class="exam-action-btn save-btn">
                            <i class="fas fa-save mr-2"></i> Lưu thay đổi
                        </button>
                    </div>
                </div>
            `;
            
            return editorHTML;
        }

        function createBlockEditorHTML(block, index) {
            let content = block.content || '';
            content = content.replace(/<br>/g, '\n');
            
            return `
                <div class="exam-block-editor" data-index="${index}" style="margin-bottom: 1.5rem; border: 2px solid var(--card-outline); border-radius: 8px; padding: 1rem;">
                    <div class="block-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <select class="block-type-select" data-index="${index}" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--card-outline);">
                            <option value="text" ${block.type === 'text' ? 'selected' : ''}>Phần văn bản</option>
                            <option value="question" ${block.type === 'question' ? 'selected' : ''}>Câu hỏi</option>
                        </select>
                        
                        <div class="block-actions">
                            <button class="block-btn move-up" data-index="${index}" ${index === 0 ? 'disabled' : ''} style="padding: 0.25rem 0.5rem; margin-left: 0.25rem; border: 1px solid var(--card-outline); border-radius: 4px; background: var(--card-bg); cursor: pointer;">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button class="block-btn move-down" data-index="${index}" ${index === currentExamBlocks.length - 1 ? 'disabled' : ''} style="padding: 0.25rem 0.5rem; margin-left: 0.25rem; border: 1px solid var(--card-outline); border-radius: 4px; background: var(--card-bg); cursor: pointer;">
                                <i class="fas fa-arrow-down"></i>
                            </button>
                            <button class="block-btn delete" data-index="${index}" style="padding: 0.25rem 0.5rem; margin-left: 0.25rem; border: 1px solid #ef4444; border-radius: 4px; background: #fef2f2; color: #ef4444; cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="block-content">
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label class="block-label">Tiêu đề:</label>
                            <input type="text" class="block-title" data-index="${index}" value="${block.title || ''}" placeholder="Nhập tiêu đề..." style="width: 100%; padding: 0.5rem; border: 1px solid var(--card-outline); border-radius: 4px;">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label class="block-label">Nội dung:</label>
                            <div class="rich-text-editor" id="editor-${index}"></div>
                            <textarea style="display: none;" id="editor-text-${index}">${content}</textarea>
                        </div>
                        
                        ${block.type === 'question' ? `
                        <div class="block-controls">
                            <div class="form-group">
                                <label class="block-label">Điểm số:</label>
                                <input type="number" class="block-points-input" data-index="${index}" value="${block.points || 1.0}" min="0" max="10" step="0.5" style="width: 100px; padding: 0.5rem; border: 1px solid var(--card-outline); border-radius: 4px;">
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function initRichTextEditors() {
            richTextEditors = [];
            
            currentExamBlocks.forEach((block, index) => {
                const editorId = `editor-${index}`;
                const textareaId = `editor-text-${index}`;
                
                const quill = new Quill(`#${editorId}`, {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            ['bold', 'italic', 'underline'],
                            [{ 'header': 1 }, { 'header': 2 }],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['clean']
                        ]
                    },
                    placeholder: 'Nhập nội dung...'
                });
                
                const textarea = document.getElementById(textareaId);
                if (textarea) {
                    quill.root.innerHTML = markdownToHtml(textarea.value);
                }
                
                richTextEditors[index] = {
                    quill: quill,
                    textareaId: textareaId
                };
                
                quill.on('text-change', function() {
                    if (textarea) {
                        textarea.value = quill.root.innerHTML;
                    }
                });
            });
        }

        function updateExamFromEditor() {
            const blocksContainer = document.getElementById('examBlocksContainer');
            
            if (!blocksContainer) {
                console.log('Trình chỉnh sửa không mở, bỏ qua cập nhật từ editor');
                return;
            }
            
            const blockElements = blocksContainer.querySelectorAll('.exam-block-editor');
            
            const updatedBlocks = [];
            
            const blockArray = Array.from(blockElements);
            
            blockArray.forEach((blockElement, blockIndex) => {
                const dataIndex = parseInt(blockElement.dataset.index);
                const typeSelect = blockElement.querySelector('.block-type-select');
                const titleInput = blockElement.querySelector('.block-title');
                const pointsInput = blockElement.querySelector('.block-points-input');
                
                let content = '';
                if (richTextEditors[dataIndex]) {
                    const quill = richTextEditors[dataIndex].quill;
                    content = quill.root.innerHTML;
                } else {
                    const textarea = document.getElementById(`editor-text-${dataIndex}`);
                    content = textarea ? textarea.value : '';
                }
                
                const blockData = {
                    type: typeSelect.value,
                    title: titleInput.value,
                    content: content,
                    points: typeSelect.value === 'question' ? parseFloat(pointsInput?.value || 1.0) : 0
                };
                
                updatedBlocks.push(blockData);
            });
            
            currentExamBlocks = updatedBlocks;
        }

        function reorderBlocks() {
            showNotification('Kéo và thả các block để sắp xếp lại', 'info');
            
            updateExamFromEditor();
            
            const modal = document.getElementById('editExamModal');
            modal.classList.remove('active');
            
            setTimeout(() => {
                openExamEditor();
            }, 300);
        }

        function addBlock(type) {
            const newBlock = {
                type: type,
                title: type === 'text' ? 'Phần mới' : 'Câu hỏi mới',
                content: '',
                points: type === 'question' ? 1.0 : 0
            };
            
            currentExamBlocks.push(newBlock);
            
            const blocksContainer = document.getElementById('examBlocksContainer');
            blocksContainer.insertAdjacentHTML('beforeend', createBlockEditorHTML(newBlock, currentExamBlocks.length - 1));
            
            initRichTextEditors();
        }

        function deleteBlock(index) {
            if (currentExamBlocks.length <= 1) {
                showNotification('Đề thi phải có ít nhất một phần!', 'error');
                return;
            }
            
            currentExamBlocks.splice(index, 1);
            
            const editorContainer = document.getElementById('examEditorContainer');
            editorContainer.innerHTML = createExamEditorHTML();
            
            setTimeout(() => {
                initRichTextEditors();
            }, 100);
        }

        function moveBlock(index, direction) {
            if (direction === 'up' && index > 0) {
                [currentExamBlocks[index], currentExamBlocks[index - 1]] = [currentExamBlocks[index - 1], currentExamBlocks[index]];
            } else if (direction === 'down' && index < currentExamBlocks.length - 1) {
                [currentExamBlocks[index], currentExamBlocks[index + 1]] = [currentExamBlocks[index + 1], currentExamBlocks[index]];
            }
            
            const editorContainer = document.getElementById('examEditorContainer');
            editorContainer.innerHTML = createExamEditorHTML();
            
            setTimeout(() => {
                initRichTextEditors();
            }, 100);
        }

        function saveEditedExam() {
            updateExamFromEditor();
            
            const modal = document.getElementById('editExamModal');
            modal.classList.remove('active');
            
            const examData = {
                title: "Đề thi Ngữ Văn",
                description: "Đề thi đã được chỉnh sửa",
                workInfo: currentRealWorkInfo,
                blocks: currentExamBlocks
            };
            
            const examNotes = document.getElementById('examNotes').value;
            showExamResult(examData, examNotes);
            
            showNotification('Đã lưu thay đổi đề thi!', 'success');
        }

        function updateExamPreview() {
            updateExamFromEditor();
            
            let previewHTML = `
                <div class="preview-exam">
                    <h1 class="exam-title">ĐỀ THI NGỮ VĂN</h1>
                    <div class="exam-info">
                        <p><strong>Thời gian làm bài:</strong> ${examSettings.time} phút | <strong>Mã đề:</strong> ${currentExamCode}</p>
                        <p><strong>Khối lớp:</strong> ${examSettings.grade} | <strong>Độ khó:</strong> ${examSettings.difficulty === 'easy' ? 'Dễ' : examSettings.difficulty === 'medium' ? 'Trung bình' : 'Khó'}</p>
                    </div>
            `;
            
            if (currentRealWorkInfo) {
                previewHTML += `
                    <div class="exam-info" style="background: rgba(76, 175, 80, 0.1); border-color: #4CAF50;">
                        <p><strong>Tác phẩm:</strong> ${currentRealWorkInfo.title} | <strong>Tác giả:</strong> ${currentRealWorkInfo.author} | <strong>Thể loại:</strong> ${currentRealWorkInfo.genre}</p>
                    </div>
                `;
            }
            
            let questionCounter = 1;
            let totalPoints = 0;
            
            currentExamBlocks.forEach((block, index) => {
                if (block.type === 'text') {
                    previewHTML += `
                        <div class="exam-section">
                            <h3 class="section-title">${block.title || 'Phần văn bản'}</h3>
                            <div class="text-content markdown-content" style="white-space: pre-wrap; font-family: 'Times New Roman', Times, serif;">${block.content}</div>
                        </div>
                    `;
                } else if (block.type === 'question') {
                    totalPoints += block.points || 0;
                    previewHTML += `
                        <div class="question-item">
                            <div class="question-header">
                                <div class="question-text markdown-content"><strong>Câu ${questionCounter}:</strong> ${block.content}</div>
                                <div class="question-points">${block.points || 1.0} điểm</div>
                            </div>
                            <div class="answer-area">
                                <textarea class="answer-textarea" placeholder="Thí sinh viết câu trả lời vào đây..." rows="4" style="white-space: pre-wrap;"></textarea>
                            </div>
                        </div>
                    `;
                    questionCounter++;
                }
            });
            
            previewHTML += `
                <div class="exam-info" style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid var(--card-outline);">
                    <p><strong>Tổng điểm: ${totalPoints.toFixed(1)} điểm</strong></p>
                    <p><em>--- Hết đề thi ---</em></p>
                </div>
            `;
            
            previewHTML += `</div>`;
            document.getElementById('previewContent').innerHTML = previewHTML;
            
            const modal = document.getElementById('previewModal');
            modal.classList.add('active');
        }

        function saveExam() {
            const editModal = document.getElementById('editExamModal');
            if (editModal && editModal.classList.contains('active')) {
                updateExamFromEditor();
            }
            
            const examData = {
                code: currentExamCode,
                title: "Đề thi Ngữ Văn",
                time: examSettings.time,
                difficulty: examSettings.difficulty,
                grade: examSettings.grade,
                blocks: currentExamBlocks,
                isRealWork: !!currentRealWorkInfo,
                workInfo: currentRealWorkInfo,
                createdAt: new Date().toISOString(),
                totalPoints: currentExamBlocks.reduce((sum, block) => sum + (block.points || 0), 0)
            };
            
            const savedExams = JSON.parse(localStorage.getItem('vanw_exams') || '[]');
            savedExams.push(examData);
            localStorage.setItem('vanw_exams', JSON.stringify(savedExams));
            
            showNotification(`Đã lưu đề thi thành công! Mã đề: ${currentExamCode}`, 'success');
        }

        function printExam() {
            updateExamFromEditor();
            
            let printHTML = `
                <div class="preview-exam">
                    <h1 class="exam-title">ĐỀ THI NGỮ VĂN</h1>
                    <div class="exam-info">
                        <p><strong>Thời gian làm bài:</strong> ${examSettings.time} phút | <strong>Mã đề:</strong> ${currentExamCode}</p>
                        <p><strong>Khối lớp:</strong> ${examSettings.grade} | <strong>Độ khó:</strong> ${examSettings.difficulty === 'easy' ? 'Dễ' : examSettings.difficulty === 'medium' ? 'Trung bình' : 'Khó'}</p>
                    </div>
            `;
            
            if (currentRealWorkInfo) {
                printHTML += `
                    <div class="exam-info" style="background: rgba(76, 175, 80, 0.1); border-color: #4CAF50;">
                        <p><strong>Tác phẩm:</strong> ${currentRealWorkInfo.title} | <strong>Tác giả:</strong> ${currentRealWorkInfo.author} | <strong>Thể loại:</strong> ${currentRealWorkInfo.genre}</p>
                    </div>
                `;
            }
            
            let questionCounter = 1;
            let totalPoints = 0;
            
            currentExamBlocks.forEach((block, index) => {
                if (block.type === 'text') {
                    printHTML += `
                        <div class="exam-section">
                            <h3 class="section-title">${block.title || 'Phần văn bản'}</h3>
                            <div class="text-content markdown-content" style="white-space: pre-wrap; font-family: 'Times New Roman', Times, serif;">${block.content}</div>
                        </div>
                    `;
                } else if (block.type === 'question') {
                    totalPoints += block.points || 0;
                    printHTML += `
                        <div class="question-item">
                            <div class="question-header">
                                <div class="question-text markdown-content"><strong>Câu ${questionCounter}:</strong> ${block.content}</div>
                                <div class="question-points">${block.points || 1.0} điểm</div>
                            </div>
                            <div class="answer-area">
                                <div class="answer-space" style="min-height: 100px; border: 1px dashed #ccc; margin-top: 10px; padding: 10px;"></div>
                            </div>
                        </div>
                    `;
                    questionCounter++;
                }
            });
            
            printHTML += `
                <div class="exam-info" style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid var(--card-outline);">
                    <p><strong>Tổng điểm: ${totalPoints.toFixed(1)} điểm</strong></p>
                    <p><em>--- Hết đề thi ---</em></p>
                </div>
            `;
            
            printHTML += `</div>`;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Đề thi ${currentExamCode} - VANW</title>
                    <style>
                        body { 
                            font-family: 'Times New Roman', Times, serif; 
                            padding: 20px; 
                            line-height: 1.6;
                            color: #333;
                            max-width: 210mm;
                            margin: 0 auto;
                        }
                        .exam-title { 
                            text-align: center; 
                            color: #e37c2d;
                            font-size: 24px;
                            margin-bottom: 10px;
                            border-bottom: 3px solid #e37c2d;
                            padding-bottom: 10px;
                        }
                        .exam-info { 
                            text-align: center; 
                            color: #666;
                            margin-bottom: 30px;
                            font-size: 14px;
                        }
                        .section-title {
                            color: #e37c2d;
                            font-size: 18px;
                            margin: 25px 0 15px;
                            padding-bottom: 5px;
                            border-bottom: 2px solid rgba(227, 124, 45, 0.3);
                        }
                        .text-content {
                            background: #f9f9f9;
                            padding: 15px;
                            border-radius: 8px;
                            margin-bottom: 20px;
                            border-left: 4px solid #e37c2d;
                            white-space: pre-wrap;
                            font-family: 'Times New Roman', Times, serif;
                        }
                        .question-item {
                            margin-bottom: 20px;
                            padding: 15px;
                            border: 1px solid #ddd;
                            border-radius: 8px;
                        }
                        .question-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                            margin-bottom: 10px;
                        }
                        .question-text {
                            flex: 1;
                            font-weight: 500;
                        }
                        .question-points {
                            background: #e37c2d;
                            color: white;
                            padding: 2px 10px;
                            border-radius: 15px;
                            font-size: 12px;
                            font-weight: bold;
                        }
                        .answer-space {
                            min-height: 100px;
                            border: 1px dashed #ccc;
                            padding: 10px;
                            border-radius: 5px;
                            margin-top: 10px;
                        }
                        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
                            color: #e37c2d;
                        }
                        .markdown-content strong {
                            color: #e37c2d;
                            font-weight: bold;
                        }
                        .markdown-content em {
                            font-style: italic;
                        }
                        .markdown-content u {
                            text-decoration: underline;
                        }
                        @media print {
                            body { font-size: 12pt; }
                            .no-print { display: none; }
                            .exam-title { font-size: 20pt; }
                            .text-content { font-family: 'Times New Roman', Times, serif !important; }
                        }
                    </style>
                </head>
                <body>
                    ${printHTML}
                    <div class="exam-info no-print" style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; font-size: 12px; color: #888;">
                        <p>Được tạo bởi Hệ thống Tạo Bài Thi Văn Học VANW</p>
                        <p>Ngày in: ${new Date().toLocaleDateString('vi-VN')}</p>
                    </div>
                    <script>
                        window.onload = function() { 
                            setTimeout(() => { window.print(); }, 500);
                        }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function showNotification(message, type = 'info') {
            const oldNotification = document.querySelector('.notification');
            if (oldNotification) {
                oldNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';
            if (type === 'warning') icon = 'exclamation-triangle';
            
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${icon}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            notification.style.cssText = `
                position: fixed;
                top: 30px;
                right: 30px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#2196F3'};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 6px 20px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55), fadeOut 0.4s ease 3.6s;
                animation-fill-mode: forwards;
                max-width: 400px;
                border: 2px solid rgba(255,255,255,0.3);
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 4000);
        }

        function setupExamSlider() {
            const slider = document.getElementById('examTimeSlider');
            const valueDisplay = document.getElementById('examTimeValue');
            
            if (!slider || !valueDisplay) return;
            
            valueDisplay.textContent = formatDuration(slider.value);
            updateExamSliderColor(slider.value);
            
            slider.addEventListener('input', function() {
                valueDisplay.textContent = formatDuration(this.value);
                updateExamSliderColor(this.value);
                
                const durationBtns = document.querySelectorAll('.duration-btn');
                durationBtns.forEach(btn => {
                    if (parseInt(btn.dataset.value) === parseInt(this.value)) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            });
            
            const durationBtns = document.querySelectorAll('.duration-btn');
            durationBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const value = parseInt(this.dataset.value);
                    slider.value = value;
                    valueDisplay.textContent = formatDuration(value);
                    updateExamSliderColor(value);
                    
                    durationBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        function updateExamSliderColor(value) {
            const slider = document.getElementById('examTimeSlider');
            const percent = ((value - slider.min) / (slider.max - slider.min)) * 100;
            slider.style.background = `linear-gradient(to right, var(--primary-color) 0%, var(--primary-color) ${percent}%, var(--border-color) ${percent}%, var(--border-color) 100%)`;
        }

        function setupWordCounter() {
            const textarea = document.getElementById('inputText');
            const wordCount = document.getElementById('wordCount');
            
            if (!textarea || !wordCount) return;
            
            textarea.addEventListener('input', function() {
                const count = countWords(this.value);
                wordCount.textContent = `${count} từ`;
                
                if (count < 20) {
                    wordCount.style.color = '#ef4444';
                    wordCount.style.fontWeight = '600';
                } else {
                    wordCount.style.color = 'var(--text-secondary)';
                    wordCount.style.fontWeight = 'normal';
                }
            });
        }

        function setupModal() {
            const previewModal = document.getElementById('previewModal');
            const editModal = document.getElementById('editExamModal');
            const closeButtons = document.querySelectorAll('.close-modal');
            const closePreviewBtn = document.getElementById('closePreviewBtn');
            const printPreviewBtn = document.getElementById('printPreviewBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const saveEditedExamBtn = document.getElementById('saveEditedExamBtn');
            
            closeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        modal.classList.remove('active');
                    }
                });
            });
            
            if (closePreviewBtn) {
                closePreviewBtn.addEventListener('click', function() {
                    previewModal.classList.remove('active');
                });
            }
            
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', function() {
                    editModal.classList.remove('active');
                });
            }
            
            if (saveEditedExamBtn) {
                saveEditedExamBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    saveEditedExam();
                });
            }
            
            if (printPreviewBtn) {
                printPreviewBtn.addEventListener('click', function() {
                    const printContent = document.getElementById('previewContent').innerHTML;
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>Đề thi ${currentExamCode} - VANW</title>
                            <style>
                                body { 
                                    font-family: 'Times New Roman', Times, serif; 
                                    padding: 20px; 
                                    line-height: 1.6;
                                    color: #333;
                                    max-width: 210mm;
                                    margin: 0 auto;
                                }
                                .exam-title { 
                                    text-align: center; 
                                    color: #e37c2d;
                                    font-size: 24px;
                                    margin-bottom: 10px;
                                    border-bottom: 3px solid #e37c2d;
                                    padding-bottom: 10px;
                                }
                                .exam-info { 
                                    text-align: center; 
                                    color: #666;
                                    margin-bottom: 30px;
                                    font-size: 14px;
                                }
                                .section-title {
                                    color: #e37c2d;
                                    font-size: 18px;
                                    margin: 25px 0 15px;
                                    padding-bottom: 5px;
                                    border-bottom: 2px solid rgba(227, 124, 45, 0.3);
                                }
                                .text-content {
                                    background: #f9f9f9;
                                    padding: 15px;
                                    border-radius: 8px;
                                    margin-bottom: 20px;
                                    border-left: 4px solid #e37c2d;
                                    white-space: pre-wrap;
                                    font-family: 'Times New Roman', Times, serif;
                                }
                                .question-item {
                                    margin-bottom: 20px;
                                    padding: 15px;
                                    border: 1px solid #ddd;
                                    border-radius: 8px;
                                }
                                .question-header {
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: flex-start;
                                    margin-bottom: 10px;
                                }
                                .question-text {
                                    flex: 1;
                                    font-weight: 500;
                                }
                                .question-points {
                                    background: #e37c2d;
                                    color: white;
                                    padding: 2px 10px;
                                    border-radius: 15px;
                                    font-size: 12px;
                                    font-weight: bold;
                                }
                                .answer-textarea {
                                    width: 100%;
                                    min-height: 100px;
                                    border: 1px dashed #ccc;
                                    padding: 10px;
                                    border-radius: 5px;
                                    margin-top: 10px;
                                    font-family: inherit;
                                }
                                .markdown-content h1, .markdown-content h2, .markdown-content h3 {
                                    color: #e37c2d;
                                }
                                .markdown-content strong {
                                    color: #e37c2d;
                                    font-weight: bold;
                                }
                                .markdown-content em {
                                    font-style: italic;
                                }
                                .markdown-content u {
                                    text-decoration: underline;
                                }
                                @media print {
                                    body { font-size: 12pt; }
                                    .no-print { display: none; }
                                    .exam-title { font-size: 20pt; }
                                    .text-content { font-family: 'Times New Roman', Times, serif !important; }
                                }
                            </style>
                        </head>
                        <body>
                            ${printContent}
                            <div class="exam-info no-print" style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; font-size: 12px; color: #888;">
                                <p>Được tạo bởi Hệ thống Tạo Bài Thi Văn Học VANW</p>
                                <p>Ngày in: ${new Date().toLocaleDateString('vi-VN')}</p>
                            </div>
                            <script>
                                window.onload = function() { 
                                    setTimeout(() => { window.print(); }, 500);
                                }
                            <\/script>
                        </body>
                        </html>
                    `);
                    printWindow.document.close();
                });
            }
            
            [previewModal, editModal].forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
            
            document.addEventListener('click', function(e) {
                if (e.target && e.target.id === 'addTextBlockBtn') {
                    e.preventDefault();
                    addBlock('text');
                }
                
                if (e.target && e.target.id === 'addQuestionBlockBtn') {
                    e.preventDefault();
                    addBlock('question');
                }
                
                if (e.target && e.target.id === 'reorderBlocksBtn') {
                    e.preventDefault();
                    reorderBlocks();
                }
                
                if (e.target && e.target.id === 'previewEditedExamBtn') {
                    e.preventDefault();
                    updateExamFromEditor();
                    updateExamPreview();
                    editModal.classList.remove('active');
                }
                
                if (e.target && e.target.closest('.block-btn.delete')) {
                    e.preventDefault();
                    const btn = e.target.closest('.block-btn.delete');
                    const index = parseInt(btn.dataset.index);
                    deleteBlock(index);
                }
                
                if (e.target && e.target.closest('.block-btn.move-up')) {
                    e.preventDefault();
                    const btn = e.target.closest('.block-btn.move-up');
                    const index = parseInt(btn.dataset.index);
                    moveBlock(index, 'up');
                }
                
                if (e.target && e.target.closest('.block-btn.move-down')) {
                    e.preventDefault();
                    const btn = e.target.closest('.block-btn.move-down');
                    const index = parseInt(btn.dataset.index);
                    moveBlock(index, 'down');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const generateExamBtn = document.getElementById('generateExamBtn');
            if (generateExamBtn) {
                generateExamBtn.addEventListener('click', generateExam);
            }
            
            const generateRandomExamBtn = document.getElementById('generateRandomExamBtn');
            if (generateRandomExamBtn) {
                generateRandomExamBtn.addEventListener('click', generateRandomExam);
            }
            
            const inputText = document.getElementById('inputText');
            if (inputText) {
                inputText.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        e.preventDefault();
                        generateExam();
                    }
                });
            }
            
            const settingsBtn = document.getElementById('settingsBtn');
            if (settingsBtn) {
                settingsBtn.addEventListener('click', function() {
                    const settingsPanel = document.getElementById('settingsPanel');
                    if (settingsPanel) {
                        settingsPanel.classList.toggle('active');
                        
                        const icon = this.querySelector('i');
                        if (settingsPanel.classList.contains('active')) {
                            icon.className = 'fas fa-times';
                            this.style.backgroundColor = 'rgba(227, 124, 45, 0.2)';
                            this.style.borderColor = 'var(--primary-color)';
                        } else {
                            icon.className = 'fas fa-cog';
                            this.style.backgroundColor = '';
                            this.style.borderColor = '';
                        }
                    }
                });
            }
            
            setupExamSlider();
            setupWordCounter();
            setupModal();
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(100%) translateY(-20px);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0) translateY(0);
                        opacity: 1;
                    }
                }
                
                @keyframes fadeOut {
                    from {
                        opacity: 1;
                    }
                    to {
                        opacity: 0;
                        transform: translateX(100%) translateY(-20px);
                    }
                }
                
                .notification-content {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                }
                
                .notification-content i {
                    font-size: 1.3rem;
                }
                
                .notification-content span {
                    font-size: 1rem;
                    font-weight: 500;
                }
            `;
            document.head.appendChild(style);
            
            document.getElementById('inputText')?.focus();
            
            if (firestoreDbPrimary && firestoreDbSecondary) {
                console.log('Cả 2 Firestore Databases đã sẵn sàng để lưu đề thi');
            }
        });
    </script>
</body>
</html>
