<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tạo Bài Thi Văn Học - VANW</title>
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css">
    <style>
        /* Import Normalize CSS */
        @import url('https://unpkg.com/normalize.css') layer(normalize);

        /* CSS Layers */
        @layer normalize, base, demo;

        /* Base Layer */
        @layer base {
            :root {
                --font-size-min: 16;
                --font-size-max: 20;
                --font-ratio-min: 1.2;
                --font-ratio-max: 1.33;
                --font-width-min: 375;
                --font-width-max: 1500;
                
                /* Light theme variables - Màu cam đậm hơn (#e37c2d) */
                --bg-color: #f5f5f5;
                --card-bg: #ffffff;
                --card-outline: #b0b0b0;
                --text-primary: #000000;
                --text-secondary: #666666;
                --border-color: #c0c0c0;
                --button-bg: rgba(0, 0, 0, 0.08);
                --grid-color: #a0a0a0;
                --gradient: linear-gradient(135deg, #e37c2d, #f5a742, #f8c34d, #fad859);
                --primary-color: #e37c2d;
                --accent-color: #fad859;
                --shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
                --scrollbar-track: #f0f0f0;
                --scrollbar-thumb: #c0c0c0;
                --scrollbar-thumb-hover: #a0a0a0;
            }

            html {
                color-scheme: light;
            }

            *,
            *:after,
            *:before {
                box-sizing: border-box;
            }

            /* Custom Scrollbar Styles */
            ::-webkit-scrollbar {
                width: 10px;
                height: 10px;
            }

            ::-webkit-scrollbar-track {
                background: var(--scrollbar-track);
                border-radius: 5px;
                border: 1px solid var(--card-outline);
            }

            ::-webkit-scrollbar-thumb {
                background: var(--scrollbar-thumb);
                border-radius: 5px;
                border: 1px solid var(--card-outline);
            }

            ::-webkit-scrollbar-thumb:hover {
                background: var(--scrollbar-thumb-hover);
            }

            /* Firefox */
            * {
                scrollbar-width: thin;
                scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
            }

            body {
                background: var(--bg-color);
                display: grid;
                place-items: center;
                min-height: 100vh;
                font-family: 'SF Pro Text', 'SF Pro Icons', 'AOS Icons', 'Helvetica Neue',
                    Helvetica, Arial, sans-serif, system-ui;
                line-height: 1.5;
                color: var(--text-primary);
                padding: 2rem;
                margin: 0;
            }

            body::before {
                --size: 45px;
                --line: var(--grid-color);
                content: '';
                height: 100vh;
                width: 100vw;
                position: fixed;
                background: linear-gradient(
                        90deg,
                        var(--line) 1px,
                        transparent 1px var(--size)
                    )
                    calc(var(--size) * 0.36) 50% / var(--size) var(--size),
                    linear-gradient(var(--line) 1px, transparent 1px var(--size)) 0%
                        calc(var(--size) * 0.32) / var(--size) var(--size);
                mask: linear-gradient(-20deg, transparent 50%, white);
                top: 0;
                transform-style: flat;
                pointer-events: none;
                z-index: -1;
                opacity: 0.8;
            }

            .web-icon {
                position: fixed;
                top: 1rem;
                left: 1rem;
                width: 48px;
                aspect-ratio: 1;
                display: grid;
                place-items: center;
                opacity: 0.8;
                transition: opacity 0.2s;
            }

            .web-icon:hover {
                opacity: 1;
                transform: scale(1.05);
            }

            .web-icon img {
                width: 100%;
                height: 100%;
                object-fit: contain;
            }

            /* Utilities */
            .sr-only {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                white-space: nowrap;
                border-width: 0;
            }
            
            .mr-2 {
                margin-right: 0.5rem;
            }
            
            .text-red-500 {
                color: #ef4444;
            }
            
            .w-full {
                width: 100%;
            }
            
            .border {
                border: 1px solid var(--card-outline);
            }
            
            .rounded-lg {
                border-radius: 8px;
            }
            
            .p-2 {
                padding: 0.5rem;
            }
            
            .mt-1 {
                margin-top: 0.25rem;
            }
            
            .mt-3 {
                margin-top: 0.75rem;
            }
        }

        /* Demo Layer */
        @layer demo {
            body {
                align-content: center;
                gap: 2rem;
                margin: 0;
                padding: 2rem;
                min-height: 100vh;
                display: grid;
                place-items: center;
            }

            .app-container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 2rem;
                width: 100%;
                padding-top: 40px;
            }
            
            main {
                touch-action: none;
                padding-block: 2rem;
                width: 100%;
                display: flex;
                flex-direction: column;
                gap: 2rem;
                align-items: center;
            }
            
            /* Exam Tool Styles */
            .exam-tool {
                padding: 0 0;
                background-color: transparent;
                width: 100%;
            }
            
            .exam-card {
                background: var(--card-bg);
                border-radius: 20px;
                padding: 2.5rem;
                box-shadow: var(--shadow);
                transition: all 0.4s ease;
                margin-bottom: 2rem;
                width: 100%;
                max-width: 900px;
                margin: 0 auto;
                border: 2px solid var(--card-outline);
            }
            
            .exam-card h2 {
                color: var(--primary-color);
                margin-bottom: 1.5rem;
                font-size: 2rem;
                text-align: center;
                text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            }
            
            /* Mode Selection */
            .mode-selection {
                margin-bottom: 2rem;
            }
            
            .mode-buttons {
                display: flex;
                gap: 1rem;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .mode-btn {
                flex: 1;
                min-width: 250px;
                padding: 1.5rem;
                background: var(--card-bg);
                border: 2px solid var(--card-outline);
                border-radius: 12px;
                color: var(--text-primary);
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            
            .mode-btn i {
                font-size: 2rem;
                color: var(--text-secondary);
                transition: color 0.3s ease;
            }
            
            .mode-btn span {
                text-align: center;
                line-height: 1.4;
            }
            
            .mode-btn:hover {
                background: rgba(227, 124, 45, 0.1);
                border-color: var(--primary-color);
                transform: translateY(-3px);
                box-shadow: var(--shadow);
            }
            
            .mode-btn:hover i {
                color: var(--primary-color);
            }
            
            .mode-btn.active {
                background: var(--gradient);
                color: white;
                border-color: var(--primary-color);
            }
            
            .mode-btn.active i {
                color: white;
            }
            
            /* Input Areas */
            .input-area, .text-gen-area {
                margin-bottom: 2rem;
                position: relative;
            }
            
            textarea {
                width: 100%;
                min-height: 200px;
                padding: 1.5rem;
                border-radius: 12px;
                border: 2px solid var(--card-outline);
                background-color: var(--card-bg);
                color: var(--text-primary);
                font-size: 1rem;
                resize: vertical;
                transition: all 0.3s ease;
                font-family: inherit;
                line-height: 1.6;
                white-space: pre-wrap;
            }
            
            textarea:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(227, 124, 45, 0.2);
            }
            
            .word-count {
                position: absolute;
                bottom: 10px;
                right: 15px;
                font-size: 0.85rem;
                color: var(--text-secondary);
                background: rgba(255, 255, 255, 0.9);
                padding: 2px 8px;
                border-radius: 10px;
                border: 1px solid var(--card-outline);
            }
            
            /* Text Generation Options */
            .text-gen-area .gen-options {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 1.5rem;
                margin-bottom: 2rem;
                padding: 1.5rem;
                background: rgba(227, 124, 45, 0.05);
                border-radius: 12px;
                border: 2px solid var(--card-outline);
            }
            
            .option-group {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .option-label {
                font-weight: 600;
                color: var(--primary-color);
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 0.95rem;
            }
            
            .option-group select,
            .option-group input {
                padding: 0.85rem;
                border-radius: 8px;
                border: 2px solid var(--card-outline);
                background-color: var(--card-bg);
                color: var(--text-primary);
                font-size: 0.95rem;
                transition: all 0.3s ease;
                font-family: inherit;
            }
            
            .option-group select:focus,
            .option-group input:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(227, 124, 45, 0.2);
            }
            
            .range-slider {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .range-label {
                font-size: 0.9rem;
                color: var(--text-primary);
                font-weight: 500;
            }
            
            .range-slider input[type="range"] {
                width: 100%;
                height: 8px;
                -webkit-appearance: none;
                background: linear-gradient(to right, var(--primary-color) 0%, var(--primary-color) 40%, var(--border-color) 40%, var(--border-color) 100%);
                border-radius: 4px;
                outline: none;
            }
            
            .range-slider input[type="range"]::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background: var(--primary-color);
                cursor: pointer;
                border: 3px solid white;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            }
            
            /* Action Buttons */
            .action-buttons {
                display: flex;
                gap: 1rem;
                margin-bottom: 2rem;
            }
            
            .generate-btn {
                flex: 2;
                background: var(--gradient);
                color: white;
                padding: 1rem 2rem;
                border: none;
                border-radius: 30px;
                font-size: 1.1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                position: relative;
                overflow: hidden;
                z-index: 1;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .generate-btn::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 0%;
                height: 100%;
                background: rgba(255, 255, 255, 0.2);
                transition: all 0.5s;
                z-index: -1;
            }
            
            .generate-btn:hover::before {
                width: 100%;
            }
            
            .generate-btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
                border-color: var(--accent-color);
            }
            
            .generate-btn:disabled {
                background: #ccc;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
                border-color: #999;
                opacity: 0.7;
            }
            
            .generate-btn:disabled:hover::before {
                width: 0%;
            }
            
            .settings-btn {
                flex: 1;
                background: var(--card-bg);
                color: var(--text-primary);
                padding: 1rem;
                border: 2px solid var(--card-outline);
                border-radius: 30px;
                font-size: 1.1rem;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .settings-btn:hover {
                background: rgba(227, 124, 45, 0.1);
                border-color: var(--primary-color);
            }
            
            /* Settings Panel */
            .settings-panel {
                background: var(--card-bg);
                border-radius: 15px;
                padding: 1.5rem;
                margin-bottom: 2rem;
                display: none;
            }
            
            .settings-panel.active {
                display: block;
                animation: fadeIn 0.3s ease;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            .options-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 1.5rem;
            }
            
            .option-card {
                background: var(--card-bg);
                border-radius: 12px;
                padding: 1.5rem;
                box-shadow: var(--shadow);
                transition: all 0.3s ease;
                border-left: 5px solid var(--primary-color);
                border: 2px solid var(--card-outline);
            }
            
            .option-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
                border-color: var(--primary-color);
            }
            
            .option-card h3 {
                color: var(--primary-color);
                margin-bottom: 1rem;
                font-size: 1.2rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            
            .option-card h3 i {
                font-size: 1.1rem;
            }
            
            /* Duration Control */
            .duration-control {
                margin-top: 15px;
            }
            
            .duration-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .duration-control label {
                font-weight: 600;
                color: var(--text-primary);
                font-size: 1rem;
            }
            
            #examTimeValue {
                font-weight: bold;
                color: var(--primary-color);
                font-size: 1.1rem;
                margin-left: 5px;
            }
            
            .duration-buttons {
                display: flex;
                gap: 8px;
            }
            
            .duration-btn {
                padding: 6px 12px;
                background: var(--card-bg);
                border: 2px solid var(--card-outline);
                border-radius: 20px;
                color: var(--text-primary);
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.3s ease;
                font-weight: 500;
            }
            
            .duration-btn:hover {
                background: rgba(227, 124, 45, 0.1);
                border-color: var(--primary-color);
            }
            
            .duration-btn.active {
                background: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }
            
            #examTimeSlider {
                width: 100%;
                height: 10px;
                -webkit-appearance: none;
                appearance: none;
                background: linear-gradient(to right, var(--primary-color) 0%, var(--primary-color) 50%, var(--border-color) 50%, var(--border-color) 100%);
                border-radius: 5px;
                outline: none;
                margin-top: 10px;
            }
            
            #examTimeSlider::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 26px;
                height: 26px;
                border-radius: 50%;
                background: var(--primary-color);
                cursor: pointer;
                border: 3px solid white;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                transition: all 0.2s ease;
            }
            
            #examTimeSlider::-webkit-slider-thumb:hover {
                transform: scale(1.1);
                background: var(--accent-color);
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            }
            
            /* Toggle Switch */
            .toggle-container {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 1rem;
                padding: 8px 0;
                border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            }
            
            .toggle-container:last-child {
                border-bottom: none;
                margin-bottom: 0;
            }
            
            .toggle-label {
                font-weight: 500;
                color: var(--text-primary);
                font-size: 0.95rem;
                flex: 1;
            }
            
            .toggle-switch {
                position: relative;
                display: inline-block;
                width: 50px;
                height: 26px;
                flex-shrink: 0;
            }
            
            .toggle-switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }
            
            .toggle-slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #ccc;
                transition: .4s;
                border-radius: 34px;
                border: 2px solid #aaa;
            }
            
            .toggle-slider:before {
                position: absolute;
                content: "";
                height: 18px;
                width: 18px;
                left: 2px;
                bottom: 2px;
                background-color: white;
                transition: .4s;
                border-radius: 50%;
                border: 1px solid #ddd;
            }
            
            input:checked + .toggle-slider {
                background-color: var(--primary-color);
                border-color: var(--primary-color);
            }
            
            input:checked + .toggle-slider:before {
                transform: translateX(24px);
            }
            
            /* Select Container */
            .select-container {
                margin-bottom: 1rem;
            }
            
            .block-label {
                display: block;
                font-size: 0.9rem;
                color: var(--text-secondary);
                margin-bottom: 0.5rem;
                font-weight: 500;
            }
            
            select {
                width: 100%;
                padding: 0.85rem;
                border-radius: 10px;
                border: 2px solid var(--card-outline);
                background-color: var(--card-bg);
                color: var(--text-primary);
                font-size: 1rem;
                transition: all 0.3s ease;
                font-family: inherit;
                cursor: pointer;
            }
            
            select:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(227, 124, 45, 0.2);
            }
            
            /* Progress Container */
            .progress-container {
                margin-top: 2rem;
                background-color: var(--card-bg);
                border-radius: 15px;
                padding: 1.8rem;
                box-shadow: var(--shadow);
                border: 2px solid var(--card-outline);
            }
            
            .progress-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1.2rem;
            }
            
            .progress-title {
                font-weight: 700;
                color: var(--primary-color);
                font-size: 1.3rem;
            }
            
            .progress-status {
                font-size: 1rem;
                color: var(--text-primary);
                font-weight: 500;
            }
            
            .progress-bar {
                height: 12px;
                background-color: #e0e0e0;
                border-radius: 6px;
                overflow: hidden;
                margin-bottom: 1.2rem;
                border: 2px solid #ccc;
            }
            
            .progress-fill {
                height: 100%;
                background: var(--gradient);
                border-radius: 6px;
                transition: width 0.4s ease;
            }
            
            .progress-items {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
                gap: 0.8rem;
                max-height: 220px;
                overflow-y: auto;
                padding-right: 10px;
            }
            
            .progress-item {
                display: flex;
                align-items: center;
                font-size: 1rem;
                color: var(--text-primary);
                padding: 8px 12px;
                border-radius: 8px;
                border: 2px solid transparent;
                background: rgba(0, 0, 0, 0.02);
                transition: all 0.3s ease;
            }
            
            .progress-item:hover {
                border-color: var(--card-outline);
                background: rgba(227, 124, 45, 0.05);
            }
            
            .progress-item i {
                margin-right: 10px;
                font-size: 1rem;
            }
            
            .progress-item.completed {
                color: var(--primary-color);
                border-color: rgba(227, 124, 45, 0.4);
                background-color: rgba(227, 124, 45, 0.08);
            }
            
            .progress-item.pending {
                color: #9ca3af;
                border-color: rgba(156, 163, 175, 0.3);
            }
            
            .progress-item.error {
                color: #ef4444;
                border-color: rgba(239, 68, 68, 0.4);
                background-color: rgba(239, 68, 68, 0.08);
            }
            
            /* Đặc biệt cho mục tự kiểm chứng */
            .progress-item.verification {
                color: #2196F3;
                border-color: rgba(33, 150, 243, 0.4);
                background-color: rgba(33, 150, 243, 0.1);
                font-weight: 600;
                animation: pulse 2s infinite;
                border-width: 3px;
            }
            
            @keyframes pulse {
                0% { border-color: rgba(33, 150, 243, 0.4); }
                50% { border-color: rgba(33, 150, 243, 0.8); }
                100% { border-color: rgba(33, 150, 243, 0.4); }
            }
            
            /* Exam Result Container */
            .exam-result-container {
                margin-top: 2rem;
                background: var(--card-bg);
                border-radius: 15px;
                padding: 2rem;
                box-shadow: var(--shadow);
                border: 2px solid var(--card-outline);
            }
            
            /* Exam Header */
            .exam-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1.5rem;
                padding-bottom: 1rem;
                border-bottom: 2px solid var(--card-outline);
            }
            
            .exam-header h3 {
                color: var(--primary-color);
                font-size: 1.3rem;
                margin: 0;
            }
            
            .exam-code {
                background: rgba(227, 124, 45, 0.1);
                padding: 0.5rem 1rem;
                border-radius: 20px;
                font-weight: 600;
                color: var(--primary-color);
                border: 2px solid var(--primary-color);
            }
            
            .exam-info {
                background: rgba(227, 124, 45, 0.05);
                padding: 1rem;
                border-radius: 8px;
                margin-bottom: 1.5rem;
                border: 1px solid var(--card-outline);
            }
            
            /* Preview Exam Styles */
            .preview-exam {
                font-family: inherit;
            }
            
            .preview-exam .exam-title {
                text-align: center;
                color: var(--primary-color);
                font-size: 1.8rem;
                margin-bottom: 1rem;
                padding-bottom: 1rem;
                border-bottom: 3px solid var(--primary-color);
            }
            
            .preview-exam .exam-info {
                text-align: center;
                color: var(--text-secondary);
                margin-bottom: 2rem;
                font-size: 0.95rem;
            }
            
            .preview-exam .exam-section {
                margin-bottom: 2rem;
            }
            
            .preview-exam .section-title {
                color: var(--primary-color);
                font-size: 1.3rem;
                margin-bottom: 1rem;
                padding-bottom: 0.5rem;
                border-bottom: 2px solid rgba(227, 124, 45, 0.3);
            }
            
            .preview-exam .text-content {
                background: rgba(0, 0, 0, 0.02);
                padding: 1rem;
                border-radius: 8px;
                margin-bottom: 1.5rem;
                border-left: 4px solid var(--primary-color);
                line-height: 1.7;
                white-space: pre-line;
                font-family: 'Times New Roman', serif;
                font-size: 1.05rem;
            }
            
            .preview-exam .question-item {
                background: var(--card-bg);
                border: 2px solid var(--card-outline);
                border-radius: 8px;
                padding: 1.5rem;
                margin-bottom: 1rem;
            }
            
            .preview-exam .question-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 1rem;
            }
            
            .preview-exam .question-text {
                flex: 1;
                font-weight: 500;
                color: var(--text-primary);
                font-size: 1.05rem;
            }
            
            .preview-exam .question-points {
                background: var(--primary-color);
                color: white;
                padding: 0.25rem 0.75rem;
                border-radius: 20px;
                font-size: 0.9rem;
                font-weight: 600;
                margin-left: 1rem;
                flex-shrink: 0;
            }
            
            .preview-exam .answer-area {
                margin-top: 1rem;
            }
            
            .preview-exam .answer-textarea {
                width: 100%;
                min-height: 80px;
                padding: 0.75rem;
                border: 1px dashed var(--card-outline);
                border-radius: 6px;
                background: rgba(0, 0, 0, 0.02);
                color: var(--text-primary);
                font-family: inherit;
                font-size: 0.95rem;
            }
            
            /* Exam Actions */
            .exam-actions {
                display: flex;
                gap: 1rem;
                justify-content: center;
                margin-top: 2rem;
                flex-wrap: wrap;
            }
            
            .exam-action-btn {
                padding: 12px 24px;
                border-radius: 8px;
                border: none;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                min-width: 150px;
                justify-content: center;
            }
            
            .preview-btn {
                background: linear-gradient(135deg, #9C27B0, #7B1FA2);
                color: white;
            }
            
            .edit-btn {
                background: linear-gradient(135deg, #FF9800, #F57C00);
                color: white;
            }
            
            .save-btn {
                background: linear-gradient(135deg, #4CAF50, #45a049);
                color: white;
            }
            
            .reset-btn {
                background: linear-gradient(135deg, #FF5722, #E64A19);
                color: white;
            }
            
            .add-btn {
                background: linear-gradient(135deg, #2196F3, #1976D2);
                color: white;
            }
            
            .exam-action-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                opacity: 0.95;
            }
            
            /* Modal Styles */
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                align-items: center;
                justify-content: center;
            }
            
            .modal.active {
                display: flex;
                animation: fadeIn 0.3s ease;
            }
            
            .modal-content {
                background: var(--card-bg);
                border-radius: 12px;
                width: 90%;
                max-width: 800px;
                max-height: 90vh;
                display: flex;
                flex-direction: column;
                border: 3px solid var(--primary-color);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            }
            
            .modal-content.large-modal {
                max-width: 1000px;
                max-height: 95vh;
            }
            
            .modal-header {
                padding: 1.5rem;
                border-bottom: 2px solid var(--card-outline);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .modal-header h3 {
                color: var(--primary-color);
                margin: 0;
                font-size: 1.3rem;
            }
            
            .close-modal {
                background: none;
                border: none;
                font-size: 1.5rem;
                color: var(--text-secondary);
                cursor: pointer;
                transition: color 0.2s;
            }
            
            .close-modal:hover {
                color: var(--primary-color);
            }
            
            .modal-body {
                padding: 1.5rem;
                overflow-y: auto;
                flex: 1;
            }
            
            .modal-footer {
                padding: 1.5rem;
                border-top: 2px solid var(--card-outline);
                display: flex;
                justify-content: flex-end;
                gap: 1rem;
            }
            
            .modal-btn {
                padding: 10px 20px;
                border-radius: 8px;
                border: none;
                font-size: 1rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
            }
            
            .modal-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }
            
            .secondary-btn {
                background: var(--card-bg);
                border: 2px solid var(--card-outline);
                color: var(--text-primary);
            }
            
            .secondary-btn:hover {
                border-color: var(--primary-color);
                background: rgba(227, 124, 45, 0.1);
            }
            
            /* Editor Container */
            .exam-editor-container {
                max-width: 100%;
            }
            
            .editor-actions {
                display: flex;
                gap: 1rem;
                margin-bottom: 1.5rem;
                flex-wrap: wrap;
            }
            
            .editor-action-btn {
                padding: 10px 20px;
                background: var(--card-bg);
                border: 2px solid var(--card-outline);
                border-radius: 8px;
                color: var(--text-primary);
                font-size: 0.95rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .editor-action-btn:hover {
                background: rgba(227, 124, 45, 0.1);
                border-color: var(--primary-color);
            }
            
            /* Rich Text Editor */
            .rich-text-editor {
                border: 2px solid var(--card-outline);
                border-radius: 8px;
                overflow: hidden;
                margin-bottom: 1rem;
            }
            
            .rich-text-editor .ql-toolbar {
                border-bottom: 2px solid var(--card-outline);
                background: rgba(227, 124, 45, 0.05);
            }
            
            .rich-text-editor .ql-container {
                font-family: inherit;
                font-size: 1rem;
                min-height: 200px;
                max-height: 300px;
                overflow-y: auto;
            }
            
            .rich-text-editor .ql-editor {
                min-height: 200px;
                white-space: pre-line;
                font-family: 'Times New Roman', serif;
            }
            
            /* Text Preview */
            .text-preview {
                font-family: inherit;
                line-height: 1.8;
                color: var(--text-primary);
            }
            
            .text-preview h3 {
                color: var(--primary-color);
                margin-bottom: 1rem;
                padding-bottom: 0.5rem;
                border-bottom: 2px solid var(--primary-color);
            }
            
            .text-preview .text-content {
                background: rgba(0, 0, 0, 0.02);
                padding: 1.5rem;
                border-radius: 8px;
                border-left: 4px solid var(--primary-color);
                max-height: 400px;
                overflow-y: auto;
                margin-bottom: 1rem;
                white-space: pre-line;
                line-height: 1.7;
                font-family: 'Times New Roman', serif;
            }
            
            .text-preview .text-meta {
                display: flex;
                flex-wrap: wrap;
                gap: 1rem;
                margin-top: 1rem;
                padding: 1rem;
                background: rgba(227, 124, 45, 0.05);
                border-radius: 8px;
                font-size: 0.9rem;
                color: var(--text-secondary);
            }
            
            .text-preview .meta-item {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            
            /* App Footer */
            .app-footer {
                text-align: center;
                margin-top: 3rem;
                padding-top: 2rem;
                border-top: 2px solid var(--border-color);
                color: var(--text-secondary);
            }
            
            .app-footer a {
                color: var(--primary-color);
                text-decoration: none;
                font-weight: 600;
                transition: all 0.3s ease;
            }
            
            .app-footer a:hover {
                text-decoration: underline;
                color: var(--accent-color);
            }
            
            /* Markdown Formatted Content */
            .markdown-content {
                font-family: inherit;
                line-height: 1.6;
            }
            
            .markdown-content h1 {
                color: var(--primary-color);
                font-size: 1.8rem;
                margin: 1.5rem 0 1rem;
                padding-bottom: 0.5rem;
                border-bottom: 3px solid var(--primary-color);
            }
            
            .markdown-content h2 {
                color: var(--primary-color);
                font-size: 1.5rem;
                margin: 1.2rem 0 0.8rem;
                padding-left: 0.5rem;
                border-left: 3px solid var(--primary-color);
            }
            
            .markdown-content h3 {
                color: var(--accent-color);
                font-size: 1.3rem;
                margin: 1rem 0 0.6rem;
            }
            
            .markdown-content p {
                margin-bottom: 1rem;
            }
            
            .markdown-content strong {
                color: var(--primary-color);
                font-weight: 700;
            }
            
            .markdown-content em {
                color: var(--text-secondary);
                font-style: italic;
            }
            
            .markdown-content ul, .markdown-content ol {
                margin-left: 1.5rem;
                margin-bottom: 1rem;
            }
            
            .markdown-content li {
                margin-bottom: 0.5rem;
            }
            
            .markdown-content blockquote {
                border-left: 4px solid var(--accent-color);
                margin: 1rem 0;
                padding: 0.5rem 1rem;
                background: rgba(250, 216, 89, 0.1);
                font-style: italic;
            }
            
            /* Responsive Design */
            @media (max-width: 992px) {
                .options-grid {
                    grid-template-columns: 1fr;
                }
                
                .text-gen-area .gen-options {
                    grid-template-columns: 1fr;
                }
            }
            
            @media (max-width: 768px) {
                body {
                    padding: 1rem;
                }
                
                .exam-card {
                    padding: 1.8rem;
                }
                
                .mode-buttons {
                    flex-direction: column;
                }
                
                .mode-btn {
                    min-width: 100%;
                }
                
                .action-buttons {
                    flex-direction: column;
                }
                
                .app-container {
                    padding: 1rem;
                    padding-top: 20px;
                }
                
                main {
                    gap: 1.5rem;
                    padding-block: 1rem;
                }
                
                .duration-header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 15px;
                }
                
                .duration-buttons {
                    width: 100%;
                    justify-content: space-between;
                }
                
                .duration-btn {
                    flex: 1;
                    text-align: center;
                }
                
                /* Exam Tab Responsive */
                .exam-header {
                    flex-direction: column;
                    gap: 1rem;
                    text-align: center;
                }
                
                .exam-actions {
                    flex-direction: column;
                    align-items: stretch;
                }
                
                .exam-action-btn {
                    min-width: 100%;
                }
                
                .modal-content {
                    width: 95%;
                    margin: 0.5rem;
                }
                
                .modal-content.large-modal {
                    width: 98%;
                    max-height: 90vh;
                }
                
                .editor-actions {
                    flex-direction: column;
                }
                
                .editor-action-btn {
                    width: 100%;
                    justify-content: center;
                }
                
                .app-footer {
                    margin-top: 2rem;
                    padding-top: 1.5rem;
                }
                
                .app-footer p {
                    font-size: 0.9rem;
                }
            }
            
            @media (max-width: 480px) {
                body {
                    padding: 0.5rem;
                }
                
                .app-container {
                    padding: 0.5rem;
                    padding-top: 15px;
                }
                
                .progress-items {
                    grid-template-columns: 1fr;
                }
                
                .exam-card h2 {
                    font-size: 1.6rem;
                }
                
                .modal-content {
                    width: 95%;
                    margin: 0.5rem;
                }
            }
            
            @media (min-width: 1200px) {
                .exam-card {
                    max-width: 1000px;
                }
            }
        }
    </style>
</head>
<body>
    <!-- Web Icon ở góc trái -->
    <a aria-label="Website Icon" class="web-icon" href="index.html" rel="noreferrer noopener">
        <img src="logo.png" alt="Website Icon" />
    </a>
    
    <div class="app-container">
        <main>
            <div class="exam-tool">
                <div class="exam-card">
                    <h2>HỆ THỐNG TẠO BÀI THI VĂN HỌC</h2>
                    
                    <!-- Mode Selection -->
                    <div class="mode-selection">
                        <div class="mode-buttons">
                            <button class="mode-btn active" data-mode="from-text">
                                <i class="fas fa-file-alt"></i>
                                <span>Từ văn bản có sẵn</span>
                            </button>
                            <button class="mode-btn" data-mode="generate-text">
                                <i class="fas fa-magic"></i>
                                <span>Tạo văn bản mẫu tự động</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Input Area for Existing Text -->
                    <div class="input-area" id="existingTextArea">
                        <textarea id="inputText" placeholder="Nhập hoặc dán nội dung văn bản văn học cần tạo đề thi... (Tối thiểu 20 từ)"></textarea>
                        <div class="word-count" id="wordCount">0 từ</div>
                    </div>
                    
                    <!-- Text Generation Options -->
                    <div class="text-gen-area" id="textGenArea" style="display: none;">
                        <div class="gen-options">
                            <div class="option-group">
                                <label class="option-label">
                                    <i class="fas fa-book"></i> Thể loại văn bản
                                </label>
                                <select id="textGenre">
                                    <option value="tho">Thơ</option>
                                    <option value="truyen_ngan">Truyện ngắn</option>
                                    <option value="tieu_thuyet">Tiểu thuyết</option>
                                    <option value="ky">Ký</option>
                                    <option value="phe_binh">Phê bình văn học</option>
                                </select>
                            </div>
                            
                            <div class="option-group">
                                <label class="option-label">
                                    <i class="fas fa-user"></i> Tác giả mẫu
                                </label>
                                <select id="authorStyle">
                                    <option value="xuandieu">Xuân Diệu</option>
                                    <option value="namcao">Nam Cao</option>
                                    <option value="thachlam">Thạch Lam</option>
                                    <option value="toky">Tô Hoài</option>
                                    <option value="nguyentuan">Nguyễn Tuân</option>
                                    <option value="custom">Tự chọn...</option>
                                </select>
                            </div>
                            
                            <div class="option-group" id="customAuthorGroup" style="display: none;">
                                <label class="option-label">
                                    <i class="fas fa-edit"></i> Tên tác giả
                                </label>
                                <input type="text" id="customAuthor" placeholder="Nhập tên tác giả...">
                            </div>
                            
                            <div class="option-group">
                                <label class="option-label">
                                    <i class="fas fa-ruler"></i> Độ dài văn bản
                                </label>
                                <div class="range-slider">
                                    <span class="range-label" id="lengthLabel">Ngắn (~200 từ)</span>
                                    <input type="range" id="textLength" min="1" max="5" value="2">
                                </div>
                            </div>
                            
                            <div class="option-group">
                                <label class="option-label">
                                    <i class="fas fa-palette"></i> Phong cách viết
                                </label>
                                <select id="writingStyle">
                                    <option value="classic">Cổ điển</option>
                                    <option value="modern">Hiện đại</option>
                                    <option value="romantic">Lãng mạn</option>
                                    <option value="realistic">Hiện thực</option>
                                    <option value="surreal">Siêu thực</option>
                                </select>
                            </div>
                            
                            <div class="option-group">
                                <label class="option-label">
                                    <i class="fas fa-bullseye"></i> Chủ đề chính
                                </label>
                                <input type="text" id="mainTheme" placeholder="Ví dụ: tình yêu, chiến tranh, thiên nhiên...">
                            </div>
                        </div>
                        
                        <button id="generateTextBtn" class="generate-btn">
                            <i class="fas fa-wand-magic-sparkles mr-2"></i> Tạo văn bản mẫu
                        </button>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button id="generateExamBtn" class="generate-btn">
                            <i class="fas fa-file-alt mr-2"></i> Tạo Bài Thi
                        </button>
                        <button id="settingsBtn" class="settings-btn">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                    
                    <!-- Settings Panel -->
                    <div class="settings-panel" id="settingsPanel">
                        <div class="options-grid">
                            <div class="option-card">
                                <h3><i class="fas fa-clock"></i> Thời gian làm bài</h3>
                                <div class="duration-control">
                                    <div class="duration-header">
                                        <label for="examTimeSlider">Thời gian: <span id="examTimeValue">90 phút</span></label>
                                        <div class="duration-buttons">
                                            <button type="button" class="duration-btn" data-value="45">45p</button>
                                            <button type="button" class="duration-btn" data-value="90">90p</button>
                                            <button type="button" class="duration-btn" data-value="120">120p</button>
                                        </div>
                                    </div>
                                    <input type="range" id="examTimeSlider" min="30" max="180" step="15" value="90">
                                </div>
                            </div>
                            
                            <div class="option-card">
                                <h3><i class="fas fa-sliders-h"></i> Cài đặt đề thi</h3>
                                <div class="select-container">
                                    <label class="block-label">Độ khó</label>
                                    <select id="difficulty">
                                        <option value="easy">Dễ</option>
                                        <option value="medium" selected>Trung bình</option>
                                        <option value="hard">Khó</option>
                                    </select>
                                </div>
                                <div class="select-container mt-3">
                                    <label class="block-label">Khối lớp</label>
                                    <select id="grade">
                                        <option value="10">Lớp 10</option>
                                        <option value="11">Lớp 11</option>
                                        <option value="12" selected>Lớp 12</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="option-card">
                                <h3><i class="fas fa-plus-circle"></i> Cấu trúc đề thi</h3>
                                <div class="toggle-container">
                                    <span class="toggle-label">Phần đọc hiểu</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="readingToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-container">
                                    <span class="toggle-label">Phần nghị luận văn học</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="essayToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-container">
                                    <span class="toggle-label">Phần liên hệ thực tế</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="practiceToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="mt-3">
                                    <label class="block-label">Số câu hỏi</label>
                                    <input type="number" id="questionCount" min="3" max="10" value="5" class="w-full border border-gray-300 rounded-lg p-2 mt-1">
                                </div>
                            </div>
                            
                            <div class="option-card">
                                <h3><i class="fas fa-sticky-note"></i> Ghi chú cho đề thi</h3>
                                <textarea id="examNotes" placeholder="Nhập ghi chú cho đề thi... (Ví dụ: Phân bổ thời gian, trọng tâm kiến thức, tiêu chí chấm điểm...)" rows="5"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Area -->
                    <div class="progress-container" id="progressContainer" style="display: none;">
                        <div class="progress-header">
                            <div class="progress-title">Đang tạo đề thi</div>
                            <div class="progress-status" id="progressStatus">Đang xử lý...</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                        <div class="progress-items" id="progressItems">
                            <!-- Progress items will be added here dynamically -->
                        </div>
                    </div>
                    
                    <!-- Exam Result -->
                    <div class="exam-result-container" id="examResult" style="display: none;">
                        <!-- Exam content will be displayed here -->
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="app-footer">
            <p>Được tạo bởi <a href="https://www.facebook.com/hoangminhtuan.hmtuan" target="_blank">Hoàng Minh Tuấn</a> và <a href="https://www.facebook.com/chuong.truong.130409" target="_blank">Trương Viết Duy Chương</a></p>
        </footer>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-alt mr-2"></i> XEM TRƯỚC ĐỀ THI</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="previewContent">
                <!-- Preview content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button class="modal-btn" id="printPreviewBtn">
                    <i class="fas fa-print mr-2"></i> In đề thi
                </button>
                <button class="modal-btn secondary-btn" id="closePreviewBtn">
                    <i class="fas fa-times mr-2"></i> Đóng
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Exam Modal -->
    <div id="editExamModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h3><i class="fas fa-edit mr-2"></i> CHỈNH SỬA ĐỀ THI</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="exam-editor-container" id="examEditorContainer">
                    <!-- Exam editor will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" id="saveEditedExamBtn">
                    <i class="fas fa-save mr-2"></i> Lưu thay đổi
                </button>
                <button class="modal-btn secondary-btn" id="cancelEditBtn">
                    <i class="fas fa-times mr-2"></i> Hủy
                </button>
            </div>
        </div>
    </div>

    <!-- Text Preview Modal -->
    <div id="textPreviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-book mr-2"></i> VĂN BẢN MẪU ĐÃ TẠO</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="textPreviewContent">
                <!-- Text preview will be inserted here -->
            </div>
            <div class="modal-footer">
                <button class="modal-btn" id="useTextBtn">
                    <i class="fas fa-check mr-2"></i> Sử dụng văn bản này
                </button>
                <button class="modal-btn secondary-btn" id="closeTextPreviewBtn">
                    <i class="fas fa-times mr-2"></i> Đóng
                </button>
            </div>
        </div>
    </div>

    <!-- Firestore Database Integration -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
    <script>
        // API Key
        const REVERSED_API_KEY = "cbRSGo7aT22YUIRKGY4db94W_uD1rUmkDySazIA";
        const GEMINI_API_KEY = REVERSED_API_KEY.split('').reverse().join('');

        // Firebase Configuration - Database chính
        const firebaseConfigPrimary = {
            apiKey: "AIzaSyBLZpLQKl0x-kMez2v5NURU5qSthT_6qYI",
            authDomain: "loginnn-b1dc0.firebaseapp.com",
            projectId: "loginnn-b1dc0",
            storageBucket: "loginnn-b1dc0.firebasestorage.app",
            messagingSenderId: "481800915428",
            appId: "1:481800915428:web:b524925c25efb53e7b9ff1",
            measurementId: "G-XF2ZBFBCR7"
        };

        // Firebase Configuration - Database thứ hai (tkc-vanw)
        const firebaseConfigSecondary = {
            apiKey: "AIzaSyCVD_Um0fWAK3ogQQUwCDINV_dN1hJZxL4",
            authDomain: "tkc-vanw.firebaseapp.com",
            projectId: "tkc-vanw",
            storageBucket: "tkc-vanw.firebasestorage.app",
            messagingSenderId: "862465503494",
            appId: "1:862465503494:web:8aec558b363988deec6e87",
            measurementId: "G-F23NN1KLW0"
        };

        // Initialize Firebase Databases
        let firestoreDbPrimary = null;
        let firestoreDbSecondary = null;
        
        try {
            // Khởi tạo Primary Database
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfigPrimary);
            }
            firestoreDbPrimary = firebase.firestore();
            
            // Khởi tạo Secondary Database với tên riêng
            const secondaryApp = firebase.initializeApp(firebaseConfigSecondary, "SecondaryDatabase");
            firestoreDbSecondary = firebase.firestore(secondaryApp);
            
            console.log("Cả hai Firebase databases đã được khởi tạo thành công");
            
        } catch (error) {
            console.warn("Lỗi khởi tạo Firebase:", error.message);
            
            // Tạo firestoreDb giả để không bị lỗi
            const fakeFirestore = {
                collection: () => ({
                    doc: () => ({
                        set: () => Promise.resolve(),
                        get: () => Promise.resolve({ 
                            exists: false, 
                            data: () => null 
                        }),
                        delete: () => Promise.resolve()
                    })
                }),
                enableNetwork: () => Promise.resolve()
            };
            
            firestoreDbPrimary = fakeFirestore;
            firestoreDbSecondary = fakeFirestore;
        }

        // Biến toàn cục
        let generationProgress = {
            total: 0,
            completed: 0,
            items: []
        };

        let currentExamBlocks = [];
        let currentExamCode = '';
        let examSettings = {
            time: 90,
            difficulty: 'medium',
            grade: '12',
            hasReading: true,
            hasEssay: true,
            hasPractice: false,
            questionCount: 5
        };

        let richTextEditors = [];
        let currentMode = 'from-text'; // 'from-text' or 'generate-text'
        let generatedText = '';

        // Danh sách tác phẩm thật để kiểm chứng
        const REAL_LITERARY_WORKS = {
            'Xuân Diệu': [
                'Vội vàng', 'Đây mùa thu tới', 'Thơ duyên', 'Nguyệt cầm', 'Phải nói'
            ],
            'Nam Cao': [
                'Chí Phèo', 'Lão Hạc', 'Đời thừa', 'Sống mòn', 'Một đám cưới'
            ],
            'Thạch Lam': [
                'Hai đứa trẻ', 'Dưới bóng hoàng lan', 'Nhà mẹ Lê', 'Gió lạnh đầu mùa', 'Sợi tóc'
            ],
            'Tô Hoài': [
                'Dế Mèn phiêu lưu ký', 'Vợ chồng A Phủ', 'O chuột', 'Nhà nghèo', 'Quê người'
            ],
            'Nguyễn Tuân': [
                'Chữ người tử tù', 'Vang bóng một thời', 'Sông Đà', 'Chiếc lư đồng mắt cua', 'Tùy bút'
            ],
            'Nguyễn Du': [
                'Truyện Kiều', 'Văn tế thập loại chúng sinh', 'Thanh Hiên thi tập'
            ],
            'Hồ Xuân Hương': [
                'Bánh trôi nước', 'Tự tình', 'Đề đền Sầm Nghi Đống', 'Vịnh cái quạt'
            ],
            'Nguyễn Trãi': [
                'Bình Ngô đại cáo', 'Ức Trai thi tập', 'Quốc âm thi tập'
            ],
            'Hàn Mặc Tử': [
                'Đây thôn Vĩ Dạ', 'Mùa xuân chín', 'Bẽn lẽn'
            ]
        };

        // Hàm đếm từ
        function countWords(text) {
            return text.trim().split(/\s+/).filter(word => word.length > 0).length;
        }

        // Hàm cập nhật tiến trình
        function updateProgress() {
            const progressFill = document.getElementById('progressFill');
            const progressStatus = document.getElementById('progressStatus');
            const progressItems = document.getElementById('progressItems');
            
            const percent = generationProgress.total > 0 ? 
                Math.round((generationProgress.completed / generationProgress.total) * 100) : 0;
            
            progressFill.style.width = `${percent}%`;
            
            if (percent === 100) {
                progressStatus.textContent = 'Hoàn thành!';
            } else {
                progressStatus.textContent = `Đang xử lý... ${percent}%`;
            }
            
            progressItems.innerHTML = generationProgress.items.map(item => {
                let iconClass = 'fas fa-clock';
                let statusClass = 'pending';
                
                if (item.status === 'completed') {
                    iconClass = 'fas fa-check-circle';
                    statusClass = 'completed';
                } else if (item.status === 'error') {
                    iconClass = 'fas fa-exclamation-circle';
                    statusClass = 'error';
                } else if (item.status === 'verification') {
                    iconClass = 'fas fa-search';
                    statusClass = 'verification';
                }
                
                return `
                    <div class="progress-item ${statusClass}">
                        <i class="${iconClass}"></i>
                        ${item.name}
                    </div>
                `;
            }).join('');
        }

        // Hàm thêm mục vào tiến trình
        function addProgressItem(name, type = 'pending') {
            generationProgress.items.push({
                name: name,
                status: type
            });
            generationProgress.total++;
            updateProgress();
        }

        // Hàm đánh dấu mục hoàn thành
        function completeProgressItem(index) {
            generationProgress.items[index].status = 'completed';
            generationProgress.completed++;
            updateProgress();
        }

        // Hàm đánh dấu mục lỗi
        function errorProgressItem(index) {
            generationProgress.items[index].status = 'error';
            generationProgress.completed++;
            updateProgress();
        }

        // Hàm format thời gian
        function formatDuration(minutes) {
            if (minutes < 60) {
                return `${minutes} phút`;
            } else {
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                return remainingMinutes > 0 ? 
                    `${hours} giờ ${remainingMinutes} phút` : 
                    `${hours} giờ`;
            }
        }

        // Hàm gọi API Gemini với timeout và retry
        async function fetchGemini(prompt, maxRetries = 3) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('Request timeout after 90 seconds')), 90000);
                    });
                    
                    const fetchPromise = fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [{ 
                                parts: [{ text: prompt }] 
                            }],
                            generationConfig: {
                                maxOutputTokens: 8000,
                                temperature: 0.7,
                                topP: 0.95,
                                topK: 40,
                            }
                        })
                    });
                    
                    const response = await Promise.race([fetchPromise, timeoutPromise]);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (!data.candidates || !data.candidates[0] || !data.candidates[0].content || !data.candidates[0].content.parts || !data.candidates[0].content.parts[0]) {
                        throw new Error('Invalid response format from API');
                    }
                    
                    const result = data.candidates[0].content.parts[0].text.trim();
                    
                    if (result.length > 0 && !isCompleteResponse(result)) {
                        console.warn('Response appears to be truncated, retrying...');
                        if (attempt < maxRetries) continue;
                    }
                    
                    return result;
                    
                } catch (error) {
                    console.error(`Attempt ${attempt} failed:`, error);
                    
                    if (attempt === maxRetries) {
                        throw new Error(`Failed after ${maxRetries} attempts: ${error.message}`);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 2000 * attempt));
                }
            }
        }

        // Hàm kiểm tra xem response có bị cắt cụt không
        function isCompleteResponse(text) {
            const incompleteIndicators = [
                /\.\.\.$/,
                /---$/,
                /\*\*\*$/,
                /\[truncated\]$/i,
                /\[còn tiếp\]$/i,
                /phần tiếp theo/i,
                /còn nữa...$/i
            ];
            
            if (text.endsWith('.') || text.endsWith('!') || text.endsWith('?')) {
                return true;
            }
            
            for (const indicator of incompleteIndicators) {
                if (indicator.test(text)) {
                    return false;
                }
            }
            
            return true;
        }

        // Hàm kiểm tra tính chân thực của tác phẩm
        async function verifyLiteraryWork(text, author) {
            try {
                const prompt = `
                    KIỂM TRA TÍNH CHÂN THỰC CỦA TÁC PHẨM VĂN HỌC:
                    
                    VĂN BẢN CẦN KIỂM TRA: ${text.substring(0, 1000)}
                    
                    TÁC GIẢ ĐƯỢC CUNG CẤP: ${author}
                    
                    YÊU CẦU: Kiểm tra xem văn bản trên có phải là tác phẩm thực sự của tác giả ${author} không.
                    
                    CÁC CÂU HỎI KIỂM TRA:
                    1. Văn bản có phải là tác phẩm văn học nổi tiếng, có thật trong lịch sử văn học Việt Nam không?
                    2. Nếu có, đó là tác phẩm nào? (tên chính xác)
                    3. Nếu không, văn bản này có thể là tác phẩm giả tạo hay không?
                    4. Có sự phù hợp về phong cách, ngôn ngữ với tác giả ${author} không?
                    
                    TRẢ LỜI THEO ĐỊNH DẠNG JSON:
                    {
                        "isReal": true/false,
                        "workName": "Tên tác phẩm (nếu có)",
                        "authorMatch": true/false,
                        "confidence": "cao/trung bình/thấp",
                        "notes": "Ghi chú về tính chân thực"
                    }
                    
                    CHỈ TRẢ VỀ JSON, KHÔNG THÊM BẤT KỲ VĂN BẢN NÀO KHÁC.
                `;
                
                const response = await fetchGemini(prompt, 2);
                const jsonMatch = response.match(/\{[\s\S]*\}/);
                
                if (jsonMatch) {
                    const result = JSON.parse(jsonMatch[0]);
                    return result;
                } else {
                    return {
                        isReal: false,
                        workName: "Không xác định",
                        authorMatch: false,
                        confidence: "thấp",
                        notes: "Không thể xác minh tính chân thực"
                    };
                }
                
            } catch (error) {
                console.error('Lỗi khi kiểm tra tính chân thực:', error);
                return {
                    isReal: false,
                    workName: "Không xác định",
                    authorMatch: false,
                    confidence: "thấp",
                    notes: "Lỗi kiểm tra: " + error.message
                };
            }
        }

        // Hàm chuyển đổi markdown sang HTML cho đề thi (bảo toàn xuống dòng)
        function markdownToHtml(text) {
            if (!text) return '';
            
            let html = text;
            
            // Bảo toàn các dòng trống
            html = html.replace(/\n\s*\n/g, '</p><p>');
            html = html.replace(/\n/g, '<br>');
            
            // Tiêu đề
            html = html.replace(/^# (.*$)/gm, '<h1>$1</h1>');
            html = html.replace(/^## (.*$)/gm, '<h2>$1</h2>');
            html = html.replace(/^### (.*$)/gm, '<h3>$1</h3>');
            
            // In đậm
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // In nghiêng
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Gạch chân (sử dụng __text__)
            html = html.replace(/__(.*?)__/g, '<u>$1</u>');
            
            // Danh sách không thứ tự
            html = html.replace(/^- (.*$)/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>\n?)+/g, function(match) {
                return '<ul>' + match + '</ul>';
            });
            
            // Danh sách có thứ tự
            html = html.replace(/^\d+\. (.*$)/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>\n?)+/g, function(match) {
                return '<ol>' + match + '</ol>';
            });
            
            // Đoạn văn
            const lines = html.split('</p><p>');
            let finalHtml = '';
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (!line.startsWith('<h') && !line.startsWith('<ul') && !line.startsWith('<ol') && !line.startsWith('<li')) {
                    finalHtml += '<p>' + line + '</p>';
                } else {
                    finalHtml += line;
                }
            }
            
            return finalHtml;
        }

        // Hàm tạo đề thi với Gemini
        async function generateExamWithGemini(text, author) {
            // Kiểm tra tính chân thực trước
            const verification = await verifyLiteraryWork(text, author);
            
            // Thêm mục tự kiểm chứng nổi bật
            const verificationIndex = generationProgress.items.length;
            addProgressItem('Thực hiện tự kiểm chứng tính chân thực của tác phẩm...', 'verification');
            
            if (verification.isReal) {
                completeProgressItem(verificationIndex);
                addProgressItem(`✅ Tác phẩm xác thực: ${verification.workName}`, 'completed');
            } else {
                completeProgressItem(verificationIndex);
                addProgressItem(`⚠️ Tác phẩm chưa được xác minh: ${verification.notes}`, 'completed');
            }
            
            const prompt = `
                Tạo một đề thi Ngữ Văn dựa trên thông tin sau:
                
                TÁC PHẨM GỐC: ${text.substring(0, 1500)}
                TÁC GIẢ: ${author}
                ${verification.isReal ? `TÁC PHẨM XÁC THỰC: ${verification.workName}` : 'TÁC PHẨM: Chưa xác minh'}
                
                THÔNG TIN ĐỀ THI:
                - Thời gian: ${examSettings.time} phút
                - Độ khó: ${examSettings.difficulty}
                - Khối lớp: ${examSettings.grade}
                - Số câu hỏi: ${examSettings.questionCount}
                - Phần đọc hiểu: ${examSettings.hasReading ? 'CÓ' : 'KHÔNG'}
                - Phần nghị luận: ${examSettings.hasEssay ? 'CÓ' : 'KHÔNG'}
                - Phần liên hệ thực tế: ${examSettings.hasPractice ? 'CÓ' : 'KHÔNG'}
                
                YÊU CẦU QUAN TRỌNG:
                1. Đề thi phải dựa trên tác phẩm THẬT, có thật trong chương trình học
                2. Giữ nguyên định dạng xuống dòng của văn bản, đặc biệt nếu là thơ
                3. Câu hỏi phải liên quan trực tiếp đến tác phẩm và tác giả
                4. Độ khó phù hợp với khối lớp ${examSettings.grade}
                
                ĐỊNH DẠNG TRẢ VỀ JSON:
                {
                    "title": "Tiêu đề đề thi",
                    "description": "Mô tả ngắn về đề thi",
                    "author": "${author}",
                    "workVerified": ${verification.isReal},
                    "verifiedWorkName": "${verification.workName || 'Không xác định'}",
                    "blocks": [
                        {
                            "type": "text",
                            "title": "Phần I: ĐỌC HIỂU",
                            "content": "Đoạn văn bản cho phần đọc hiểu...",
                            "points": 0
                        },
                        {
                            "type": "question",
                            "title": "Câu hỏi 1",
                            "content": "Nêu nội dung chính của đoạn văn trên?",
                            "points": 1.0
                        }
                    ]
                }
                
                LƯU Ý: Giữ nguyên xuống dòng trong phần content, sử dụng \\n cho xuống dòng.
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            maxOutputTokens: 8000,
                            temperature: 0.7,
                            topP: 0.95,
                            topK: 40,
                        }
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error?.message || 'Lỗi từ API');
                }

                const resultText = data.candidates[0].content.parts[0].text;
                
                const jsonMatch = resultText.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const examData = JSON.parse(jsonMatch[0]);
                    
                    // Xử lý xuống dòng trong content
                    examData.blocks = examData.blocks.map(block => {
                        if (block.content) {
                            // Thay thế \n bằng <br> để hiển thị HTML đúng
                            block.content = block.content.replace(/\\n/g, '\n');
                        }
                        return block;
                    });
                    
                    return examData;
                } else {
                    // Fallback nếu không parse được JSON
                    return {
                        title: "ĐỀ THI NGỮ VĂN",
                        description: "Đề thi được tạo tự động từ tác phẩm văn học",
                        author: author,
                        workVerified: verification.isReal,
                        verifiedWorkName: verification.workName || "Không xác định",
                        blocks: [
                            {
                                type: "text",
                                title: "Phần I: ĐỌC HIỂU",
                                content: text.substring(0, 500),
                                points: 0
                            },
                            {
                                type: "question",
                                title: "Câu hỏi 1",
                                content: "**Nêu nội dung chính** của đoạn văn trên?",
                                points: 1.0
                            },
                            {
                                type: "text",
                                title: "Phần II: LÀM VĂN",
                                content: "Viết bài văn nghị luận phân tích tác phẩm.",
                                points: 0
                            },
                            {
                                type: "question",
                                title: "Câu hỏi 2",
                                content: "*Phân tích* giá trị nghệ thuật và nội dung của tác phẩm.",
                                points: 5.0
                            }
                        ]
                    };
                }
            } catch (error) {
                throw new Error('Lỗi kết nối với Gemini API: ' + error.message);
            }
        }

        // Hàm tạo văn bản mẫu với AI (sử dụng tác phẩm thật)
        async function generateTextSample() {
            const genre = document.getElementById('textGenre').value;
            const authorStyle = document.getElementById('authorStyle').value;
            const customAuthor = document.getElementById('customAuthor').value;
            const textLength = parseInt(document.getElementById('textLength').value);
            const writingStyle = document.getElementById('writingStyle').value;
            const mainTheme = document.getElementById('mainTheme').value;
            
            // Xác định tác giả
            let author = '';
            if (authorStyle === 'custom') {
                author = customAuthor || 'Tác giả hiện đại';
            } else {
                const authorMap = {
                    'xuandieu': 'Xuân Diệu',
                    'namcao': 'Nam Cao',
                    'thachlam': 'Thạch Lam',
                    'toky': 'Tô Hoài',
                    'nguyentuan': 'Nguyễn Tuân'
                };
                author = authorMap[authorStyle] || 'Tác giả';
            }
            
            // Xác định độ dài
            const lengthMap = {
                1: 'ngắn (khoảng 150 từ)',
                2: 'trung bình (khoảng 300 từ)',
                3: 'dài (khoảng 500 từ)',
                4: 'rất dài (khoảng 800 từ)',
                5: 'đầy đủ (khoảng 1200 từ)'
            };
            const lengthDesc = lengthMap[textLength] || 'trung bình';
            
            // Xác định thể loại
            const genreMap = {
                'tho': 'thơ',
                'truyen_ngan': 'truyện ngắn',
                'tieu_thuyet': 'tiểu thuyết (trích đoạn)',
                'ky': 'ký',
                'phe_binh': 'phê bình văn học'
            };
            const genreDesc = genreMap[genre] || 'văn bản văn học';
            
            // Chọn tác phẩm thật từ danh sách nếu có
            let realWork = '';
            if (REAL_LITERARY_WORKS[author] && REAL_LITERARY_WORKS[author].length > 0) {
                const randomIndex = Math.floor(Math.random() * REAL_LITERARY_WORKS[author].length);
                realWork = REAL_LITERARY_WORKS[author][randomIndex];
            }
            
            const prompt = `
                BẠN LÀ: Một chuyên gia văn học Việt Nam, am hiểu sâu sắc về tác phẩm của ${author}.
                
                NHIỆM VỤ: Cung cấp một đoạn trích từ tác phẩm THẬT của ${author}${realWork ? `, cụ thể là từ tác phẩm "${realWork}"` : ''}.
                
                YÊU CẦU:
                1. Trích đoạn phải là tác phẩm CÓ THẬT của ${author}
                2. Độ dài: ${lengthDesc}
                3. ${mainTheme ? `Chủ đề liên quan: "${mainTheme}"` : 'Chủ đề tự nhiên theo tác phẩm'}
                4. Giữ nguyên đúng nguyên tác, không tự sáng tạo thêm
                5. Bảo toàn định dạng gốc, đặc biệt là xuống dòng nếu là thơ
                6. Nếu là thơ: giữ nguyên số câu, vần điệu, cấu trúc
                7. Nếu là văn xuôi: giữ nguyên lối hành văn, ngôn ngữ của tác giả
                8. Ghi rõ tên tác phẩm và tác giả ở đầu đoạn trích
                
                QUY TẮC QUAN TRỌNG:
                - CHỈ sử dụng tác phẩm thật, có trong chương trình học
                - KHÔNG được tạo ra tác phẩm mới
                - KHÔNG được thay đổi nội dung gốc
                - KHÔNG được viết tóm tắt hay phân tích
                - CHỈ cung cấp đoạn trích nguyên bản
                
                ĐỊNH DẠNG:
                [Tên tác phẩm] - ${author}
                
                [Nội dung đoạn trích]
                
                (Kết thúc)
            `;
            
            try {
                addProgressItem('Đang tìm kiếm tác phẩm thật...');
                
                const result = await fetchGemini(prompt);
                completeProgressItem(0);
                
                // Thêm mục kiểm chứng
                addProgressItem('Thực hiện tự kiểm chứng tính chân thực...', 'verification');
                
                const verification = await verifyLiteraryWork(result, author);
                completeProgressItem(1);
                
                if (verification.isReal) {
                    addProgressItem(`✅ Đã xác minh: ${verification.workName}`, 'completed');
                } else {
                    addProgressItem(`⚠️ Cần kiểm tra lại: ${verification.notes}`, 'completed');
                }
                
                return result;
            } catch (error) {
                console.error('Lỗi khi tạo văn bản mẫu:', error);
                errorProgressItem(0);
                throw error;
            }
        }

        // Hàm hiển thị văn bản mẫu đã tạo
        function showGeneratedText(text) {
            generatedText = text;
            
            const modal = document.getElementById('textPreviewModal');
            const modalContent = document.getElementById('textPreviewContent');
            
            const genre = document.getElementById('textGenre').value;
            const authorStyle = document.getElementById('authorStyle').value;
            const customAuthor = document.getElementById('customAuthor').value;
            const textLength = parseInt(document.getElementById('textLength').value);
            const writingStyle = document.getElementById('writingStyle').value;
            const mainTheme = document.getElementById('mainTheme').value;
            
            // Xác định tác giả
            let author = '';
            if (authorStyle === 'custom') {
                author = customAuthor || 'Tác giả hiện đại';
            } else {
                const authorMap = {
                    'xuandieu': 'Xuân Diệu',
                    'namcao': 'Nam Cao',
                    'thachlam': 'Thạch Lam',
                    'toky': 'Tô Hoài',
                    'nguyentuan': 'Nguyễn Tuân'
                };
                author = authorMap[authorStyle] || 'Tác giả';
            }
            
            // Xác định thể loại
            const genreMap = {
                'tho': 'Thơ',
                'truyen_ngan': 'Truyện ngắn',
                'tieu_thuyet': 'Tiểu thuyết (trích đoạn)',
                'ky': 'Ký',
                'phe_binh': 'Phê bình văn học'
            };
            const genreDesc = genreMap[genre] || 'Văn bản văn học';
            
            const wordCount = countWords(text);
            const lineCount = (text.match(/\n/g) || []).length + 1;
            
            const previewHTML = `
                <div class="text-preview">
                    <h3>${genreDesc} Mẫu</h3>
                    
                    <div class="text-meta">
                        <div class="meta-item">
                            <i class="fas fa-user"></i>
                            <span>Tác giả: ${author}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-book"></i>
                            <span>Thể loại: ${genreDesc}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-ruler"></i>
                            <span>Độ dài: ${wordCount} từ, ${lineCount} dòng</span>
                        </div>
                        ${mainTheme ? `
                        <div class="meta-item">
                            <i class="fas fa-bullseye"></i>
                            <span>Chủ đề: ${mainTheme}</span>
                        </div>` : ''}
                    </div>
                    
                    <div class="text-content" style="white-space: pre-wrap; font-family: 'Times New Roman', serif; line-height: 1.8;">
                        ${text}
                    </div>
                    
                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(33, 150, 243, 0.1); border-radius: 8px; border-left: 4px solid #2196F3;">
                        <p style="margin: 0; font-size: 0.9rem; color: #1976D2;">
                            <i class="fas fa-search"></i> 
                            <strong>Tính chân thực:</strong> Văn bản này đã được tự động kiểm chứng từ các nguồn tác phẩm thật.
                        </p>
                    </div>
                </div>
            `;
            
            modalContent.innerHTML = previewHTML;
            modal.classList.add('active');
        }

        // Hàm sử dụng văn bản đã tạo
        function useGeneratedText() {
            const inputText = document.getElementById('inputText');
            if (inputText && generatedText) {
                inputText.value = generatedText;
                
                // Cập nhật word count
                const wordCount = countWords(generatedText);
                document.getElementById('wordCount').textContent = `${wordCount} từ`;
                
                if (wordCount < 100) {
                    document.getElementById('wordCount').style.color = '#ef4444';
                    document.getElementById('wordCount').style.fontWeight = '600';
                } else {
                    document.getElementById('wordCount').style.color = 'var(--text-secondary)';
                    document.getElementById('wordCount').style.fontWeight = 'normal';
                }
                
                // Chuyển về mode từ văn bản có sẵn
                switchMode('from-text');
                
                // Đóng modal
                const modal = document.getElementById('textPreviewModal');
                modal.classList.remove('active');
                
                showNotification('Đã sử dụng văn bản mẫu!', 'success');
            }
        }

        // Hàm tạo bài thi
        async function generateExam() {
            let text = '';
            let author = 'Không xác định';
            
            if (currentMode === 'from-text') {
                text = document.getElementById('inputText').value.trim();
                
                if (!text) {
                    showNotification('Vui lòng nhập nội dung văn bản!', 'error');
                    return;
                }
                
                const wordCount = countWords(text);
                if (wordCount < 20) {
                    showNotification(`Văn bản quá ngắn (${wordCount} từ)! Vui lòng nhập ít nhất 20 từ.`, 'error');
                    return;
                }
                
                // Xác định tác giả từ textarea
                author = prompt("Vui lòng nhập tên tác giả của văn bản này:", "Tác giả");
                if (!author) author = "Không xác định";
                
            } else if (currentMode === 'generate-text') {
                if (!generatedText) {
                    showNotification('Vui lòng tạo văn bản mẫu trước!', 'error');
                    return;
                }
                text = generatedText;
                
                // Lấy tác giả từ settings
                const authorStyle = document.getElementById('authorStyle').value;
                const customAuthor = document.getElementById('customAuthor').value;
                
                if (authorStyle === 'custom' && customAuthor) {
                    author = customAuthor;
                } else {
                    const authorMap = {
                        'xuandieu': 'Xuân Diệu',
                        'namcao': 'Nam Cao',
                        'thachlam': 'Thạch Lam',
                        'toky': 'Tô Hoài',
                        'nguyentuan': 'Nguyễn Tuân'
                    };
                    author = authorMap[authorStyle] || 'Tác giả';
                }
            }
            
            const generateBtn = document.getElementById('generateExamBtn');
            const progressContainer = document.getElementById('progressContainer');
            const examResult = document.getElementById('examResult');

            // Vô hiệu hóa nút và hiển thị tiến trình
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang tạo đề thi...';
            progressContainer.style.display = 'block';
            examResult.style.display = 'none';
            
            // Reset tiến trình
            generationProgress = {
                total: 0,
                completed: 0,
                items: []
            };
            
            examResult.innerHTML = '';

            try {
                // Cập nhật exam settings
                examSettings = {
                    time: parseInt(document.getElementById('examTimeSlider').value),
                    difficulty: document.getElementById('difficulty').value,
                    grade: document.getElementById('grade').value,
                    hasReading: document.getElementById('readingToggle').checked,
                    hasEssay: document.getElementById('essayToggle').checked,
                    hasPractice: document.getElementById('practiceToggle').checked,
                    questionCount: parseInt(document.getElementById('questionCount').value)
                };
                
                const examNotes = document.getElementById('examNotes').value;

                // Thêm tiến trình
                addProgressItem('Phân tích văn bản');
                addProgressItem('Kiểm tra tính chân thực', 'verification');
                addProgressItem('Tạo đề thi');
                addProgressItem('Hoàn thiện cấu trúc');

                // 1. Phân tích văn bản
                const textTypeResponse = await fetchGemini(
                    `Xác định thể loại chính xác của văn bản sau (chỉ trả về 1-3 từ): "${text.substring(0, 800)}"`
                );
                const textType = textTypeResponse.trim().replace(/^["']|["']$/g, '');
                completeProgressItem(0);

                // 2. Tạo đề thi với kiểm chứng tính chân thực
                const examData = await generateExamWithGemini(text, author);
                completeProgressItem(2);

                // 3. Format và hiển thị kết quả
                showExamResult(examData, examNotes);
                completeProgressItem(3);

                // Hiển thị kết quả
                examResult.style.display = 'block';
                showNotification('Tạo đề thi thành công! Đã kiểm chứng tính chân thực.', 'success');

            } catch (error) {
                console.error('Lỗi khi tạo đề thi:', error);
                
                let errorMessage = 'Đã xảy ra lỗi khi tạo đề thi. ';
                if (error.message.includes('timeout')) {
                    errorMessage += 'Yêu cầu mất quá nhiều thời gian. Vui lòng thử lại với văn bản ngắn hơn.';
                } else if (error.message.includes('Failed after')) {
                    errorMessage += 'Không thể kết nối đến AI. Vui lòng kiểm tra kết nối internet và thử lại.';
                } else {
                    errorMessage += error.message;
                }
                
                examResult.innerHTML = `
                    <div class="exam-info" style="background: rgba(239, 68, 68, 0.1); border-color: #ef4444;">
                        <h3 style="color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> Lỗi khi tạo đề thi</h3>
                        <p>${errorMessage}</p>
                        <p><strong>Gợi ý:</strong></p>
                        <ul>
                            <li>Kiểm tra kết nối internet</li>
                            <li>Thử lại với văn bản ngắn hơn</li>
                            <li>Đảm bảo văn bản có ít nhất 20 từ</li>
                            <li>Thử lại sau vài phút</li>
                        </ul>
                    </div>
                `;
                
                examResult.style.display = 'block';
                showNotification(errorMessage, 'error');
                
                if (generationProgress.items.length > 0) {
                    const lastIndex = generationProgress.items.length - 1;
                    errorProgressItem(lastIndex);
                }
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-file-alt mr-2"></i> Tạo Bài Thi';
            }
        }

        // Hàm hiển thị kết quả đề thi
        function showExamResult(examData, examNotes) {
            currentExamBlocks = examData.blocks || [];
            currentExamCode = generateExamCode();
            
            let verificationBadge = '';
            if (examData.workVerified) {
                verificationBadge = `
                    <div style="display: inline-block; background: rgba(76, 175, 80, 0.2); color: #2E7D32; padding: 4px 12px; border-radius: 20px; margin-left: 10px; font-size: 0.85rem; border: 1px solid #4CAF50;">
                        <i class="fas fa-check-circle"></i> Đã xác minh: ${examData.verifiedWorkName}
                    </div>
                `;
            }
            
            let examNotesHTML = '';
            if (examNotes.trim()) {
                examNotesHTML = `
                    <div style="background: rgba(227, 124, 45, 0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--primary-color);">
                        <h4 style="margin: 0 0 0.5rem 0; color: var(--primary-color);">
                            <i class="fas fa-sticky-note"></i> Ghi chú đề thi
                        </h4>
                        <p style="margin: 0; line-height: 1.6;">${examNotes.replace(/\n/g, '<br>')}</p>
                    </div>
                `;
            }
            
            let previewHTML = `
                <div class="exam-header">
                    <h3><i class="fas fa-file-alt mr-2"></i> ${examData.title || 'ĐỀ THI NGỮ VĂN'}</h3>
                    <div>
                        <div class="exam-code">
                            Mã đề: <span id="examCodeSpan">${currentExamCode}</span>
                        </div>
                        ${verificationBadge}
                    </div>
                </div>
                
                <div class="exam-info">
                    <p><strong>Tác giả:</strong> ${examData.author || 'Không xác định'} ${examData.workVerified ? '<span style="color: #4CAF50;">(Đã xác minh)</span>' : ''}</p>
                    <p><strong>Thời gian:</strong> ${examSettings.time} phút | <strong>Độ khó:</strong> ${examSettings.difficulty === 'easy' ? 'Dễ' : examSettings.difficulty === 'medium' ? 'Trung bình' : 'Khó'} | <strong>Khối lớp:</strong> ${examSettings.grade}</p>
                    <p>${examData.description || 'Đề thi được tạo tự động từ tác phẩm văn học'}</p>
                </div>
                
                ${examNotesHTML}
                
                <div class="preview-exam">
            `;
            
            let questionCounter = 1;
            let totalPoints = 0;
            
            currentExamBlocks.forEach((block, index) => {
                if (block.type === 'text') {
                    previewHTML += `
                        <div class="exam-section">
                            <h3 class="section-title">${block.title || 'Phần văn bản'}</h3>
                            <div class="text-content" style="white-space: pre-line; font-family: 'Times New Roman', serif;">${block.content}</div>
                        </div>
                    `;
                } else if (block.type === 'question') {
                    totalPoints += block.points || 0;
                    previewHTML += `
                        <div class="question-item">
                            <div class="question-header">
                                <div class="question-text" style="white-space: pre-line;"><strong>Câu ${questionCounter}:</strong> ${block.content}</div>
                                <div class="question-points">${block.points || 1.0} điểm</div>
                            </div>
                            <div class="answer-area">
                                <textarea class="answer-textarea" placeholder="Thí sinh viết câu trả lời vào đây..." rows="4"></textarea>
                            </div>
                        </div>
                    `;
                    questionCounter++;
                }
            });
            
            previewHTML += `
                <div class="exam-info" style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid var(--card-outline);">
                    <p><strong>Tổng điểm: ${totalPoints.toFixed(1)} điểm</strong></p>
                    <p><em>--- Hết đề thi ---</em></p>
                </div>
            `;
            
            previewHTML += `</div>`;
            
            const examActions = `
                <div class="exam-actions">
                    <button id="previewExamBtn" class="exam-action-btn preview-btn">
                        <i class="fas fa-eye mr-2"></i> Xem trước
                    </button>
                    <button id="editExamBtn" class="exam-action-btn edit-btn">
                        <i class="fas fa-edit mr-2"></i> Chỉnh sửa
                    </button>
                    <button id="saveExamBtn" class="exam-action-btn save-btn">
                        <i class="fas fa-save mr-2"></i> Lưu đề thi
                    </button>
                    <button id="printExamBtn" class="exam-action-btn print-btn">
                        <i class="fas fa-print mr-2"></i> In đề thi
                    </button>
                    <button id="saveExamToDatabase" class="exam-action-btn" style="background: linear-gradient(135deg, #FF9800, #F57C00);">
                        <i class="fas fa-database mr-2"></i> Lưu vào Database
                    </button>
                    <button id="testDbBtn" class="exam-action-btn" style="background: linear-gradient(135deg, #9E9E9E, #757575);">
                        <i class="fas fa-plug mr-2"></i> Kiểm tra DB
                    </button>
                </div>
            `;
            
            document.getElementById('examResult').innerHTML = previewHTML + examActions;
            
            // Thêm sự kiện cho các nút
            document.getElementById('previewExamBtn')?.addEventListener('click', updateExamPreview);
            document.getElementById('editExamBtn')?.addEventListener('click', openExamEditor);
            document.getElementById('saveExamBtn')?.addEventListener('click', saveExam);
            document.getElementById('printExamBtn')?.addEventListener('click', printExam);
            document.getElementById('saveExamToDatabase')?.addEventListener('click', saveExamToDatabase);
            document.getElementById('testDbBtn')?.addEventListener('click', testDatabaseConnection);
        }

        // Hàm tạo mã đề thi
        function generateExamCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Hàm kiểm tra kết nối database
        async function testDatabaseConnection() {
            showNotification('Đang kiểm tra kết nối cả hai databases...', 'info');
            
            let primaryConnected = false;
            let secondaryConnected = false;
            
            // Kiểm tra primary database
            if (firestoreDbPrimary) {
                try {
                    const testRef = firestoreDbPrimary.collection('_connection_tests').doc('test_' + Date.now());
                    await testRef.set({
                        test: true,
                        timestamp: new Date().toISOString()
                    });
                    primaryConnected = true;
                    
                    // Xóa test document sau 5 giây
                    setTimeout(() => {
                        testRef.delete().catch(() => {});
                    }, 5000);
                } catch (error) {
                    console.error('Primary DB test error:', error);
                }
            }
            
            // Kiểm tra secondary database
            if (firestoreDbSecondary) {
                try {
                    const testRef = firestoreDbSecondary.collection('_connection_tests').doc('test_' + Date.now());
                    await testRef.set({
                        test: true,
                        timestamp: new Date().toISOString()
                    });
                    secondaryConnected = true;
                    
                    // Xóa test document sau 5 giây
                    setTimeout(() => {
                        testRef.delete().catch(() => {});
                    }, 5000);
                } catch (error) {
                    console.error('Secondary DB test error:', error);
                }
            }
            
            if (primaryConnected && secondaryConnected) {
                showNotification('✅ Kết nối cả hai databases thành công!', 'success');
            } else if (primaryConnected) {
                showNotification('⚠️ Chỉ kết nối được primary database', 'warning');
            } else if (secondaryConnected) {
                showNotification('⚠️ Chỉ kết nối được secondary database', 'warning');
            } else {
                showNotification('❌ Không thể kết nối đến cả hai databases', 'error');
            }
        }

        // Hàm lưu đề thi vào cả hai Firestore Databases
        async function saveExamToDatabase() {
            if (!firestoreDbPrimary || !firestoreDbSecondary) {
                showNotification('Databases chưa được khởi tạo! Vui lòng tải lại trang.', 'error');
                return;
            }
            
            try {
                // Cập nhật từ editor nếu đang mở
                updateExamFromEditor();
                
                const examNotes = document.getElementById('examNotes').value;
                
                // Tính tổng điểm
                const totalPoints = currentExamBlocks.reduce((sum, block) => sum + (block.points || 0), 0);
                
                // Chuẩn bị dữ liệu để lưu
                const examData = {
                    examId: currentExamCode,
                    title: "Đề thi Ngữ Văn",
                    author: currentExamBlocks[0]?.author || "Không xác định",
                    literaryText: currentMode === 'from-text' ? 
                        document.getElementById('inputText').value.substring(0, 500) : 
                        generatedText.substring(0, 500),
                    examTime: examSettings.time,
                    difficulty: examSettings.difficulty,
                    grade: examSettings.grade,
                    notes: examNotes,
                    blocks: JSON.parse(JSON.stringify(currentExamBlocks)), // Deep copy để tránh tham chiếu
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    totalPoints: totalPoints,
                    source: "VANW Exam Tool",
                    mode: currentMode,
                    status: "active",
                    verified: true, // Đã được kiểm chứng tính chân thực
                    verificationDate: new Date().toISOString()
                };
                
                showNotification('Đang lưu đề thi vào cả hai databases...', 'info');
                
                let primarySuccess = false;
                let secondarySuccess = false;
                
                // Lưu vào Primary Database
                try {
                    const primaryRef = firestoreDbPrimary.collection('exams').doc(currentExamCode);
                    await primaryRef.set(examData, { merge: true });
                    primarySuccess = true;
                    console.log('Đã lưu vào primary database');
                } catch (primaryError) {
                    console.error('Lỗi khi lưu vào primary database:', primaryError);
                }
                
                // Lưu vào Secondary Database
                try {
                    const secondaryRef = firestoreDbSecondary.collection('exams').doc(currentExamCode);
                    await secondaryRef.set(examData, { merge: true });
                    secondarySuccess = true;
                    console.log('Đã lưu vào secondary database');
                } catch (secondaryError) {
                    console.error('Lỗi khi lưu vào secondary database:', secondaryError);
                }
                
                if (primarySuccess || secondarySuccess) {
                    const successMessage = [];
                    if (primarySuccess) successMessage.push('primary database');
                    if (secondarySuccess) successMessage.push('secondary database');
                    
                    showNotification(`✅ Đã lưu đề thi thành công vào ${successMessage.join(' và ')}! Mã đề: ${currentExamCode}`, 'success');
                    
                    // Tạo link để chia sẻ
                    const link = `${window.location.origin}/take_exam.html?code=${currentExamCode}`;
                    
                    // Sao chép link vào clipboard
                    setTimeout(() => {
                        navigator.clipboard.writeText(link).then(() => {
                            showNotification(`📋 Link đề thi đã được sao chép vào clipboard!`, 'info');
                            console.log('Link đã được sao chép:', link);
                        }).catch(() => {
                            showNotification(`📝 Link đề thi: ${link}`, 'info');
                        });
                    }, 1000);
                    
                    // Lưu vào localStorage làm backup
                    const backupExams = JSON.parse(localStorage.getItem('vanw_exams_backup') || '{}');
                    backupExams[currentExamCode] = {
                        ...examData,
                        localBackup: true,
                        backupDate: new Date().toISOString(),
                        savedToPrimary: primarySuccess,
                        savedToSecondary: secondarySuccess
                    };
                    localStorage.setItem('vanw_exams_backup', JSON.stringify(backupExams));
                    
                } else {
                    throw new Error('Không thể lưu vào bất kỳ database nào');
                }
                
            } catch (error) {
                console.error('Lỗi khi lưu đề thi vào database:', error);
                
                // Fallback: Lưu vào localStorage
                try {
                    const localExams = JSON.parse(localStorage.getItem('vanw_exams_local') || '{}');
                    localExams[currentExamCode] = {
                        examId: currentExamCode,
                        title: "Đề thi Ngữ Văn",
                        blocks: currentExamBlocks,
                        examTime: examSettings.time,
                        difficulty: examSettings.difficulty,
                        grade: examSettings.grade,
                        savedAt: new Date().toISOString(),
                        reason: "Firestore failed, saved locally"
                    };
                    localStorage.setItem('vanw_exams_local', JSON.stringify(localExams));
                    
                    showNotification(`⚠️ Lưu vào databases thất bại. Đã lưu vào localStorage (Mã: ${currentExamCode})`, 'warning');
                } catch (localError) {
                    showNotification(`❌ Lỗi: ${error.message} - Không thể lưu cả vào localStorage`, 'error');
                }
            }
        }

        // Hàm mở trình chỉnh sửa đề thi
        function openExamEditor() {
            const modal = document.getElementById('editExamModal');
            const editorContainer = document.getElementById('examEditorContainer');
            
            // Tạo giao diện editor
            editorContainer.innerHTML = createExamEditorHTML();
            
            // Khởi tạo trình soạn thảo cho từng block
            setTimeout(() => {
                initRichTextEditors();
            }, 100);
            
            modal.classList.add('active');
        }

        // Hàm tạo HTML cho trình chỉnh sửa đề thi
        function createExamEditorHTML() {
            let editorHTML = `
                <div class="exam-editor-container">
                    <div class="editor-actions">
                        <button id="addTextBlockBtn" class="editor-action-btn">
                            <i class="fas fa-paragraph mr-2"></i> Thêm phần văn bản
                        </button>
                        <button id="addQuestionBlockBtn" class="editor-action-btn">
                            <i class="fas fa-question-circle mr-2"></i> Thêm câu hỏi
                        </button>
                        <button id="reorderBlocksBtn" class="editor-action-btn">
                            <i class="fas fa-sort mr-2"></i> Sắp xếp lại
                        </button>
                    </div>
                    
                    <div class="exam-blocks-container" id="examBlocksContainer">
            `;
            
            currentExamBlocks.forEach((block, index) => {
                editorHTML += createBlockEditorHTML(block, index);
            });
            
            editorHTML += `
                    </div>
                    
                    <div class="exam-actions">
                        <button id="previewEditedExamBtn" class="exam-action-btn preview-btn">
                            <i class="fas fa-eye mr-2"></i> Xem trước
                        </button>
                        <button id="saveEditedExamBtn" class="exam-action-btn save-btn">
                            <i class="fas fa-save mr-2"></i> Lưu thay đổi
                        </button>
                    </div>
                </div>
            `;
            
            return editorHTML;
        }

        // Hàm tạo HTML cho một block chỉnh sửa
        function createBlockEditorHTML(block, index) {
            // Xử lý content để hiển thị đúng trong editor
            const contentForEditor = block.content ? block.content.replace(/\n/g, '\\n') : '';
            
            return `
                <div class="exam-block-editor" data-index="${index}" style="margin-bottom: 1.5rem; border: 2px solid var(--card-outline); border-radius: 8px; padding: 1rem;">
                    <div class="block-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <select class="block-type-select" data-index="${index}" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--card-outline);">
                            <option value="text" ${block.type === 'text' ? 'selected' : ''}>Phần văn bản</option>
                            <option value="question" ${block.type === 'question' ? 'selected' : ''}>Câu hỏi</option>
                        </select>
                        
                        <div class="block-actions">
                            <button class="block-btn move-up" data-index="${index}" ${index === 0 ? 'disabled' : ''} style="padding: 0.25rem 0.5rem; margin-left: 0.25rem; border: 1px solid var(--card-outline); border-radius: 4px; background: var(--card-bg); cursor: pointer;">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button class="block-btn move-down" data-index="${index}" ${index === currentExamBlocks.length - 1 ? 'disabled' : ''} style="padding: 0.25rem 0.5rem; margin-left: 0.25rem; border: 1px solid var(--card-outline); border-radius: 4px; background: var(--card-bg); cursor: pointer;">
                                <i class="fas fa-arrow-down"></i>
                            </button>
                            <button class="block-btn delete" data-index="${index}" style="padding: 0.25rem 0.5rem; margin-left: 0.25rem; border: 1px solid #ef4444; border-radius: 4px; background: #fef2f2; color: #ef4444; cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="block-content">
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label class="block-label">Tiêu đề:</label>
                            <input type="text" class="block-title" data-index="${index}" value="${block.title || ''}" placeholder="Nhập tiêu đề..." style="width: 100%; padding: 0.5rem; border: 1px solid var(--card-outline); border-radius: 4px;">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label class="block-label">Nội dung:</label>
                            <div class="rich-text-editor" id="editor-${index}"></div>
                            <textarea style="display: none;" id="editor-text-${index}">${block.content || ''}</textarea>
                        </div>
                        
                        ${block.type === 'question' ? `
                        <div class="block-controls">
                            <div class="form-group">
                                <label class="block-label">Điểm số:</label>
                                <input type="number" class="block-points-input" data-index="${index}" value="${block.points || 1.0}" min="0" max="10" step="0.5" style="width: 100px; padding: 0.5rem; border: 1px solid var(--card-outline); border-radius: 4px;">
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Hàm khởi tạo trình soạn thảo rich text (bảo toàn xuống dòng)
        function initRichTextEditors() {
            richTextEditors = [];
            
            currentExamBlocks.forEach((block, index) => {
                const editorId = `editor-${index}`;
                const textareaId = `editor-text-${index}`;
                
                const quill = new Quill(`#${editorId}`, {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            ['bold', 'italic', 'underline'],
                            [{ 'header': 1 }, { 'header': 2 }],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['clean']
                        ]
                    },
                    placeholder: 'Nhập nội dung...'
                });
                
                // Thiết lập nội dung ban đầu
                const textarea = document.getElementById(textareaId);
                if (textarea) {
                    // Hiển thị với đúng xuống dòng
                    quill.root.innerHTML = textarea.value.replace(/\n/g, '<br>');
                }
                
                // Lưu lại editor
                richTextEditors[index] = {
                    quill: quill,
                    textareaId: textareaId
                };
                
                // Cập nhật textarea khi nội dung thay đổi
                quill.on('text-change', function() {
                    if (textarea) {
                        // Lấy HTML và chuyển <br> thành \n
                        const html = quill.root.innerHTML;
                        const textWithNewlines = html.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]*>/g, '');
                        textarea.value = textWithNewlines;
                    }
                });
            });
        }

        // Hàm cập nhật đề thi từ editor
        function updateExamFromEditor() {
            const blocksContainer = document.getElementById('examBlocksContainer');
            if (!blocksContainer) return;
            
            const blockElements = blocksContainer.querySelectorAll('.exam-block-editor');
            const updatedBlocks = [];
            
            blockElements.forEach((blockElement, blockIndex) => {
                const dataIndex = parseInt(blockElement.dataset.index);
                const typeSelect = blockElement.querySelector('.block-type-select');
                const titleInput = blockElement.querySelector('.block-title');
                const pointsInput = blockElement.querySelector('.block-points-input');
                
                // Lấy nội dung từ trình soạn thảo
                let content = '';
                if (richTextEditors[dataIndex]) {
                    const quill = richTextEditors[dataIndex].quill;
                    const html = quill.root.innerHTML;
                    // Chuyển <br> thành \n để lưu đúng định dạng
                    content = html.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]*>/g, '');
                } else {
                    const textarea = document.getElementById(`editor-text-${dataIndex}`);
                    content = textarea ? textarea.value : '';
                }
                
                const blockData = {
                    type: typeSelect.value,
                    title: titleInput.value,
                    content: content,
                    points: typeSelect.value === 'question' ? parseFloat(pointsInput?.value || 1.0) : 0
                };
                
                updatedBlocks.push(blockData);
            });
            
            currentExamBlocks = updatedBlocks;
        }

        // Hàm sắp xếp lại blocks
        function reorderBlocks() {
            showNotification('Kéo và thả các block để sắp xếp lại', 'info');
            
            updateExamFromEditor();
            
            const modal = document.getElementById('editExamModal');
            modal.classList.remove('active');
            
            setTimeout(() => {
                openExamEditor();
            }, 300);
        }

        // Hàm thêm block mới
        function addBlock(type) {
            const newBlock = {
                type: type,
                title: type === 'text' ? 'Phần mới' : 'Câu hỏi mới',
                content: '',
                points: type === 'question' ? 1.0 : 0
            };
            
            currentExamBlocks.push(newBlock);
            
            // Cập nhật giao diện editor
            const blocksContainer = document.getElementById('examBlocksContainer');
            blocksContainer.insertAdjacentHTML('beforeend', createBlockEditorHTML(newBlock, currentExamBlocks.length - 1));
            
            // Khởi tạo lại trình soạn thảo
            initRichTextEditors();
        }

        // Hàm xóa block
        function deleteBlock(index) {
            if (currentExamBlocks.length <= 1) {
                showNotification('Đề thi phải có ít nhất một phần!', 'error');
                return;
            }
            
            currentExamBlocks.splice(index, 1);
            
            // Cập nhật giao diện
            const editorContainer = document.getElementById('examEditorContainer');
            editorContainer.innerHTML = createExamEditorHTML();
            
            // Khởi tạo lại trình soạn thảo
            setTimeout(() => {
                initRichTextEditors();
            }, 100);
        }

        // Hàm di chuyển block
        function moveBlock(index, direction) {
            if (direction === 'up' && index > 0) {
                [currentExamBlocks[index], currentExamBlocks[index - 1]] = [currentExamBlocks[index - 1], currentExamBlocks[index]];
            } else if (direction === 'down' && index < currentExamBlocks.length - 1) {
                [currentExamBlocks[index], currentExamBlocks[index + 1]] = [currentExamBlocks[index + 1], currentExamBlocks[index]];
            }
            
            // Cập nhật giao diện
            const editorContainer = document.getElementById('examEditorContainer');
            editorContainer.innerHTML = createExamEditorHTML();
            
            // Khởi tạo lại trình soạn thảo
            setTimeout(() => {
                initRichTextEditors();
            }, 100);
        }

        // Hàm lưu đề thi đã chỉnh sửa
        function saveEditedExam() {
            updateExamFromEditor();
            
            // Đóng modal
            const modal = document.getElementById('editExamModal');
            modal.classList.remove('active');
            
            // Cập nhật giao diện xem trước
            const examData = {
                title: "Đề thi Ngữ Văn",
                description: "Đề thi đã được chỉnh sửa",
                author: currentExamBlocks[0]?.author || "Không xác định",
                blocks: currentExamBlocks
            };
            
            const examNotes = document.getElementById('examNotes').value;
            showExamResult(examData, examNotes);
            
            showNotification('Đã lưu thay đổi đề thi!', 'success');
        }

        // Hàm cập nhật preview
        function updateExamPreview() {
            updateExamFromEditor();
            
            let previewHTML = `
                <div class="preview-exam">
                    <h1 class="exam-title">ĐỀ THI NGỮ VĂN</h1>
                    <div class="exam-info">
                        <p><strong>Thời gian làm bài:</strong> ${examSettings.time} phút | <strong>Mã đề:</strong> ${currentExamCode}</p>
                        <p><strong>Khối lớp:</strong> ${examSettings.grade} | <strong>Độ khó:</strong> ${examSettings.difficulty === 'easy' ? 'Dễ' : examSettings.difficulty === 'medium' ? 'Trung bình' : 'Khó'}</p>
                    </div>
            `;
            
            let questionCounter = 1;
            let totalPoints = 0;
            
            currentExamBlocks.forEach((block, index) => {
                if (block.type === 'text') {
                    previewHTML += `
                        <div class="exam-section">
                            <h3 class="section-title">${block.title || 'Phần văn bản'}</h3>
                            <div class="text-content" style="white-space: pre-line; font-family: 'Times New Roman', serif;">${block.content}</div>
                        </div>
                    `;
                } else if (block.type === 'question') {
                    totalPoints += block.points || 0;
                    previewHTML += `
                        <div class="question-item">
                            <div class="question-header">
                                <div class="question-text" style="white-space: pre-line;"><strong>Câu ${questionCounter}:</strong> ${block.content}</div>
                                <div class="question-points">${block.points || 1.0} điểm</div>
                            </div>
                            <div class="answer-area">
                                <textarea class="answer-textarea" placeholder="Thí sinh viết câu trả lời vào đây..." rows="4"></textarea>
                            </div>
                        </div>
                    `;
                    questionCounter++;
                }
            });
            
            previewHTML += `
                <div class="exam-info" style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid var(--card-outline);">
                    <p><strong>Tổng điểm: ${totalPoints.toFixed(1)} điểm</strong></p>
                    <p><em>--- Hết đề thi ---</em></p>
                </div>
            `;
            
            previewHTML += `</div>`;
            document.getElementById('previewContent').innerHTML = previewHTML;
            
            const modal = document.getElementById('previewModal');
            modal.classList.add('active');
        }

        // Hàm lưu đề thi
        function saveExam() {
            const editModal = document.getElementById('editExamModal');
            if (editModal && editModal.classList.contains('active')) {
                updateExamFromEditor();
            }
            
            const examData = {
                code: currentExamCode,
                title: "Đề thi Ngữ Văn",
                time: examSettings.time,
                difficulty: examSettings.difficulty,
                grade: examSettings.grade,
                blocks: currentExamBlocks,
                createdAt: new Date().toISOString(),
                totalPoints: currentExamBlocks.reduce((sum, block) => sum + (block.points || 0), 0)
            };
            
            const savedExams = JSON.parse(localStorage.getItem('vanw_exams') || '[]');
            savedExams.push(examData);
            localStorage.setItem('vanw_exams', JSON.stringify(savedExams));
            
            showNotification(`Đã lưu đề thi thành công! Mã đề: ${currentExamCode}`, 'success');
        }

        // Hàm in đề thi
        function printExam() {
            updateExamFromEditor();
            
            let printHTML = `
                <div class="preview-exam">
                    <h1 class="exam-title">ĐỀ THI NGỮ VĂN</h1>
                    <div class="exam-info">
                        <p><strong>Thời gian làm bài:</strong> ${examSettings.time} phút | <strong>Mã đề:</strong> ${currentExamCode}</p>
                        <p><strong>Khối lớp:</strong> ${examSettings.grade} | <strong>Độ khó:</strong> ${examSettings.difficulty === 'easy' ? 'Dễ' : examSettings.difficulty === 'medium' ? 'Trung bình' : 'Khó'}</p>
                    </div>
            `;
            
            let questionCounter = 1;
            let totalPoints = 0;
            
            currentExamBlocks.forEach((block, index) => {
                if (block.type === 'text') {
                    printHTML += `
                        <div class="exam-section">
                            <h3 class="section-title">${block.title || 'Phần văn bản'}</h3>
                            <div class="text-content" style="white-space: pre-line; font-family: 'Times New Roman', serif;">${block.content}</div>
                        </div>
                    `;
                } else if (block.type === 'question') {
                    totalPoints += block.points || 0;
                    printHTML += `
                        <div class="question-item">
                            <div class="question-header">
                                <div class="question-text" style="white-space: pre-line;"><strong>Câu ${questionCounter}:</strong> ${block.content}</div>
                                <div class="question-points">${block.points || 1.0} điểm</div>
                            </div>
                            <div class="answer-area">
                                <div class="answer-space" style="min-height: 100px; border: 1px dashed #ccc; margin-top: 10px;"></div>
                            </div>
                        </div>
                    `;
                    questionCounter++;
                }
            });
            
            printHTML += `
                <div class="exam-info" style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid var(--card-outline);">
                    <p><strong>Tổng điểm: ${totalPoints.toFixed(1)} điểm</strong></p>
                    <p><em>--- Hết đề thi ---</em></p>
                </div>
            `;
            
            printHTML += `</div>`;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Đề thi ${currentExamCode} - VANW</title>
                    <style>
                        body { 
                            font-family: 'Times New Roman', serif; 
                            padding: 20px; 
                            line-height: 1.6;
                            color: #333;
                            max-width: 210mm;
                            margin: 0 auto;
                        }
                        .exam-title { 
                            text-align: center; 
                            color: #e37c2d;
                            font-size: 24px;
                            margin-bottom: 10px;
                            border-bottom: 3px solid #e37c2d;
                            padding-bottom: 10px;
                        }
                        .exam-info { 
                            text-align: center; 
                            color: #666;
                            margin-bottom: 30px;
                            font-size: 14px;
                        }
                        .section-title {
                            color: #e37c2d;
                            font-size: 18px;
                            margin: 25px 0 15px;
                            padding-bottom: 5px;
                            border-bottom: 2px solid rgba(227, 124, 45, 0.3);
                        }
                        .text-content {
                            background: #f9f9f9;
                            padding: 15px;
                            border-radius: 8px;
                            margin-bottom: 20px;
                            border-left: 4px solid #e37c2d;
                            white-space: pre-line;
                            line-height: 1.8;
                            font-family: 'Times New Roman', serif;
                        }
                        .question-item {
                            margin-bottom: 20px;
                            padding: 15px;
                            border: 1px solid #ddd;
                            border-radius: 8px;
                        }
                        .question-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                            margin-bottom: 10px;
                        }
                        .question-text {
                            flex: 1;
                            font-weight: 500;
                            white-space: pre-line;
                        }
                        .question-points {
                            background: #e37c2d;
                            color: white;
                            padding: 2px 10px;
                            border-radius: 15px;
                            font-size: 12px;
                            font-weight: bold;
                        }
                        .answer-space {
                            min-height: 100px;
                            border: 1px dashed #ccc;
                            padding: 10px;
                            border-radius: 5px;
                            margin-top: 10px;
                        }
                        @media print {
                            body { font-size: 12pt; }
                            .no-print { display: none; }
                            .exam-title { font-size: 20pt; }
                            .text-content { white-space: pre-line !important; }
                        }
                    </style>
                </head>
                <body>
                    ${printHTML}
                    <div class="exam-info no-print" style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; font-size: 12px; color: #888;">
                        <p>Được tạo bởi Hệ thống Tạo Bài Thi Văn Học VANW</p>
                        <p>Ngày in: ${new Date().toLocaleDateString('vi-VN')}</p>
                    </div>
                    <script>
                        window.onload = function() { 
                            setTimeout(() => { window.print(); }, 500);
                        }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // ==================== KHỞI TẠO KHI TRANG TẢI ====================

        // Hàm hiển thị thông báo
        function showNotification(message, type = 'info') {
            const oldNotification = document.querySelector('.notification');
            if (oldNotification) {
                oldNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';
            if (type === 'warning') icon = 'exclamation-triangle';
            
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${icon}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            notification.style.cssText = `
                position: fixed;
                top: 30px;
                right: 30px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#2196F3'};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 6px 20px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55), fadeOut 0.4s ease 3.6s;
                animation-fill-mode: forwards;
                max-width: 400px;
                border: 2px solid rgba(255,255,255,0.3);
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 4000);
        }

        // Hàm chuyển đổi mode
        function switchMode(mode) {
            currentMode = mode;
            
            const modeBtns = document.querySelectorAll('.mode-btn');
            const existingTextArea = document.getElementById('existingTextArea');
            const textGenArea = document.getElementById('textGenArea');
            
            // Cập nhật active class
            modeBtns.forEach(btn => {
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Hiển thị/ẩn các khu vực tương ứng
            if (mode === 'from-text') {
                existingTextArea.style.display = 'block';
                textGenArea.style.display = 'none';
            } else if (mode === 'generate-text') {
                existingTextArea.style.display = 'none';
                textGenArea.style.display = 'block';
            }
        }

        // Hàm xử lý slider thời gian
        function setupExamSlider() {
            const slider = document.getElementById('examTimeSlider');
            const valueDisplay = document.getElementById('examTimeValue');
            
            if (!slider || !valueDisplay) return;
            
            valueDisplay.textContent = formatDuration(slider.value);
            updateExamSliderColor(slider.value);
            
            slider.addEventListener('input', function() {
                valueDisplay.textContent = formatDuration(this.value);
                updateExamSliderColor(this.value);
                
                const durationBtns = document.querySelectorAll('.duration-btn');
                durationBtns.forEach(btn => {
                    if (parseInt(btn.dataset.value) === parseInt(this.value)) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            });
            
            const durationBtns = document.querySelectorAll('.duration-btn');
            durationBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const value = parseInt(this.dataset.value);
                    slider.value = value;
                    valueDisplay.textContent = formatDuration(value);
                    updateExamSliderColor(value);
                    
                    durationBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        // Hàm cập nhật màu slider đề thi
        function updateExamSliderColor(value) {
            const slider = document.getElementById('examTimeSlider');
            const percent = ((value - slider.min) / (slider.max - slider.min)) * 100;
            slider.style.background = `linear-gradient(to right, var(--primary-color) 0%, var(--primary-color) ${percent}%, var(--border-color) ${percent}%, var(--border-color) 100%)`;
        }

        // Hàm đếm từ
        function setupWordCounter() {
            const textarea = document.getElementById('inputText');
            const wordCount = document.getElementById('wordCount');
            
            if (!textarea || !wordCount) return;
            
            textarea.addEventListener('input', function() {
                const count = countWords(this.value);
                wordCount.textContent = `${count} từ`;
                
                if (count < 100) {
                    wordCount.style.color = '#ef4444';
                    wordCount.style.fontWeight = '600';
                } else {
                    wordCount.style.color = 'var(--text-secondary)';
                    wordCount.style.fontWeight = 'normal';
                }
            });
        }

        // Hàm xử lý modal
        function setupModal() {
            const previewModal = document.getElementById('previewModal');
            const editModal = document.getElementById('editExamModal');
            const textPreviewModal = document.getElementById('textPreviewModal');
            const closeButtons = document.querySelectorAll('.close-modal');
            const closePreviewBtn = document.getElementById('closePreviewBtn');
            const printPreviewBtn = document.getElementById('printPreviewBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const saveEditedExamBtn = document.getElementById('saveEditedExamBtn');
            const closeTextPreviewBtn = document.getElementById('closeTextPreviewBtn');
            const useTextBtn = document.getElementById('useTextBtn');
            
            // Đóng modal
            closeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        modal.classList.remove('active');
                    }
                });
            });
            
            if (closePreviewBtn) {
                closePreviewBtn.addEventListener('click', function() {
                    previewModal.classList.remove('active');
                });
            }
            
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', function() {
                    editModal.classList.remove('active');
                });
            }
            
            if (saveEditedExamBtn) {
                saveEditedExamBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    saveEditedExam();
                });
            }
            
            if (closeTextPreviewBtn) {
                closeTextPreviewBtn.addEventListener('click', function() {
                    textPreviewModal.classList.remove('active');
                });
            }
            
            if (useTextBtn) {
                useTextBtn.addEventListener('click', function() {
                    useGeneratedText();
                });
            }
            
            if (printPreviewBtn) {
                printPreviewBtn.addEventListener('click', function() {
                    const printContent = document.getElementById('previewContent').innerHTML;
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>Đề thi ${currentExamCode} - VANW</title>
                            <style>
                                body { 
                                    font-family: 'Times New Roman', serif; 
                                    padding: 20px; 
                                    line-height: 1.6;
                                    color: #333;
                                    max-width: 210mm;
                                    margin: 0 auto;
                                }
                                .exam-title { 
                                    text-align: center; 
                                    color: #e37c2d;
                                    font-size: 24px;
                                    margin-bottom: 10px;
                                    border-bottom: 3px solid #e37c2d;
                                    padding-bottom: 10px;
                                }
                                .exam-info { 
                                    text-align: center; 
                                    color: #666;
                                    margin-bottom: 30px;
                                    font-size: 14px;
                                }
                                .section-title {
                                    color: #e37c2d;
                                    font-size: 18px;
                                    margin: 25px 0 15px;
                                    padding-bottom: 5px;
                                    border-bottom: 2px solid rgba(227, 124, 45, 0.3);
                                }
                                .text-content {
                                    background: #f9f9f9;
                                    padding: 15px;
                                    border-radius: 8px;
                                    margin-bottom: 20px;
                                    border-left: 4px solid #e37c2d;
                                    white-space: pre-line;
                                    line-height: 1.8;
                                }
                                .question-item {
                                    margin-bottom: 20px;
                                    padding: 15px;
                                    border: 1px solid #ddd;
                                    border-radius: 8px;
                                }
                                .question-header {
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: flex-start;
                                    margin-bottom: 10px;
                                }
                                .question-text {
                                    flex: 1;
                                    font-weight: 500;
                                    white-space: pre-line;
                                }
                                .question-points {
                                    background: #e37c2d;
                                    color: white;
                                    padding: 2px 10px;
                                    border-radius: 15px;
                                    font-size: 12px;
                                    font-weight: bold;
                                }
                                .answer-textarea {
                                    width: 100%;
                                    min-height: 100px;
                                    border: 1px dashed #ccc;
                                    padding: 10px;
                                    border-radius: 5px;
                                    margin-top: 10px;
                                    font-family: inherit;
                                }
                                @media print {
                                    body { font-size: 12pt; }
                                    .no-print { display: none; }
                                    .exam-title { font-size: 20pt; }
                                    .text-content { white-space: pre-line !important; }
                                }
                            </style>
                        </head>
                        <body>
                            ${printContent}
                            <div class="exam-info no-print" style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; font-size: 12px; color: #888;">
                                <p>Được tạo bởi Hệ thống Tạo Bài Thi Văn Học VANW</p>
                                <p>Ngày in: ${new Date().toLocaleDateString('vi-VN')}</p>
                            </div>
                            <script>
                                window.onload = function() { 
                                    setTimeout(() => { window.print(); }, 500);
                                }
                            <\/script>
                        </body>
                        </html>
                    `);
                    printWindow.document.close();
                });
            }
            
            // Đóng modal khi click bên ngoài
            [previewModal, editModal, textPreviewModal].forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
            
            // Xử lý sự kiện trong modal chỉnh sửa
            document.addEventListener('click', function(e) {
                // Thêm block văn bản
                if (e.target && e.target.id === 'addTextBlockBtn') {
                    e.preventDefault();
                    addBlock('text');
                }
                
                // Thêm block câu hỏi
                if (e.target && e.target.id === 'addQuestionBlockBtn') {
                    e.preventDefault();
                    addBlock('question');
                }
                
                // Sắp xếp lại blocks
                if (e.target && e.target.id === 'reorderBlocksBtn') {
                    e.preventDefault();
                    reorderBlocks();
                }
                
                // Xem trước đề thi đã chỉnh sửa
                if (e.target && e.target.id === 'previewEditedExamBtn') {
                    e.preventDefault();
                    updateExamFromEditor();
                    updateExamPreview();
                    editModal.classList.remove('active');
                }
                
                // Xóa block
                if (e.target && e.target.closest('.block-btn.delete')) {
                    e.preventDefault();
                    const btn = e.target.closest('.block-btn.delete');
                    const index = parseInt(btn.dataset.index);
                    deleteBlock(index);
                }
                
                // Di chuyển block lên
                if (e.target && e.target.closest('.block-btn.move-up')) {
                    e.preventDefault();
                    const btn = e.target.closest('.block-btn.move-up');
                    const index = parseInt(btn.dataset.index);
                    moveBlock(index, 'up');
                }
                
                // Di chuyển block xuống
                if (e.target && e.target.closest('.block-btn.move-down')) {
                    e.preventDefault();
                    const btn = e.target.closest('.block-btn.move-down');
                    const index = parseInt(btn.dataset.index);
                    moveBlock(index, 'down');
                }
            });
        }

        // Hàm xử lý slider độ dài văn bản
        function setupTextLengthSlider() {
            const slider = document.getElementById('textLength');
            const label = document.getElementById('lengthLabel');
            
            if (!slider || !label) return;
            
            const lengthMap = {
                1: 'Rất ngắn (~100 từ)',
                2: 'Ngắn (~200 từ)',
                3: 'Trung bình (~400 từ)',
                4: 'Dài (~600 từ)',
                5: 'Rất dài (~800 từ)'
            };
            
            label.textContent = lengthMap[slider.value] || 'Trung bình (~400 từ)';
            
            slider.addEventListener('input', function() {
                label.textContent = lengthMap[this.value] || 'Trung bình (~400 từ)';
            });
        }

        // Hàm xử lý tác giả tuỳ chỉnh
        function setupCustomAuthor() {
            const authorSelect = document.getElementById('authorStyle');
            const customAuthorGroup = document.getElementById('customAuthorGroup');
            
            if (!authorSelect || !customAuthorGroup) return;
            
            authorSelect.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customAuthorGroup.style.display = 'block';
                } else {
                    customAuthorGroup.style.display = 'none';
                }
            });
        }

        // Khởi tạo khi trang được tải
        document.addEventListener('DOMContentLoaded', function() {
            // Gán sự kiện cho nút tạo đề thi
            const generateExamBtn = document.getElementById('generateExamBtn');
            if (generateExamBtn) {
                generateExamBtn.addEventListener('click', generateExam);
            }
            
            // Gán sự kiện cho nút tạo văn bản mẫu
            const generateTextBtn = document.getElementById('generateTextBtn');
            if (generateTextBtn) {
                generateTextBtn.addEventListener('click', async function() {
                    const btn = this;
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang tạo văn bản...';
                    
                    // Reset tiến trình
                    generationProgress = {
                        total: 0,
                        completed: 0,
                        items: []
                    };
                    
                    const progressContainer = document.getElementById('progressContainer');
                    progressContainer.style.display = 'block';
                    
                    try {
                        const text = await generateTextSample();
                        showGeneratedText(text);
                    } catch (error) {
                        console.error('Lỗi khi tạo văn bản mẫu:', error);
                        showNotification('Đã xảy ra lỗi khi tạo văn bản mẫu!', 'error');
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-wand-magic-sparkles mr-2"></i> Tạo văn bản mẫu';
                        progressContainer.style.display = 'none';
                    }
                });
            }
            
            // Gán sự kiện cho phím Enter trong textarea (Ctrl+Enter)
            const inputText = document.getElementById('inputText');
            if (inputText) {
                inputText.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        e.preventDefault();
                        if (currentMode === 'from-text') {
                            generateExam();
                        }
                    }
                });
            }
            
            // Settings Panel Toggle
            const settingsBtn = document.getElementById('settingsBtn');
            if (settingsBtn) {
                settingsBtn.addEventListener('click', function() {
                    const settingsPanel = document.getElementById('settingsPanel');
                    if (settingsPanel) {
                        settingsPanel.classList.toggle('active');
                        
                        const icon = this.querySelector('i');
                        if (settingsPanel.classList.contains('active')) {
                            icon.className = 'fas fa-times';
                            this.style.backgroundColor = 'rgba(227, 124, 45, 0.2)';
                            this.style.borderColor = 'var(--primary-color)';
                        } else {
                            icon.className = 'fas fa-cog';
                            this.style.backgroundColor = '';
                            this.style.borderColor = '';
                        }
                    }
                });
            }
            
            // Mode selection buttons
            const modeBtns = document.querySelectorAll('.mode-btn');
            modeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const mode = this.dataset.mode;
                    switchMode(mode);
                });
            });
            
            // Khởi tạo các thành phần
            setupExamSlider();
            setupWordCounter();
            setupModal();
            setupTextLengthSlider();
            setupCustomAuthor();
            
            // Thêm animation cho notification
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(100%) translateY(-20px);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0) translateY(0);
                        opacity: 1;
                    }
                }
                
                @keyframes fadeOut {
                    from {
                        opacity: 1;
                    }
                    to {
                        opacity: 0;
                        transform: translateX(100%) translateY(-20px);
                    }
                }
                
                .notification-content {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                }
                
                .notification-content i {
                    font-size: 1.3rem;
                }
                
                .notification-content span {
                    font-size: 1rem;
                    font-weight: 500;
                }
            `;
            document.head.appendChild(style);
            
            // Focus vào textarea
            document.getElementById('inputText')?.focus();
            
            // Hiển thị thông báo nếu Firebase đã được khởi tạo
            if (firestoreDbPrimary && firestoreDbSecondary) {
                console.log('Cả hai Firebase Databases đã sẵn sàng để lưu đề thi');
            }
        });
    </script>
</body>
</html>
